<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Freunde Kalender Offenbach</title>
<style>
/* Grundlayout */
body, html {
  margin: 0; padding: 0; height: 100%;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: url('https://upload.wikimedia.org/wikipedia/commons/4/44/Offenbach_am_Main_-_Rathaus_und_Mainufer_01.jpg') no-repeat center center fixed;
  background-size: cover;
  color: #fff;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}
main {
  flex-grow: 1;
  background: rgba(0,0,0,0.6);
  padding: 20px;
  overflow-y: auto;
}
h1, h2, h3 {
  margin: 0 0 10px 0;
  text-align: center;
}
button {
  cursor: pointer;
  border: none;
  border-radius: 5px;
  padding: 8px 15px;
  margin: 5px;
  background-color: #4CAF50;
  color: white;
  font-weight: 600;
  transition: background-color 0.3s ease;
}
button:hover {
  background-color: #45a049;
}
input, select {
  padding: 8px;
  margin: 5px 0 15px 0;
  border-radius: 5px;
  border: none;
  width: 100%;
  box-sizing: border-box;
}
label {
  font-weight: 600;
  display: block;
  margin-bottom: 5px;
}
#error-msg {
  color: #ff6b6b;
  text-align: center;
  margin-bottom: 10px;
}
#success-msg {
  color: #90ee90;
  text-align: center;
  margin-bottom: 10px;
}

/* Navigation */
nav {
  background: rgba(0,0,0,0.7);
  padding: 10px 20px;
  text-align: center;
}
nav button {
  margin: 0 10px;
}

/* Kalender Styles */
.calendar-container {
  max-width: 900px;
  margin: 0 auto;
}
.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
.calendar-header h2 {
  margin: 0;
}
.month-nav button {
  font-size: 18px;
  padding: 5px 10px;
}
table.calendar {
  border-collapse: collapse;
  width: 100%;
  background: rgba(255,255,255,0.1);
  border-radius: 8px;
}
table.calendar th, table.calendar td {
  width: 14.2857%;
  padding: 10px;
  text-align: center;
  vertical-align: middle;
  cursor: pointer;
  border: 1px solid rgba(255,255,255,0.2);
}
table.calendar th {
  background: rgba(255,255,255,0.2);
  font-weight: 700;
}
table.calendar td.inactive {
  color: #aaa;
  cursor: default;
  background: transparent;
}
table.calendar td.booked {
  background-color: #d9534f; /* rot für belegt */
  color: white;
}
table.calendar td.blocked {
  background-color: #6c757d; /* grau für blockiert */
  color: white;
}
table.calendar td.selected-start {
  border: 3px solid #4caf50;
}
table.calendar td.selected-end {
  border: 3px solid #4caf50;
}
table.calendar td.selected-range {
  background-color: #81c784;
  color: black;
}

/* Sonntag ganz rechts */
table.calendar th:last-child, table.calendar td:last-child {
  text-align: right;
}

/* Formular Styles */
form {
  max-width: 500px;
  margin: 0 auto 30px auto;
  background: rgba(255,255,255,0.1);
  padding: 15px 20px;
  border-radius: 8px;
}
.form-row {
  margin-bottom: 10px;
}
.optional-label {
  font-size: 0.9em;
  color: #ccc;
}

/* Login Box */
#login-box {
  max-width: 400px;
  margin: 40px auto;
  background: rgba(255,255,255,0.15);
  padding: 30px;
  border-radius: 15px;
  backdrop-filter: blur(8px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.3);
}
#login-box h2 {
  color: white;
  margin-bottom: 15px;
}

/* Admin Bereich */
#admin-area {
  max-width: 900px;
  margin: 0 auto;
}
#admin-bookings-list {
  max-height: 300px;
  overflow-y: auto;
  background: rgba(255,255,255,0.1);
  padding: 10px;
  border-radius: 8px;
}
#admin-bookings-list table {
  width: 100%;
  border-collapse: collapse;
  color: white;
}
#admin-bookings-list th, #admin-bookings-list td {
  padding: 8px;
  border: 1px solid rgba(255,255,255,0.3);
  text-align: center;
}
#admin-bookings-list th {
  background: rgba(255,255,255,0.2);
}

/* Scrollbar klein & dezent */
#admin-bookings-list::-webkit-scrollbar {
  width: 8px;
}
#admin-bookings-list::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.3);
  border-radius: 4px;
}

/* Responsive */
@media (max-width: 600px) {
  table.calendar th, table.calendar td {
    padding: 5px;
    font-size: 12px;
  }
  form {
    width: 90%;
  }
}
</style>
</head>
<body>
<nav>
  <button id="btn-to-start" style="display:none;">Zur Startseite</button>
  <button id="btn-show-friend-login">Freunde Login</button>
  <button id="btn-show-admin-login">Admin Login</button>
</nav>

<main>
  <section id="start-page">
    <h1>Willkommen im Freunde Kalender Offenbach</h1>
    <p style="text-align:center; max-width:600px; margin:auto;">
      Hier kannst du als Freund deine Übernachtung buchen.<br />
      Oder als Admin den Kalender verwalten.
    </p>
  </section>

  <section id="friend-login" style="display:none;">
    <div id="login-box">
      <h2>Freunde Login</h2>
      <p>Bitte Passwort eingeben:</p>
      <input type="password" id="friend-password" placeholder="Passwort" />
      <div id="error-msg"></div>
      <button id="friend-login-btn">Einloggen</button>
      <button id="btn-back-from-friend-login">Zurück</button>
    </div>
  </section>

  <section id="friend-area" style="display:none;">
    <h2>Übernachtung buchen</h2>

    <div class="calendar-container">
      <div class="calendar-header">
        <div class="month-nav">
          <button id="prev-month">&lt;</button>
          <span id="month-year"></span>
          <button id="next-month">&gt;</button>
        </div>
        <button id="switch-calendar-view">Zum Jahreskalender</button>
      </div>
      <table class="calendar" id="calendar"></table>
    </div>

    <form id="booking-form" style="display:none;">
      <h3>Buchungsdetails</h3>

      <div class="form-row">
        <label for="book-name">Name *</label>
        <input type="text" id="book-name" required />
      </div>
      <div class="form-row">
        <label for="book-persons">Anzahl Personen *</label>
        <input type="number" id="book-persons" min="1" value="1" required />
      </div>
      <div class="form-row">
        <label for="book-breakfast">Frühstück benötigt? *</label>
        <select id="book-breakfast" required>
          <option value="ja">Ja</option>
          <option value="nein" selected>Nein</option>
        </select>
      </div>
      <div class="form-row">
        <label for="book-arrival-time">Anreise Uhrzeit <span class="optional-label">(optional)</span></label>
        <input type="time" id="book-arrival-time" />
      </div>
      <div class="form-row">
        <label for="book-departure-time">Abreise Uhrzeit <span class="optional-label">(optional)</span></label>
        <input type="time" id="book-departure-time" />
      </div>

      <div class="form-row">
        <label for="book-start-date">Startdatum *</label>
        <input type="date" id="book-start-date" required />
      </div>
      <div class="form-row">
        <label for="book-end-date">Enddatum *</label>
        <input type="date" id="book-end-date" required />
      </div>

      <div id="booking-error" style="color:#ff6b6b; font-weight:bold; margin-bottom:10px;"></div>
      <button type="submit">Buchung abschicken</button>
      <button type="button" id="btn-cancel-booking-form">Abbrechen</button>
    </form>
  </section>

  <section id="yearly-calendar" style="display:none; max-width: 900px; margin: 0 auto;">
    <h2>Jahreskalender (Belegte Tage)</h2>
    <div style="text-align:center;">
      <button id="year-prev">&lt; Vorjahr</button>
      <span id="year-display" style="font-weight: 700; margin: 0 15px;"></span>
      <button id="year-next">Nächstes Jahr &gt;</button>
      <button id="year-to-month-view" style="margin-left:20px;">Zum Monatskalender</button>
    </div>
    <div id="yearly-calendar-content" style="margin-top:20px;"></div>
  </section>

  <section id="admin-login" style="display:none;">
    <div id="login-box">
      <h2>Admin Login</h2>
      <p>Bitte Admin-Passwort eingeben:</p>
      <input type="password" id="admin-password" placeholder="Admin Passwort" />
      <div id="error-msg"></div>
      <button id="admin-login-btn">Einloggen</button>
      <button id="btn-back-from-admin-login">Zurück</button>
    </div>
  </section>

  <section id="admin-area" style="display:none;">
    <h2>Admin Bereich</h2>

    <div>
      <button id="btn-logout-admin" style="background:#d9534f;">Admin Logout</button>
      <button id="btn-export-csv">Exportiere Buchungen (CSV)</button>
    </div>

    <h3>Belegte und Blockierte Tage</h3>
    <div id="admin-bookings-list"></div>

    <h3>Tage blockieren/freigeben</h3>
    <form id="block-days-form">
      <div class="form-row">
        <label for="block-start-date">Startdatum *</label>
        <input type="date" id="block-start-date" required />
      </div>
      <div class="form-row">
        <label for="block-end-date">Enddatum *</label>
        <input type="date" id="block-end-date" required />
      </div>
      <div id="block-error" style="color:#ff6b6b; font-weight:bold; margin-bottom:10px;"></div>
      <button type="submit">Tage blockieren</button>
      <button type="button" id="btn-unblock-days">Tage freigeben</button>
    </form>
  </section>
</main>

<script>
(() => {
  // Passwörter
  const FRIEND_PASSWORD = "OffenbachPaul123";
  const ADMIN_PASSWORD = "test123";

  // Kalender Start & Ende
  const CAL_START_YEAR = 2025;
  const CAL_START_MONTH = 8; // September (0-basierend)
  const CAL_END_YEAR = 2040;
  const CAL_END_MONTH = 11; // Dezember

  // State
  let currentYear = CAL_START_YEAR;
  let currentMonth = CAL_START_MONTH; // 0-basierend
  let isYearlyView = false;

  // Buchungen und Blockierungen werden in localStorage gespeichert
  // Format Buchung: {id, name, persons, breakfast, arrivalTime, departureTime, startDate (YYYY-MM-DD), endDate (YYYY-MM-DD)}
  // Blockierungen: Array von {startDate, endDate}

  const STORAGE_BOOKINGS = "offenbach_bookings";
  const STORAGE_BLOCKS = "offenbach_blocks";

  // Utility
  function saveBookings(bookings) {
    localStorage.setItem(STORAGE_BOOKINGS, JSON.stringify(bookings));
  }
  function loadBookings() {
    const data = localStorage.getItem(STORAGE_BOOKINGS);
    return data ? JSON.parse(data) : [];
  }
  function saveBlocks(blocks) {
    localStorage.setItem(STORAGE_BLOCKS, JSON.stringify(blocks));
  }
  function loadBlocks() {
    const data = localStorage.getItem(STORAGE_BLOCKS);
    return data ? JSON.parse(data) : [];
  }
  function formatDate(d) {
    return d.toISOString().slice(0,10);
  }
  function parseDate(str) {
    return new Date(str + "T00:00:00");
  }
  function datesBetween(start, end) {
    const arr = [];
    let d = new Date(start);
    while(d <= end) {
      arr.push(formatDate(d));
      d.setDate(d.getDate()+1);
    }
    return arr;
  }
  function isDateInRange(dateStr, startStr, endStr) {
    return dateStr >= startStr && dateStr <= endStr;
  }
  function checkOverlap(startA, endA, startB, endB) {
    return !(endA < startB || startA > endB);
  }

  // -------------------
  // Navigation & Sections
  // -------------------
  const sections = {
    start: document.getElementById("start-page"),
    friendLogin: document.getElementById("friend-login"),
    friendArea: document.getElementById("friend-area"),
    yearlyCalendar: document.getElementById("yearly-calendar"),
    adminLogin: document.getElementById("admin-login"),
    adminArea: document.getElementById("admin-area"),
  };

  function showSection(name) {
    Object.values(sections).forEach(sec => sec.style.display = "none");
    sections[name].style.display = "block";

    // Navigation "Zur Startseite" Button
    const btnToStart = document.getElementById("btn-to-start");
    if(name !== "start") {
      btnToStart.style.display = "inline-block";
    } else {
      btnToStart.style.display = "none";
    }
  }

  // Navigation Buttons
  document.getElementById("btn-show-friend-login").onclick = () => {
    clearError();
    document.getElementById("friend-password").value = "";
    showSection("friendLogin");
  };
  document.getElementById("btn-show-admin-login").onclick = () => {
    clearError();
    document.getElementById("admin-password").value = "";
    showSection("adminLogin");
  };
  document.getElementById("btn-to-start").onclick = () => {
    showSection("start");
  };
  document.getElementById("btn-back-from-friend-login").onclick = () => {
    showSection("start");
  };
  document.getElementById("btn-back-from-admin-login").onclick = () => {
    showSection("start");
  };

  // Error message helpers
  function showError(msg) {
    const e1 = document.getElementById("error-msg");
    if(e1) {
      e1.textContent = msg;
    }
  }
  function clearError() {
    const e1 = document.getElementById("error-msg");
    if(e1) {
      e1.textContent = "";
    }
  }

  // --------------
  // Freund Login
  // --------------
  document.getElementById("friend-login-btn").onclick = () => {
    clearError();
    const pw = document.getElementById("friend-password").value;
    if(pw === FRIEND_PASSWORD) {
      showSection("friendArea");
      resetBookingForm();
      renderCalendar(currentYear, currentMonth);
      isYearlyView = false;
    } else {
      showError("Falsches Passwort!");
    }
  };

  // --------------
  // Admin Login
  // --------------
  document.getElementById("admin-login-btn").onclick = () => {
    clearError();
    const pw = document.getElementById("admin-password").value;
    if(pw === ADMIN_PASSWORD) {
      showSection("adminArea");
      renderAdminBookings();
      clearError();
    } else {
      showError("Falsches Admin-Passwort!");
    }
  };

  // Admin Logout
  document.getElementById("btn-logout-admin").onclick = () => {
    showSection("start");
  };

  // ----------------
  // Kalender Rendern
  // ----------------
  const calendarEl = document.getElementById("calendar");
  const monthYearEl = document.getElementById("month-year");

  document.getElementById("prev-month").onclick = () => {
    changeMonth(-1);
  };
  document.getElementById("next-month").onclick = () => {
    changeMonth(1);
  };

  function changeMonth(delta) {
    let newMonth = currentMonth + delta;
    let newYear = currentYear;
    if(newMonth < 0) {
      newMonth = 11;
      newYear--;
    }
    if(newMonth > 11) {
      newMonth = 0;
      newYear++;
    }
    // Grenzen beachten
    if(newYear < CAL_START_YEAR || (newYear === CAL_START_YEAR && newMonth < CAL_START_MONTH)) return;
    if(newYear > CAL_END_YEAR || (newYear === CAL_END_YEAR && newMonth > CAL_END_MONTH)) return;

    currentYear = newYear;
    currentMonth = newMonth;
    renderCalendar(currentYear, currentMonth);
  }

  function renderCalendar(year, month) {
    monthYearEl.textContent = new Date(year, month).toLocaleDateString("de-DE", {year:"numeric", month:"long"});

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month+1, 0);
    const startWeekday = firstDay.getDay(); // Sonntag=0 ... Samstag=6
    const daysInMonth = lastDay.getDate();

    // Wochentage (Montag bis Sonntag mit Sonntag ganz rechts)
    const weekdays = ["Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag","Sonntag"];

    // Alle Buchungen und Blocks
    const bookings = loadBookings();
    const blocks = loadBlocks();

    // Kalenderaufbau: Tabelle
    let html = "<thead><tr>";
    weekdays.forEach(day => {
      html += `<th>${day}</th>`;
    });
    html += "</tr></thead><tbody><tr>";

    // Start: Montag = 1, Sonntag = 0 (letzter Tag)
    // Wir wollen Montag als erste Spalte (index 0)
    let startDayIndex = startWeekday === 0 ? 6 : startWeekday - 1;

    // Leerzellen vor Monatsanfang
    for(let i=0; i<startDayIndex; i++) {
      html += `<td class="inactive"></td>`;
    }

    for(let day=1; day<=daysInMonth; day++) {
      const dateStr = formatDate(new Date(year, month, day));
      // Check block & booking status
      let classes = "";
      if(blocks.some(b => checkOverlap(dateStr, dateStr, b.startDate, b.endDate))) {
        classes = "blocked";
      } else if(bookings.some(bk => checkOverlap(dateStr, dateStr, bk.startDate, bk.endDate))) {
        classes = "booked";
      }

      // Sonntag rechts (letzte Spalte)
      // Sonntag ist letzter Tag
      // Wenn (startDayIndex + day -1) % 7 === 6 dann ist Sonntag
      let cellContent = day;
      html += `<td class="${classes}" data-date="${dateStr}">${cellContent}</td>`;

      // Neue Zeile am Ende der Woche (Sonntag)
      if((startDayIndex + day) % 7 === 0) {
        html += "</tr><tr>";
      }
    }

    // Leerzellen am Ende
    let cellsInLastRow = (startDayIndex + daysInMonth) % 7;
    if(cellsInLastRow !== 0) {
      for(let i=cellsInLastRow; i<7; i++) {
        html += `<td class="inactive"></td>`;
      }
      html += "</tr>";
    }

    calendarEl.innerHTML = html;

    attachDateClickHandlers();
  }

  // ---------------------
  // Datums- und Bereichsauswahl
  // ---------------------
  let selectedStartDate = null;
  let selectedEndDate = null;

  function attachDateClickHandlers() {
    const cells = calendarEl.querySelectorAll("td:not(.inactive)");
    cells.forEach(cell => {
      cell.style.cursor = "pointer";
      cell.onclick = () => {
        const date = cell.getAttribute("data-date");
        if(!selectedStartDate || (selectedStartDate && selectedEndDate)) {
          // Neue Auswahl
          selectedStartDate = date;
          selectedEndDate = null;
        } else {
          // zweites Datum auswählen
          if(date < selectedStartDate) {
            selectedEndDate = selectedStartDate;
            selectedStartDate = date;
          } else {
            selectedEndDate = date;
          }
        }
        updateSelectionVisual();
        showBookingForm();
      };
    });
  }

  function updateSelectionVisual() {
    const cells = calendarEl.querySelectorAll("td");
    cells.forEach(cell => {
      cell.classList.remove("selected-start", "selected-end", "selected-range");
      const date = cell.getAttribute("data-date");
      if(!date) return;
      if(date === selectedStartDate) cell.classList.add("selected-start");
      if(date === selectedEndDate) cell.classList.add("selected-end");
      if(selectedStartDate && selectedEndDate && date > selectedStartDate && date < selectedEndDate) {
        cell.classList.add("selected-range");
      }
    });
  }

  // ---------------------
  // Buchungsformular
  // ---------------------
  const bookingForm = document.getElementById("booking-form");
  const bookStartInput = document.getElementById("book-start-date");
  const bookEndInput = document.getElementById("book-end-date");
  const bookNameInput = document.getElementById("book-name");
  const bookPersonsInput = document.getElementById("book-persons");
  const bookBreakfastInput = document.getElementById("book-breakfast");
  const bookArrivalInput = document.getElementById("book-arrival-time");
  const bookDepartureInput = document.getElementById("book-departure-time");
  const bookingError = document.getElementById("booking-error");

  function showBookingForm() {
    if(!selectedStartDate) {
      bookingForm.style.display = "none";
      return;
    }
    bookStartInput.value = selectedStartDate;
    bookEndInput.value = selectedEndDate ? selectedEndDate : selectedStartDate;
    bookingError.textContent = "";
    bookingForm.style.display = "block";
    bookNameInput.focus();
  }
  function resetBookingForm() {
    selectedStartDate = null;
    selectedEndDate = null;
    updateSelectionVisual();
    bookingForm.style.display = "none";
    bookingError.textContent = "";
    bookingForm.reset && bookingForm.reset();
  }
  document.getElementById("btn-cancel-booking-form").onclick = () => {
    resetBookingForm();
  };

  // Formulareingabe validieren & speichern
  bookingForm.onsubmit = (e) => {
    e.preventDefault();

    // Werte lesen
    const name = bookNameInput.value.trim();
    const persons = parseInt(bookPersonsInput.value);
    const breakfast = bookBreakfastInput.value;
    const arrival = bookArrivalInput.value || null;
    const departure = bookDepartureInput.value || null;
    const startDate = bookStartInput.value;
    const endDate = bookEndInput.value;

    bookingError.textContent = "";

    if(!name) {
      bookingError.textContent = "Bitte Name eingeben.";
      return;
    }
    if(!persons || persons < 1) {
      bookingError.textContent = "Bitte gültige Anzahl Personen eingeben.";
      return;
    }
    if(!startDate || !endDate) {
      bookingError.textContent = "Bitte gültige Start- und Enddaten eingeben.";
      return;
    }
    if(endDate < startDate) {
      bookingError.textContent = "Enddatum darf nicht vor Startdatum liegen.";
      return;
    }

    // Buchungen & Blocks laden
    const bookings = loadBookings();
    const blocks = loadBlocks();

    // Überprüfung auf Überschneidungen mit bestehenden Buchungen oder Blocks
    for(let b of bookings) {
      if(checkOverlap(startDate, endDate, b.startDate, b.endDate)) {
        bookingError.textContent = `Der Zeitraum überschneidet sich mit einer bestehenden Buchung (${b.name}: ${b.startDate} - ${b.endDate}).`;
        return;
      }
    }
    for(let b of blocks) {
      if(checkOverlap(startDate, endDate, b.startDate, b.endDate)) {
        bookingError.textContent = `Der Zeitraum überschneidet sich mit einem blockierten Zeitraum (${b.startDate} - ${b.endDate}).`;
        return;
      }
    }

    // Neue Buchung speichern
    const newBooking = {
      id: "b" + Date.now(),
      name,
      persons,
      breakfast,
      arrivalTime: arrival,
      departureTime: departure,
      startDate,
      endDate,
    };
    bookings.push(newBooking);
    saveBookings(bookings);

    alert("Buchung erfolgreich gespeichert!");
    resetBookingForm();
    renderCalendar(currentYear, currentMonth);
  };

  // -----------------------
  // Jahreskalender Übersicht
  // -----------------------
  const yearlyCalendarContent = document.getElementById("yearly-calendar-content");
  const yearDisplay = document.getElementById("year-display");

  document.getElementById("switch-calendar-view").onclick = () => {
    isYearlyView = true;
    currentYear = new Date().getFullYear();
    showSection("yearlyCalendar");
    renderYearlyCalendar(currentYear);
  };
  document.getElementById("year-prev").onclick = () => {
    if(currentYear > CAL_START_YEAR) {
      currentYear--;
      renderYearlyCalendar(currentYear);
    }
  };
  document.getElementById("year-next").onclick = () => {
    if(currentYear < CAL_END_YEAR) {
      currentYear++;
      renderYearlyCalendar(currentYear);
    }
  };
  document.getElementById("year-to-month-view").onclick = () => {
    isYearlyView = false;
    showSection("friendArea");
    renderCalendar(currentYear, currentMonth);
  };

  function renderYearlyCalendar(year) {
    yearDisplay.textContent = year;
    yearlyCalendarContent.innerHTML = "";

    const bookings = loadBookings();
    const blocks = loadBlocks();

    // Monate als kleine Kalender nebeneinander
    const monthNames = [
      "Januar","Februar","März","April","Mai","Juni",
      "Juli","August","September","Oktober","November","Dezember"
    ];

    for(let m=0; m<12; m++) {
      const firstDay = new Date(year, m, 1);
      const lastDay = new Date(year, m+1, 0);
      const daysInMonth = lastDay.getDate();

      let monthHtml = `<table class="calendar" style="margin:10px; display:inline-block; width:150px; font-size:10px;">`;
      monthHtml += `<thead><tr><th colspan="7">${monthNames[m]}</th></tr>`;
      monthHtml += `<tr><th>M</th><th>D</th><th>M</th><th>D</th><th>F</th><th>S</th><th>S</th></tr></thead><tbody><tr>`;

      // Start Tag Index für Montag=0, Sonntag=6
      const startWeekday = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
      for(let i=0; i<startWeekday; i++) {
        monthHtml += `<td></td>`;
      }
      for(let day=1; day<=daysInMonth; day++) {
        const dateStr = formatDate(new Date(year, m, day));
        let classes = "";
        if(blocks.some(b => checkOverlap(dateStr, dateStr, b.startDate, b.endDate))) {
          classes = "blocked";
        } else if(bookings.some(bk => checkOverlap(dateStr, dateStr, bk.startDate, bk.endDate))) {
          classes = "booked";
        }
        monthHtml += `<td class="${classes}">${day}</td>`;

        if((startWeekday + day) % 7 === 0) {
          monthHtml += "</tr><tr>";
        }
      }
      monthHtml += "</tr></tbody></table>";
      yearlyCalendarContent.insertAdjacentHTML("beforeend", monthHtml);
    }
  }

  // -------------------
  // Admin Bereich
  // -------------------

  const adminBookingsList = document.getElementById("admin-bookings-list");

  function renderAdminBookings() {
    const bookings = loadBookings();
    const blocks = loadBlocks();

    let html = `<table><thead><tr><th>Typ</th><th>Name</th><th>Personen</th><th>Frühstück</th><th>Anreise</th><th>Abreise</th><th>Startdatum</th><th>Enddatum</th><th>Aktion</th></tr></thead><tbody>`;

    // Buchungen
    bookings.forEach(bk => {
      html += `<tr>
        <td>Buchung</td>
        <td>${bk.name}</td>
        <td>${bk.persons}</td>
        <td>${bk.breakfast}</td>
        <td>${bk.arrivalTime || "-"}</td>
        <td>${bk.departureTime || "-"}</td>
        <td>${bk.startDate}</td>
        <td>${bk.endDate}</td>
        <td><button class="btn-delete-booking" data-id="${bk.id}">Löschen</button></td>
      </tr>`;
    });

    // Blockierungen
    blocks.forEach((bl, idx) => {
      html += `<tr>
        <td>Blockiert</td>
        <td colspan="5" style="text-align:center;">-</td>
        <td>${bl.startDate}</td>
        <td>${bl.endDate}</td>
        <td><button class="btn-delete-block" data-idx="${idx}">Entfernen</button></td>
      </tr>`;
    });

    html += "</tbody></table>";

    adminBookingsList.innerHTML = html;

    // Delete Buttons Events
    document.querySelectorAll(".btn-delete-booking").forEach(btn => {
      btn.onclick = () => {
        if(confirm("Buchung wirklich löschen?")) {
          const id = btn.getAttribute("data-id");
          deleteBooking(id);
        }
      };
    });
    document.querySelectorAll(".btn-delete-block").forEach(btn => {
      btn.onclick = () => {
        if(confirm("Blockierung wirklich entfernen?")) {
          const idx = parseInt(btn.getAttribute("data-idx"));
          deleteBlock(idx);
        }
      };
    });
  }

  function deleteBooking(id) {
    let bookings = loadBookings();
    bookings = bookings.filter(b => b.id !== id);
    saveBookings(bookings);
    renderAdminBookings();
    renderCalendar(currentYear, currentMonth);
  }
  function deleteBlock(idx) {
    let blocks = loadBlocks();
    blocks.splice(idx, 1);
    saveBlocks(blocks);
    renderAdminBookings();
    renderCalendar(currentYear, currentMonth);
  }

  // -------------------
  // Blockierungen Hinzufügen (Admin)
  // -------------------
  const blockStartInput = document.getElementById("block-start-date");
  const blockEndInput = document.getElementById("block-end-date");
  
  document.getElementById("block-days-form").onsubmit = (e) => {
    e.preventDefault();
    const blockError = document.getElementById("block-error");
    if(blockError) blockError.textContent = "";

    const startDate = blockStartInput.value;
    const endDate = blockEndInput.value;

    if(!startDate || !endDate) {
      if(blockError) blockError.textContent = "Bitte Start- und Enddatum angeben.";
      return;
    }
    if(endDate < startDate) {
      if(blockError) blockError.textContent = "Enddatum darf nicht vor Startdatum liegen.";
      return;
    }

    // Prüfen auf Überschneidungen mit bestehenden Buchungen oder Blocks
    const bookings = loadBookings();
    const blocks = loadBlocks();

    for(let b of bookings) {
      if(checkOverlap(startDate, endDate, b.startDate, b.endDate)) {
        if(blockError) blockError.textContent = `Der Zeitraum überschneidet sich mit einer bestehenden Buchung (${b.name}: ${b.startDate} - ${b.endDate}).`;
        return;
      }
    }
    for(let b of blocks) {
      if(checkOverlap(startDate, endDate, b.startDate, b.endDate)) {
        if(blockError) blockError.textContent = `Der Zeitraum überschneidet sich mit einem bereits blockierten Zeitraum (${b.startDate} - ${b.endDate}).`;
        return;
      }
    }

    blocks.push({startDate, endDate});
    saveBlocks(blocks);
    alert("Blockierung erfolgreich hinzugefügt!");
    document.getElementById("block-days-form").reset();
    renderAdminBookings();
    renderCalendar(currentYear, currentMonth);
  };
  
  // Funktion zum Freigeben von Tagen
  function unblockDays(startDate, endDate) {
    let blocks = loadBlocks();
    const originalLength = blocks.length;
    blocks = blocks.filter(block => !checkOverlap(block.startDate, block.endDate, startDate, endDate));
    if (blocks.length === originalLength) {
      return false;
    }
    saveBlocks(blocks);
    return true;
  }
  
  // Event-Listener für den "Tage freigeben" Button
  document.getElementById("btn-unblock-days").onclick = () => {
    const blockStartInput = document.getElementById("block-start-date");
    const blockEndInput = document.getElementById("block-end-date");
    const startDate = blockStartInput.value;
    const endDate = blockEndInput.value;

    if (!startDate || !endDate) {
      alert("Bitte gib ein Start- und Enddatum zum Freigeben ein.");
      return;
    }
    
    if (confirm(`Sollen die Tage von ${startDate} bis ${endDate} wirklich freigegeben werden?`)) {
      const success = unblockDays(startDate, endDate);
      if (success) {
        alert("Tage erfolgreich freigegeben!");
        document.getElementById("block-days-form").reset();
        renderAdminBookings();
        renderCalendar(currentYear,
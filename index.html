<script>
    (() => {
        const FRIEND_PASSWORD = "ÜinOffenbach!";
        const ADMIN_PASSWORD = "Romulus2025?!";
        const ADMIN_EMAIL = "pauldippmann@gmail.com";
        const EMAILJS_SERVICE_ID = 'service_9vdk8p2';
        const EMAILJS_TEMPLATE_ID_BOOKING = 'template_exo2yi1';
        const EMAILJS_TEMPLATE_ID_CANCEL = 'template_9azx5z9';
        const EMAILJS_TEMPLATE_ID_REMINDER = 'template_9azx5z9';
        const EMAILJS_PUBLIC_KEY = 'OXLiZSAem79gPP-Wl';

        const firebaseConfig = {
            apiKey: "AIzaSyAu9hXGYbgD-_pz0LHN5VgUcV9mRNkU98",
            authDomain: "freunde-kalender-offenbach.firebaseapp.com",
            projectId: "freunde-kalender-offenbach",
            storageBucket: "freunde-kalender-offenbach.firebasestorage.app",
            messagingSenderId: "753671032354",
            appId: "1:753671032354:web:a154b43ccdfcc491c4c47b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const CAL_START_YEAR = 2025;
        const CAL_END_YEAR = 2040;
        let currentYear;
        let selectedStartDate = null;
        let selectedEndDate = null;
        let currentView = 'friend';
        let currentLang = 'de';
        let bookings = [];
        let blockedDates = [];
        let waitlist = [];
        let cancelledBookings = [];

        const sections = {
            start: document.getElementById("start-page"),
            friendArea: document.getElementById("friend-area"),
            adminLogin: document.getElementById("admin-login"),
            adminArea: document.getElementById("admin-area"),
            cancel: document.getElementById("cancel-page")
        };

        const translations = {
            de: {
                'Willkommen in Offenbach!': 'Willkommen in Offenbach!',
                'Ich freue mich auf deinen Besuch! Über den Kalender kannst du als Gast bequem eine Übernachtung buchen. Oder du meldest dich als Admin an, um den Kalender zu verwalten.': 'Ich freue mich auf deinen Besuch! Über den Kalender kannst du als Gast bequem eine Übernachtung buchen. Oder du meldest dich als Admin an, um den Kalender zu verwalten.',
                'Hier geht es zur Buchung': 'Hier geht es zur Buchung',
                'Admin Login': 'Admin Login',
                'Startseite': 'Startseite',
                'Bitte Passwort eingeben:': 'Bitte Passwort eingeben:',
                'Passwort': 'Passwort',
                'Einloggen': 'Einloggen',
                'Falsches Passwort!': 'Falsches Passwort!',
                'Jahreskalender (Gast-Ansicht)': 'Jahreskalender (Gast-Ansicht)',
                '&lt; Vorjahr': '&lt; Vorjahr',
                'Nächstes Jahr &gt;': 'Nächstes Jahr &gt;',
                'Freie Tage': 'Freie Tage',
                'Gebuchte Tage': 'Gebuchte Tage',
                'Blockierte Tage': 'Blockierte Tage',
                'Ausgewählter Zeitraum': 'Ausgewählter Zeitraum',
                'Buchungsdetails': 'Buchungsdetails',
                'Buchung von': 'Buchung von',
                'bis': 'bis',
                'Name *': 'Name *',
                'E-Mail-Adresse *': 'E-Mail-Adresse *',
                'Mobilfunknummer *': 'Mobilfunknummer *',
                'Anzahl Personen * (max. 3)': 'Anzahl Personen * (max. 3)',
                'Anreisetag *': 'Anreisetag *',
                'Abreisetag *': 'Abreisetag *',
                'Frühstück benötigt? *': 'Frühstück benötigt? *',
                'Ja': 'Ja',
                'Nein': 'Nein',
                'Anreise Uhrzeit (optional)': 'Anreise Uhrzeit (optional)',
                'Abreise Uhrzeit (optional)': 'Abreise Uhrzeit (optional)',
                'Bemerkungen (optional, max. 200 Zeichen)': 'Bemerkungen (optional, max. 200 Zeichen)',
                'Parkplatz benötigt?': 'Parkplatz benötigt?',
                'Buchung abschicken': 'Buchung abschicken',
                'Abbrechen': 'Abbrechen',
                'Warteliste': 'Warteliste',
                'Der ausgewählte Zeitraum ist bereits belegt. Tragen Sie sich in die Warteliste ein, um benachrichtigt zu werden, wenn der Zeitraum frei wird.': 'Der ausgewählte Zeitraum ist bereits belegt. Tragen Sie sich in die Warteliste ein, um benachrichtigt zu werden, wenn der Zeitraum frei wird.',
                'Auf Warteliste setzen': 'Auf Warteliste setzen',
                'Buchung erfolgreich!': 'Buchung erfolgreich!',
                'Ihre Buchungsdetails wurden gespeichert. Sie erhalten in Kürze eine Bestätigung per E-Mail.': 'Ihre Buchungsdetails wurden gespeichert. Sie erhalten in Kürze eine Bestätigung per E-Mail.',
                'Kalender-Datei herunterladen': 'Kalender-Datei herunterladen',
                'Neue Buchung': 'Neue Buchung',
                'Zurück zur Startseite': 'Zurück zur Startseite',
                'Admin Logout': 'Admin Logout',
                'Exportiere Buchungen (CSV)': 'Exportiere Buchungen (CSV)',
                'Admin-Kalender (iCal-Link)': 'Admin-Kalender (iCal-Link)',
                'Ausgewählte Tage blockieren': 'Ausgewählte Tage blockieren',
                'Ausgewählte Tage freigeben': 'Ausgewählte Tage freigeben',
                'Admin-Buchung oder Blockierung': 'Admin-Buchung oder Blockierung',
                'Name': 'Name',
                'E-Mail': 'E-Mail',
                'Startdatum': 'Startdatum',
                'Enddatum': 'Enddatum',
                'Buchung eintragen': 'Buchung eintragen',
                'Buchung bearbeiten': 'Buchung bearbeiten',
                'Mobilfunknummer': 'Mobilfunknummer',
                'Anzahl Personen': 'Anzahl Personen',
                'Frühstück': 'Frühstück',
                'Bemerkungen': 'Bemerkungen',
                'Änderungen speichern': 'Änderungen speichern',
                'Belegte und Blockierte Tage': 'Belegte und Blockierte Tage',
                'Wartelisten-Anfragen': 'Wartelisten-Anfragen',
                'Statistiken': 'Statistiken',
                'Anzahl Buchungen (aktiv):': 'Anzahl Buchungen (aktiv):',
                'Anzahl stornierter Buchungen:': 'Anzahl stornierter Buchungen:',
                'Durchschnittliche Aufenthaltsdauer:': 'Durchschnittliche Aufenthaltsdauer:',
                'Tage': 'Tage',
                'Auslastung im aktuellen Jahr:': 'Auslastung im aktuellen Jahr:',
                'Buchung stornieren': 'Buchung stornieren',
                'Stornierungslink wird überprüft...': 'Stornierungslink wird überprüft...',
                'Buchung bestätigen & stornieren': 'Buchung bestätigen & stornieren',
                'Zurück zur Homepage': 'Zurück zur Startseite',
                'Falscher Login-Passwort!': 'Falscher Login-Passwort!',
                'Ein Fehler ist aufgetreten': 'Ein Fehler ist aufgetreten',
                'Bitte geben Sie ein gültiges Datum ein.': 'Bitte geben Sie ein gültiges Datum ein.',
                'Bitte wählen Sie einen Zeitraum aus.': 'Bitte wählen Sie einen Zeitraum aus.',
                'Buchungszeitraum muss in der Zukunft liegen.': 'Buchungszeitraum muss in der Zukunft liegen.',
                'Der ausgewählte Zeitraum ist nicht vollständig verfügbar.': 'Der ausgewählte Zeitraum ist nicht vollständig verfügbar.',
                'Ihre Buchung wurde erfolgreich storniert.': 'Ihre Buchung wurde erfolgreich storniert.',
                'Buchung nicht gefunden oder bereits storniert.': 'Buchung nicht gefunden oder bereits storniert.',
                'Alle Felder müssen ausgefüllt werden.': 'Alle Felder müssen ausgefüllt werden.',
                'Bitte füllen Sie alle erforderlichen Felder aus.': 'Bitte füllen Sie alle erforderlichen Felder aus.',
                'Mindestens ein Tag im ausgewählten Zeitraum ist ein Wochenende (Samstag oder Sonntag). Buchungen müssen mit dem Besitzer abgestimmt werden.': 'Mindestens ein Tag im ausgewählten Zeitraum ist ein Wochenende (Samstag oder Sonntag). Buchungen müssen mit dem Besitzer abgestimmt werden.',
                'Wartelistenanfrage erfolgreich gesendet!': 'Wartelistenanfrage erfolgreich gesendet!',
                'Wartelistenanfrage konnte nicht gesendet werden.': 'Wartelistenanfrage konnte nicht gesendet werden.',
                'Wartelistenanfrage erfolgreich gelöscht.': 'Wartelistenanfrage erfolgreich gelöscht.',
                'Fehler beim Löschen der Wartelistenanfrage.': 'Fehler beim Löschen der Wartelistenanfrage.',
                'Bitte wählen Sie einen Tag aus, um eine Buchung zu erstellen.': 'Bitte wählen Sie einen Tag aus, um eine Buchung zu erstellen.',
                'Startdatum kann nicht nach Enddatum liegen.': 'Startdatum kann nicht nach Enddatum liegen.',
                'Buchung erfolgreich in der Datenbank eingetragen.': 'Buchung erfolgreich in der Datenbank eingetragen.',
                'Fehler beim Eintragen der Buchung.': 'Fehler beim Eintragen der Buchung.',
                'Buchung erfolgreich aktualisiert.': 'Buchung erfolgreich aktualisiert.',
                'Fehler beim Aktualisieren der Buchung.': 'Fehler beim Aktualisieren der Buchung.',
                'Möchten Sie diese Buchung wirklich löschen?': 'Möchten Sie diese Buchung wirklich löschen?',
                'Buchung erfolgreich gelöscht.': 'Buchung erfolgreich gelöscht.',
                'Fehler beim Löschen der Buchung.': 'Fehler beim Löschen der Buchung.',
                'Bitte wählen Sie einen oder mehrere Tage aus.': 'Bitte wählen Sie einen oder mehrere Tage aus.',
                'Wartelistenanfrage wurde erfolgreich bearbeitet und gelöscht.': 'Wartelistenanfrage wurde erfolgreich bearbeitet und gelöscht.',
                'Fehler bei der Bearbeitung der Wartelistenanfrage.': 'Fehler bei der Bearbeitung der Wartelistenanfrage.',
                'Bitte wählen Sie zuerst einen Zeitraum aus.': 'Bitte wählen Sie zuerst einen Zeitraum aus.',
                'Fehler beim Blockieren der Tage.': 'Fehler beim Blockieren der Tage.',
                'Tage erfolgreich blockiert.': 'Tage erfolgreich blockiert.',
                'Fehler beim Freigeben der Tage.': 'Fehler beim Freigeben der Tage.',
                'Tage erfolgreich freigegeben.': 'Tage erfolgreich freigegeben.',
                'Der ausgewählte Zeitraum muss mindestens eine Übernachtung enthalten.': 'Der ausgewählte Zeitraum muss mindestens eine Übernachtung enthalten.',
                'Der ausgewählte Zeitraum überschreitet die maximal erlaubte Länge von 14 Tagen.': 'Der ausgewählte Zeitraum überschreitet die maximal erlaubte Länge von 14 Tagen.',
                'Wochentage': 'Wochentage',
                'Storniert': 'Storniert',
                'Download calendar file': 'Kalender-Datei herunterladen',
                'Zurück zur Startseite': 'Zurück zur Startseite'
            },
            en: {
                'Willkommen in Offenbach!': 'Welcome to Offenbach!',
                'Ich freue mich auf deinen Besuch! Über den Kalender kannst du als Gast bequem eine Übernachtung buchen. Oder du meldest dich als Admin an, um den Kalender zu verwalten.': 'I\'m looking forward to your visit! You can book an overnight stay as a guest via the calendar. Or you can log in as an admin to manage the calendar.',
                'Hier geht es zur Buchung': 'Click here to book',
                'Admin Login': 'Admin Login',
                'Startseite': 'Homepage',
                'Bitte Passwort eingeben:': 'Please enter your password:',
                'Passwort': 'Password',
                'Einloggen': 'Login',
                'Falsches Passwort!': 'Wrong password!',
                'Jahreskalender (Gast-Ansicht)': 'Yearly Calendar (Guest View)',
                '&lt; Vorjahr': '&lt; Previous Year',
                'Nächstes Jahr &gt;': 'Next Year &gt;',
                'Freie Tage': 'Available Days',
                'Gebuchte Tage': 'Booked Days',
                'Blockierte Tage': 'Blocked Days',
                'Ausgewählter Zeitraum': 'Selected Period',
                'Buchungsdetails': 'Booking Details',
                'Buchung von': 'Booking from',
                'bis': 'to',
                'Name *': 'Name *',
                'E-Mail-Adresse *': 'E-Mail Address *',
                'Mobilfunknummer *': 'Mobile number *',
                'Anzahl Personen * (max. 3)': 'Number of people * (max. 3)',
                'Anreisetag *': 'Arrival Date *',
                'Abreisetag *': 'Departure Date *',
                'Frühstück benötigt? *': 'Breakfast needed? *',
                'Ja': 'Yes',
                'Nein': 'No',
                'Anreise Uhrzeit (optional)': 'Arrival Time (optional)',
                'Abreise Uhrzeit (optional)': 'Departure Time (optional)',
                'Bemerkungen (optional, max. 200 Zeichen)': 'Comments (optional, max. 200 characters)',
                'Parkplatz benötigt?': 'Parking space needed?',
                'Buchung abschicken': 'Submit Booking',
                'Abbrechen': 'Cancel',
                'Warteliste': 'Waitlist',
                'Der ausgewählte Zeitraum ist bereits belegt. Tragen Sie sich in die Warteliste ein, um benachrichtigt zu werden, wenn der Zeitraum frei wird.': 'The selected period is already booked. Join the waitlist to be notified if the period becomes available.',
                'Auf Warteliste setzen': 'Join Waitlist',
                'Buchung erfolgreich!': 'Booking successful!',
                'Ihre Buchungsdetails wurden gespeichert. Sie erhalten in Kürze eine Bestätigung per E-Mail.': 'Your booking details have been saved. You will receive a confirmation email shortly.',
                'Kalender-Datei herunterladen': 'Download calendar file',
                'Neue Buchung': 'New Booking',
                'Zurück zur Startseite': 'Back to Homepage',
                'Admin Logout': 'Admin Logout',
                'Exportiere Buchungen (CSV)': 'Export Bookings (CSV)',
                'Admin-Kalender (iCal-Link)': 'Admin Calendar (iCal link)',
                'Ausgewählte Tage blockieren': 'Block Selected Days',
                'Ausgewählte Tage freigeben': 'Unblock Selected Days',
                'Admin-Buchung oder Blockierung': 'Admin Booking or Blocking',
                'Name': 'Name',
                'E-Mail': 'Email',
                'Startdatum': 'Start Date',
                'Enddatum': 'End Date',
                'Buchung eintragen': 'Add Booking',
                'Buchung bearbeiten': 'Edit Booking',
                'Mobilfunknummer': 'Mobile Number',
                'Anzahl Personen': 'Number of people',
                'Frühstück': 'Breakfast',
                'Bemerkungen': 'Comments',
                'Änderungen speichern': 'Save Changes',
                'Belegte und Blockierte Tage': 'Booked and Blocked Days',
                'Wartelisten-Anfragen': 'Waitlist Requests',
                'Statistiken': 'Statistics',
                'Anzahl Buchungen (aktiv):': 'Number of active bookings:',
                'Anzahl stornierter Buchungen:': 'Number of cancelled bookings:',
                'Durchschnittliche Aufenthaltsdauer:': 'Average stay duration:',
                'Tage': 'days',
                'Auslastung im aktuellen Jahr:': 'Occupancy in current year:',
                'Buchung stornieren': 'Cancel Booking',
                'Stornierungslink wird überprüft...': 'Cancellation link is being checked...',
                'Buchung bestätigen & stornieren': 'Confirm & Cancel Booking',
                'Zurück zur Homepage': 'Back to homepage',
                'Falscher Login-Passwort!': 'Wrong login password!',
                'Ein Fehler ist aufgetreten': 'An error occurred',
                'Bitte geben Sie ein gültiges Datum ein.': 'Please enter a valid date.',
                'Bitte wählen Sie einen Zeitraum aus.': 'Please select a period.',
                'Buchungszeitraum muss in der Zukunft liegen.': 'Booking period must be in the future.',
                'Der ausgewählte Zeitraum ist nicht vollständig verfügbar.': 'The selected period is not fully available.',
                'Ihre Buchung wurde erfolgreich storniert.': 'Your booking has been successfully cancelled.',
                'Buchung nicht gefunden oder bereits storniert.': 'Booking not found or already cancelled.',
                'Alle Felder müssen ausgefüllt werden.': 'All fields must be filled out.',
                'Bitte füllen Sie alle erforderlichen Felder aus.': 'Please fill in all required fields.',
                'Mindestens ein Tag im ausgewählten Zeitraum ist ein Wochenende (Samstag oder Sonntag). Buchungen müssen mit dem Besitzer abgestimmt werden.': 'At least one day in the selected period is a weekend (Saturday or Sunday). Bookings must be arranged with the owner.',
                'Wartelistenanfrage erfolgreich gesendet!': 'Waitlist request sent successfully!',
                'Wartelistenanfrage konnte nicht gesendet werden.': 'Waitlist request could not be sent.',
                'Wartelistenanfrage erfolgreich gelöscht.': 'Waitlist request deleted successfully.',
                'Fehler beim Löschen der Wartelistenanfrage.': 'Error deleting waitlist request.',
                'Bitte wählen Sie einen Tag aus, um eine Buchung zu erstellen.': 'Please select a day to create a booking.',
                'Startdatum kann nicht nach Enddatum liegen.': 'Start date cannot be after end date.',
                'Buchung erfolgreich in der Datenbank eingetragen.': 'Booking successfully added to the database.',
                'Fehler beim Eintragen der Buchung.': 'Error adding booking to the database.',
                'Buchung erfolgreich aktualisiert.': 'Booking successfully updated.',
                'Fehler beim Aktualisieren der Buchung.': 'Error updating booking.',
                'Möchten Sie diese Buchung wirklich löschen?': 'Do you really want to delete this booking?',
                'Buchung erfolgreich gelöscht.': 'Booking successfully deleted.',
                'Fehler beim Löschen der Buchung.': 'Error deleting booking.',
                'Bitte wählen Sie einen oder mehrere Tage aus.': 'Please select one or more days.',
                'Wartelistenanfrage wurde erfolgreich bearbeitet und gelöscht.': 'Waitlist request successfully processed and deleted.',
                'Fehler bei der Bearbeitung der Wartelistenanfrage.': 'Error processing waitlist request.',
                'Bitte wählen Sie zuerst einen Zeitraum aus.': 'Please select a period first.',
                'Fehler beim Blockieren der Tage.': 'Error blocking days.',
                'Tage erfolgreich blockiert.': 'Days successfully blocked.',
                'Fehler beim Freigeben der Tage.': 'Error unblocking days.',
                'Tage erfolgreich unblocked.',
                'Der ausgewählte Zeitraum muss mindestens eine Übernachtung enthalten.': 'The selected period must contain at least one overnight stay.',
                'Der ausgewählte Zeitraum überschreitet die maximal erlaubte Länge von 14 Tagen.': 'The selected period exceeds the maximum allowed length of 14 days.',
                'Wochentage': 'Weekdays',
                'Storniert': 'Cancelled',
                'Download calendar file': 'Download calendar file',
                'Zurück zur Startseite': 'Back to Homepage'
            }
        };

        const weekdays = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];

        emailjs.init(EMAILJS_PUBLIC_KEY);

        function showSection(sectionId) {
            for (const key in sections) {
                sections[key].style.display = 'none';
            }
            sections[sectionId].style.display = 'block';
        }

        function showNotification(message, isError = false) {
            const notificationBox = document.getElementById('notification-box');
            notificationBox.textContent = message;
            notificationBox.className = 'notification-box';
            if (isError) {
                notificationBox.classList.add('error');
            } else {
                notificationBox.classList.add('success');
            }
            notificationBox.style.display = 'block';
            setTimeout(() => {
                notificationBox.style.display = 'none';
            }, 3000);
        }

        function updateLanguage(lang) {
            currentLang = lang;
            const elements = document.querySelectorAll('[data-lang-de], [data-lang-en], [data-lang-placeholder-de], [data-lang-placeholder-en]');
            elements.forEach(el => {
                const de = el.dataset.langDe;
                const en = el.dataset.langEn;
                const dePlaceholder = el.dataset.langPlaceholderDe;
                const enPlaceholder = el.dataset.langPlaceholderEn;

                if (de && en) {
                    el.textContent = lang === 'de' ? de : en;
                }
                if (dePlaceholder && enPlaceholder) {
                    el.placeholder = lang === 'de' ? dePlaceholder : enPlaceholder;
                }
            });
            updateCalendarHeaders();
        }

        function translate(key) {
            return translations[currentLang][key] || key;
        }

        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const day = d.getDate().toString().padStart(2, '0');
            return `${day}.${month}.${year}`;
        }

        function getBookingStatusForDay(date, view) {
            const dateStr = date.toISOString().split('T')[0];

            const isBlocked = blockedDates.some(block => {
                const blockStart = new Date(block.startDate);
                const blockEnd = new Date(block.endDate);
                return date >= blockStart && date <= blockEnd;
            });
            if (isBlocked) {
                return 'blocked';
            }

            const activeBookings = bookings.filter(b => b.status === 'booked' || b.status === 'confirmed');
            const isBooked = activeBookings.some(booking => {
                const bookingStart = new Date(booking.startDate);
                const bookingEnd = new Date(booking.endDate);
                return date >= bookingStart && date < bookingEnd;
            });
            if (isBooked) {
                return 'booked';
            }

            const isCancelled = cancelledBookings.some(booking => {
                const bookingStart = new Date(booking.startDate);
                const bookingEnd = new Date(booking.endDate);
                return date >= bookingStart && date < bookingEnd;
            });
            if (isCancelled && view === 'admin') {
                return 'cancelled';
            }
            return 'available';
        }

        function isDaySelectable(date, isGuestView = true) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (date < today) {
                return false;
            }

            const status = getBookingStatusForDay(date, isGuestView ? 'guest' : 'admin');
            return status === 'available';
        }

        function isRangeAvailable(start, end) {
            const currentDate = new Date(start);
            while (currentDate <= end) {
                if (!isDaySelectable(currentDate)) {
                    return false;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return true;
        }

        function clearSelectedDays() {
            const selectedDays = document.querySelectorAll('.selected');
            selectedDays.forEach(day => day.classList.remove('selected', 'selected-first', 'selected-last'));
            selectedStartDate = null;
            selectedEndDate = null;
        }

        function updateSelectedDays(start, end) {
            clearSelectedDays();
            if (!start || !end) return;

            const days = document.querySelectorAll('td');
            let isFirst = true;

            const endDateExclusive = new Date(end);
            endDateExclusive.setDate(endDateExclusive.getDate() - 1);

            days.forEach(day => {
                if (!day.dataset.date) return;
                const dayDate = new Date(day.dataset.date);
                if (dayDate >= start && dayDate <= endDateExclusive) {
                    day.classList.add('selected');
                    if (isFirst) {
                        day.classList.add('selected-first');
                        isFirst = false;
                    }
                }
            });

            const lastSelectedDay = document.querySelector(`.calendar td[data-date="${endDateExclusive.toISOString().split('T')[0]}"]`);
            if (lastSelectedDay) {
                lastSelectedDay.classList.add('selected-last');
            }
        }

        function handleDayClick(dayElement, date) {
            const dateStr = date.toISOString().split('T')[0];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const isGuestView = currentView === 'friend';

            if (isGuestView && date < today) {
                return;
            }

            const dayStatus = getBookingStatusForDay(date, isGuestView ? 'guest' : 'admin');

            if (isGuestView && dayStatus !== 'available') {
                selectedStartDate = date;
                const endDate = new Date(date);
                endDate.setDate(endDate.getDate() + 1);
                selectedEndDate = endDate;
                document.getElementById('waitlist-summary-text').textContent = `${translate('Buchung von')} ${formatDate(selectedStartDate)} ${translate('bis')} ${formatDate(selectedEndDate)}`;
                document.getElementById('waitlist-form').style.display = 'block';
                document.getElementById('booking-form').style.display = 'none';
                clearSelectedDays();
                return;
            }

            if (!selectedStartDate) {
                selectedStartDate = date;
                selectedEndDate = new Date(date);
                selectedEndDate.setDate(selectedEndDate.getDate() + 1);
            } else {
                const newDate = date;
                const start = new Date(Math.min(selectedStartDate.getTime(), newDate.getTime()));
                const end = new Date(Math.max(selectedStartDate.getTime(), newDate.getTime()));
                end.setDate(end.getDate() + 1);

                selectedStartDate = start;
                selectedEndDate = end;

                const rangeDays = (selectedEndDate.getTime() - selectedStartDate.getTime()) / (1000 * 3600 * 24);

                if (rangeDays < 1) {
                    showNotification(translate('Der ausgewählte Zeitraum muss mindestens eine Übernachtung enthalten.'), true);
                    clearSelectedDays();
                    return;
                }
                if (rangeDays > 14 && isGuestView) {
                    showNotification(translate('Der ausgewählte Zeitraum überschreitet die maximal erlaubte Länge von 14 Tagen.'), true);
                    clearSelectedDays();
                    return;
                }

                if (!isRangeAvailable(selectedStartDate, new Date(selectedEndDate.getTime() - 1))) {
                    if (isGuestView) {
                         document.getElementById('waitlist-summary-text').textContent = `${translate('Buchung von')} ${formatDate(selectedStartDate)} ${translate('bis')} ${formatDate(selectedEndDate)}`;
                        document.getElementById('waitlist-form').style.display = 'block';
                        document.getElementById('booking-form').style.display = 'none';
                        clearSelectedDays();
                        return;
                    } else {
                        showNotification(translate('Der ausgewählte Zeitraum ist nicht vollständig verfügbar.'), true);
                        clearSelectedDays();
                        return;
                    }
                }

                if (isGuestView) {
                    document.getElementById('book-start-date').value = selectedStartDate.toISOString().split('T')[0];
                    document.getElementById('book-end-date').value = selectedEndDate.toISOString().split('T')[0];
                    document.getElementById('booking-summary-text').textContent = `${translate('Buchung von')} ${formatDate(selectedStartDate)} ${translate('bis')} ${formatDate(selectedEndDate)}`;
                    document.getElementById('booking-form').style.display = 'block';
                    document.getElementById('waitlist-form').style.display = 'none';
                }
            }
            updateSelectedDays(selectedStartDate, selectedEndDate);

            if (!isGuestView) {
                document.getElementById('admin-booking-form-container').style.display = 'block';
                document.getElementById('admin-book-start-date').value = selectedStartDate.toISOString().split('T')[0];
                document.getElementById('admin-book-end-date').value = selectedEndDate.toISOString().split('T')[0];
            }
        }


        function renderDay(cell, date, bookingsForMonth, is_admin) {
            cell.dataset.date = date.toISOString().split('T')[0];
            cell.classList.remove('inactive', 'booked', 'blocked', 'cancelled', 'half-booked-am', 'half-booked-pm', 'half-blocked-am', 'half-blocked-pm');

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (date.getMonth() !== bookingsForMonth[0].getMonth() || (!is_admin && date < today)) {
                cell.classList.add('inactive');
                return;
            }

            const status = getBookingStatusForDay(date, is_admin ? 'admin' : 'guest');
            if (status !== 'available') {
                cell.classList.add(status);
                if (!is_admin) {
                     cell.classList.add('tooltip');
                     const tooltip = document.createElement('span');
                     tooltip.className = 'tooltiptext';
                     tooltip.textContent = translate('Gebuchte Tage');
                     cell.appendChild(tooltip);
                } else if (is_admin && status === 'booked') {
                    const booking = bookings.find(b => {
                        const b_start = new Date(b.startDate);
                        const b_end = new Date(b.endDate);
                        return date >= b_start && date < b_end && (b.status === 'booked' || b.status === 'confirmed');
                    });
                    if (booking) {
                        cell.classList.add('tooltip');
                        const tooltip = document.createElement('span');
                        tooltip.className = 'tooltiptext';
                        tooltip.textContent = `${booking.name} (${formatDate(date)})`;
                        cell.appendChild(tooltip);
                        cell.onclick = (e) => {
                            e.stopPropagation();
                            showEditForm(booking);
                        };
                    }
                } else if (is_admin && status === 'blocked') {
                    cell.classList.add('tooltip');
                    const tooltip = document.createElement('span');
                    tooltip.className = 'tooltiptext';
                    tooltip.textContent = translate('Blockierte Tage');
                    cell.appendChild(tooltip);
                } else if (is_admin && status === 'cancelled') {
                    cell.classList.add('tooltip');
                    const tooltip = document.createElement('span');
                    tooltip.className = 'tooltiptext';
                    tooltip.textContent = translate('Storniert');
                    cell.appendChild(tooltip);
                }
            } else {
                cell.onclick = (e) => {
                    e.stopPropagation();
                    handleDayClick(cell, date);
                };
            }
        }

        function renderCalendar(targetId, date, bookingsForMonth, is_admin) {
            const calendarEl = document.getElementById(targetId);
            calendarEl.innerHTML = '';
            const monthNames = [
                "Januar", "Februar", "März", "April", "Mai", "Juni",
                "Juli", "August", "September", "Oktober", "November", "Dezember"
            ];
            const month = date.getMonth();
            const year = date.getFullYear();

            const monthContainer = document.createElement('div');
            monthContainer.className = 'calendar-month';
            const h3 = document.createElement('h3');
            h3.textContent = `${monthNames[month]} ${year}`;
            monthContainer.appendChild(h3);

            const table = document.createElement('table');
            table.className = 'calendar';
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');

            const headerRow = document.createElement('tr');
            weekdays.forEach(day => {
                const th = document.createElement('th');
                th.textContent = day;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const firstDayOfMonth = new Date(year, month, 1);
            const startingDay = firstDayOfMonth.getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let day = 1;
            for (let i = 0; i < 6; i++) {
                const row = document.createElement('tr');
                for (let j = 0; j < 7; j++) {
                    const cell = document.createElement('td');
                    if (i === 0 && j < startingDay) {
                        cell.classList.add('inactive');
                    } else if (day > daysInMonth) {
                        cell.classList.add('inactive');
                    } else {
                        const cellDate = new Date(year, month, day);
                        cell.textContent = day;
                        renderDay(cell, cellDate, bookingsForMonth, is_admin);
                        day++;
                    }
                    row.appendChild(cell);
                }
                tbody.appendChild(row);
                if (day > daysInMonth) break;
            }
            table.appendChild(tbody);
            monthContainer.appendChild(table);
            calendarEl.appendChild(monthContainer);
        }

        function renderYearlyCalendar(targetId, year, is_admin) {
            const yearlyCalendarEl = document.getElementById(targetId);
            yearlyCalendarEl.innerHTML = '';
            for (let i = 0; i < 12; i++) {
                const date = new Date(year, i, 1);
                renderCalendar(targetId, date, bookings, is_admin);
            }
            updateSelectedDays(selectedStartDate, selectedEndDate);
        }

        function updateCalendarHeaders() {
            document.getElementById('year-display').textContent = currentYear;
            document.getElementById('admin-year-display').textContent = currentYear;
        }

        function fetchDataAndRender() {
            Promise.all([
                db.collection('bookings').get(),
                db.collection('blocked').get(),
                db.collection('waitlist').get()
            ]).then(([bookingSnapshot, blockedSnapshot, waitlistSnapshot]) => {
                bookings = bookingSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                blockedDates = blockedSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                waitlist = waitlistSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                cancelledBookings = bookings.filter(b => b.status === 'cancelled');

                if (currentView === 'friend') {
                    renderYearlyCalendar('yearly-calendar-content', currentYear, false);
                } else if (currentView === 'admin') {
                    renderYearlyCalendar('admin-yearly-calendar-content', currentYear, true);
                    renderBookingsList();
                    renderWaitlist();
                    updateStats();
                }
            }).catch(error => {
                console.error("Error fetching data: ", error);
                showNotification(translate('Ein Fehler ist aufgetreten'), true);
            });
        }


        function startApp() {
            const today = new Date();
            currentYear = today.getFullYear();
            const urlParams = new URLSearchParams(window.location.search);
            const cancelId = urlParams.get('cancel');

            if (cancelId) {
                showSection('cancel');
                handleCancellation(cancelId);
            } else {
                showSection('start');
            }
            updateLanguage(currentLang);
        }

        document.getElementById('friend-login-btn').addEventListener('click', () => {
            const password = document.getElementById('friend-password').value;
            if (password === FRIEND_PASSWORD) {
                currentView = 'friend';
                showSection('friendArea');
                fetchDataAndRender();
                document.getElementById('btn-to-start').style.display = 'block';
            } else {
                document.getElementById('friend-login-error').textContent = translate('Falsches Passwort!');
            }
        });

        document.getElementById('admin-login-btn').addEventListener('click', () => {
            const password = document.getElementById('admin-password').value;
            if (password === ADMIN_PASSWORD) {
                currentView = 'admin';
                showSection('adminArea');
                fetchDataAndRender();
                document.getElementById('btn-to-start').style.display = 'block';
            } else {
                document.getElementById('admin-login-error').textContent = translate('Falsches Passwort!');
            }
        });

        document.getElementById('btn-show-admin-login').addEventListener('click', () => {
            showSection('adminLogin');
            document.getElementById('btn-to-start').style.display = 'block';
            document.getElementById('admin-password').value = '';
            document.getElementById('admin-login-error').textContent = '';
        });

        document.getElementById('btn-to-start').addEventListener('click', () => {
            showSection('start');
            document.getElementById('btn-to-start').style.display = 'none';
            document.getElementById('friend-password').value = '';
            document.getElementById('friend-login-error').textContent = '';
            clearSelectedDays();
        });

        document.getElementById('year-prev').addEventListener('click', () => {
            currentYear--;
            fetchDataAndRender();
        });

        document.getElementById('year-next').addEventListener('click', () => {
            currentYear++;
            fetchDataAndRender();
        });

        document.getElementById('admin-year-prev').addEventListener('click', () => {
            currentYear--;
            fetchDataAndRender();
        });

        document.getElementById('admin-year-next').addEventListener('click', () => {
            currentYear++;
            fetchDataAndRender();
        });

        document.getElementById('booking-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('book-name').value;
            const email = document.getElementById('book-email').value;
            const phone = document.getElementById('book-phone').value;
            const persons = document.getElementById('book-persons').value;
            const startDate = document.getElementById('book-start-date').value;
            const endDate = document.getElementById('book-end-date').value;
            const breakfast = document.getElementById('book-breakfast').value;
            const arrivalTime = document.getElementById('book-arrival-time').value;
            const departureTime = document.getElementById('book-departure-time').value;
            const comment = document.getElementById('book-comment').value;
            const parking = document.getElementById('book-parking').checked;

            if (!name || !email || !phone || !persons || !startDate || !endDate) {
                document.getElementById('booking-error').textContent = translate('Bitte füllen Sie alle erforderlichen Felder aus.');
                return;
            }

            const bookingData = {
                name,
                email,
                phone,
                persons: parseInt(persons, 10),
                startDate,
                endDate,
                breakfast,
                arrivalTime,
                departureTime,
                comment,
                parking,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'booked'
            };

            db.collection('bookings').add(bookingData)
                .then((docRef) => {
                    sendBookingEmail(bookingData, docRef.id);
                    document.getElementById('booking-success').style.display = 'block';
                    document.getElementById('booking-form').style.display = 'none';
                    clearSelectedDays();
                    fetchDataAndRender();
                })
                .catch((error) => {
                    console.error("Error adding document: ", error);
                    showNotification(translate('Fehler beim Eintragen der Buchung.'), true);
                });
        });

        document.getElementById('btn-cancel-booking-form').addEventListener('click', (e) => {
             e.preventDefault();
             document.getElementById('booking-form').style.display = 'none';
             clearSelectedDays();
        });

        document.getElementById('waitlist-request-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('waitlist-name').value;
            const email = document.getElementById('waitlist-email').value;
            if (!name || !email) {
                 document.getElementById('waitlist-error').textContent = translate('Bitte füllen Sie alle erforderlichen Felder aus.');
                return;
            }
             const waitlistData = {
                name,
                email,
                startDate: selectedStartDate.toISOString().split('T')[0],
                endDate: selectedEndDate.toISOString().split('T')[0],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            db.collection('waitlist').add(waitlistData)
                 .then(() => {
                    showNotification(translate('Wartelistenanfrage erfolgreich gesendet!'));
                    document.getElementById('waitlist-form').style.display = 'none';
                    document.getElementById('waitlist-request-form').reset();
                })
                .catch((error) => {
                    console.error("Error adding to waitlist: ", error);
                    showNotification(translate('Wartelistenanfrage konnte nicht gesendet werden.'), true);
                });
        });

        document.getElementById('btn-cancel-waitlist-form').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('waitlist-form').style.display = 'none';
            clearSelectedDays();
        });

        function sendBookingEmail(booking, id) {
            const templateParams = {
                to_email: booking.email,
                from_name: 'Deine Gastgeber',
                to_name: booking.name,
                startDate: formatDate(new Date(booking.startDate)),
                endDate: formatDate(new Date(booking.endDate)),
                cancellation_link: `${window.location.origin}${window.location.pathname}?cancel=${id}`,
                persons: booking.persons,
                breakfast: booking.breakfast,
                comment: booking.comment || 'Keine Bemerkungen',
                phone: booking.phone
            };
            emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID_BOOKING, templateParams, EMAILJS_PUBLIC_KEY)
                .then(() => {
                    console.log('Email sent successfully!');
                }, (error) => {
                    console.error('Email sending failed:', error);
                });
        }

        document.getElementById('btn-download-ical').addEventListener('click', () => {
            const booking = {
                 name: document.getElementById('book-name').value,
                 startDate: document.getElementById('book-start-date').value,
                 endDate: document.getElementById('book-end-date').value,
                 comment: document.getElementById('book-comment').value
            };
            createAndDownloadIcal(booking);
        });

        function createAndDownloadIcal(booking) {
            const calendar = ical();
            const event = calendar.createEvent({
                start: new Date(booking.startDate),
                end: new Date(booking.endDate),
                summary: `Buchung von ${booking.name}`,
                description: booking.comment,
                location: 'Offenbach, Deutschland'
            });

            const link = document.createElement('a');
            link.href = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(calendar.toString());
            link.download = `Buchung_Offenbach_${booking.startDate}.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        document.getElementById('btn-new-booking').addEventListener('click', () => {
            document.getElementById('booking-success').style.display = 'none';
            document.getElementById('friend-password').value = '';
            document.getElementById('friend-login-btn').click();
        });

        document.getElementById('btn-return-home-from-booking').addEventListener('click', () => {
            showSection('start');
            document.getElementById('booking-success').style.display = 'none';
            document.getElementById('btn-to-start').style.display = 'none';
        });

        function handleCancellation(cancelId) {
            const cancelStatusText = document.getElementById('cancel-status-text');
            const cancelDetails = document.getElementById('cancel-details');
            const cancelButtons = document.getElementById('cancel-buttons');

            db.collection('bookings').doc(cancelId).get()
                .then(doc => {
                    if (!doc.exists) {
                        cancelStatusText.textContent = translate('Buchung nicht gefunden oder bereits storniert.');
                        cancelButtons.style.display = 'none';
                    } else {
                        const bookingData = doc.data();
                        cancelStatusText.textContent = translate('Möchten Sie diese Buchung wirklich stornieren?');
                        cancelDetails.innerHTML = `
                            <p><strong>${translate('Name')}:</strong> ${bookingData.name}</p>
                            <p><strong>${translate('E-Mail')}:</strong> ${bookingData.email}</p>
                            <p><strong>${translate('Zeitraum')}:</strong> ${formatDate(new Date(bookingData.startDate))} - ${formatDate(new Date(bookingData.endDate))}</p>
                        `;
                        document.getElementById('btn-confirm-cancellation').dataset.id = cancelId;
                        cancelButtons.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error("Error getting document:", error);
                    cancelStatusText.textContent = translate('Ein Fehler ist aufgetreten');
                    cancelButtons.style.display = 'none';
                });
        }

        document.getElementById('btn-confirm-cancellation').addEventListener('click', (e) => {
            const id = e.target.dataset.id;
            db.collection('bookings').doc(id).update({
                status: 'cancelled',
                cancellationDate: firebase.firestore.FieldValue.serverTimestamp()
            })
                .then(() => {
                    showNotification(translate('Ihre Buchung wurde erfolgreich storniert.'));
                    document.getElementById('cancel-status-text').textContent = translate('Ihre Buchung wurde erfolgreich storniert.');
                    document.getElementById('cancel-buttons').style.display = 'none';
                })
                .catch(error => {
                    console.error("Error updating document:", error);
                    showNotification(translate('Ein Fehler ist aufgetreten'), true);
                });
        });

        document.getElementById('btn-return-home').addEventListener('click', () => {
            window.location.href = window.location.origin + window.location.pathname;
        });

        document.getElementById('btn-logout-admin').addEventListener('click', () => {
            currentView = 'start';
            showSection('start');
            document.getElementById('btn-to-start').style.display = 'none';
        });

        document.getElementById('btn-block-selected').addEventListener('click', () => {
            if (!selectedStartDate || !selectedEndDate) {
                showNotification(translate('Bitte wählen Sie zuerst einen Zeitraum aus.'), true);
                return;
            }

            const blockData = {
                startDate: selectedStartDate.toISOString().split('T')[0],
                endDate: selectedEndDate.toISOString().split('T')[0],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection('blocked').add(blockData)
                .then(() => {
                    showNotification(translate('Tage erfolgreich blockiert.'));
                    fetchDataAndRender();
                    clearSelectedDays();
                })
                .catch((error) => {
                    console.error("Error blocking days: ", error);
                    showNotification(translate('Fehler beim Blockieren der Tage.'), true);
                });
        });

        document.getElementById('btn-unblock-selected').addEventListener('click', () => {
            if (!selectedStartDate || !selectedEndDate) {
                showNotification(translate('Bitte wählen Sie zuerst einen Zeitraum aus.'), true);
                return;
            }

            const startDateStr = selectedStartDate.toISOString().split('T')[0];
            const endDateStr = selectedEndDate.toISOString().split('T')[0];

            db.collection('blocked')
                .where('startDate', '==', startDateStr)
                .where('endDate', '==', endDateStr)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        showNotification(translate('Keine Blockierung für diesen Zeitraum gefunden.'), true);
                        return;
                    }
                    const batch = db.batch();
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    return batch.commit();
                })
                .then(() => {
                    showNotification(translate('Tage erfolgreich freigegeben.'));
                    fetchDataAndRender();
                    clearSelectedDays();
                })
                .catch(error => {
                    console.error("Error unblocking days:", error);
                    showNotification(translate('Fehler beim Freigeben der Tage.'), true);
                });
        });

        document.getElementById('admin-booking-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('admin-book-name').value;
            const email = document.getElementById('admin-book-email').value;
            const startDate = document.getElementById('admin-book-start-date').value;
            const endDate = document.getElementById('admin-book-end-date').value;
            if (!name || !email || !startDate || !endDate) {
                showNotification(translate('Bitte füllen Sie alle erforderlichen Felder aus.'), true);
                return;
            }

            db.collection('bookings').add({
                name,
                email,
                startDate,
                endDate,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'booked'
            })
                .then(() => {
                    showNotification(translate('Buchung erfolgreich in der Datenbank eingetragen.'));
                    document.getElementById('admin-booking-form-container').style.display = 'none';
                    document.getElementById('admin-booking-form').reset();
                    fetchDataAndRender();
                    clearSelectedDays();
                })
                .catch(error => {
                    console.error("Error adding admin booking: ", error);
                    showNotification(translate('Fehler beim Eintragen der Buchung.'), true);
                });
        });

        document.getElementById('btn-cancel-admin-form').addEventListener('click', (e) => {
             e.preventDefault();
             document.getElementById('admin-booking-form-container').style.display = 'none';
             clearSelectedDays();
        });

        document.getElementById('admin-edit-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-booking-id').value;
            const name = document.getElementById('edit-name').value;
            const email = document.getElementById('edit-email').value;
            const phone = document.getElementById('edit-phone').value;
            const persons = document.getElementById('edit-persons').value;
            const startDate = document.getElementById('edit-start-date').value;
            const endDate = document.getElementById('edit-end-date').value;
            const breakfast = document.getElementById('edit-breakfast').value;
            const comment = document.getElementById('edit-comment').value;
            const status = document.getElementById('edit-status').value;
            const parking = document.getElementById('edit-parking').checked;

            db.collection('bookings').doc(id).update({
                name,
                email,
                phone,
                persons: parseInt(persons, 10),
                startDate,
                endDate,
                breakfast,
                comment,
                status,
                parking
            })
                .then(() => {
                    showNotification(translate('Buchung erfolgreich aktualisiert.'));
                    document.getElementById('admin-edit-form-container').style.display = 'none';
                    fetchDataAndRender();
                })
                .catch(error => {
                    console.error("Error updating booking: ", error);
                    showNotification(translate('Fehler beim Aktualisieren der Buchung.'), true);
                });
        });

        document.getElementById('btn-cancel-edit-form').addEventListener('click', (e) => {
             e.preventDefault();
             document.getElementById('admin-edit-form-container').style.display = 'none';
        });

        document.getElementById('btn-delete-booking').addEventListener('click', () => {
            const id = document.getElementById('edit-booking-id').value;
            if (confirm(translate('Möchten Sie diese Buchung wirklich löschen?'))) {
                db.collection('bookings').doc(id).delete()
                    .then(() => {
                        showNotification(translate('Buchung erfolgreich gelöscht.'));
                        document.getElementById('admin-edit-form-container').style.display = 'none';
                        fetchDataAndRender();
                    })
                    .catch(error => {
                    console.error("Error removing document: ", error);
                    showNotification(translate('Fehler beim Löschen der Buchung.'), true);
                });
            }
        });

        document.getElementById('btn-delete-waitlist-entry').addEventListener('click', () => {
            const id = document.getElementById('edit-waitlist-id').value;
            if (confirm(translate('Möchten Sie diese Wartelistenanfrage wirklich löschen?'))) {
                db.collection('waitlist').doc(id).delete()
                    .then(() => {
                        showNotification(translate('Wartelistenanfrage erfolgreich gelöscht.'));
                        document.getElementById('admin-waitlist-edit-form-container').style.display = 'none';
                        fetchDataAndRender();
                    })
                    .catch(error => {
                        console.error("Error removing document: ", error);
                        showNotification(translate('Fehler beim Löschen der Wartelistenanfrage.'), true);
                    });
            }
        });

        function showEditForm(booking) {
            document.getElementById('admin-booking-form-container').style.display = 'none';
            const editFormContainer = document.getElementById('admin-edit-form-container');
            editFormContainer.style.display = 'block';
            document.getElementById('edit-booking-id').value = booking.id;
            document.getElementById('edit-name').value = booking.name;
            document.getElementById('edit-email').value = booking.email;
            document.getElementById('edit-phone').value = booking.phone;
            document.getElementById('edit-persons').value = booking.persons;
            document.getElementById('edit-start-date').value = booking.startDate;
            document.getElementById('edit-end-date').value = booking.endDate;
            document.getElementById('edit-breakfast').value = booking.breakfast;
            document.getElementById('edit-comment').value = booking.comment;
            document.getElementById('edit-status').value = booking.status;
            document.getElementById('edit-parking').checked = booking.parking;
        }

        function showWaitlistEditForm(waitlistEntry) {
            document.getElementById('admin-waitlist-edit-form-container').style.display = 'block';
            document.getElementById('edit-waitlist-id').value = waitlistEntry.id;
            document.getElementById('edit-waitlist-name').value = waitlistEntry.name;
            document.getElementById('edit-waitlist-email').value = waitlistEntry.email;
            document.getElementById('edit-waitlist-start-date').value = waitlistEntry.startDate;
            document.getElementById('edit-waitlist-end-date').value = waitlistEntry.endDate;
        }

        function renderBookingsList() {
            const listEl = document.getElementById('admin-bookings-list');
            listEl.innerHTML = '';
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>${translate('Name')}</th>
                        <th>${translate('E-Mail')}</th>
                        <th>${translate('Startdatum')}</th>
                        <th>${translate('Enddatum')}</th>
                        <th>Status</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tbody = table.querySelector('tbody');
            bookings.forEach(booking => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${booking.name}</td>
                    <td>${booking.email}</td>
                    <td>${booking.startDate}</td>
                    <td>${booking.endDate}</td>
                    <td>${booking.status}</td>
                    <td><button class="edit-booking-btn" data-id="${booking.id}">${translate('Bearbeiten')}</button></td>
                `;
                tbody.appendChild(tr);
            });
            listEl.appendChild(table);

            document.querySelectorAll('.edit-booking-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const bookingId = e.target.dataset.id;
                    const bookingToEdit = bookings.find(b => b.id === bookingId);
                    if (bookingToEdit) {
                        showEditForm(bookingToEdit);
                    }
                });
            });
        }

        function renderWaitlist() {
             const listEl = document.getElementById('admin-waitlist-list');
             listEl.innerHTML = '';
             const table = document.createElement('table');
             table.innerHTML = `
                <thead>
                    <tr>
                        <th>${translate('Name')}</th>
                        <th>${translate('E-Mail')}</th>
                        <th>${translate('Startdatum')}</th>
                        <th>${translate('Enddatum')}</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
             `;
             const tbody = table.querySelector('tbody');
             waitlist.forEach(entry => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${entry.name}</td>
                    <td>${entry.email}</td>
                    <td>${entry.startDate}</td>
                    <td>${entry.endDate}</td>
                    <td><button class="edit-waitlist-btn" data-id="${entry.id}">${translate('Bearbeiten')}</button></td>
                `;
                tbody.appendChild(tr);
            });
            listEl.appendChild(table);

            document.querySelectorAll('.edit-waitlist-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const waitlistId = e.target.dataset.id;
                    const waitlistEntryToEdit = waitlist.find(w => w.id === waitlistId);
                    if (waitlistEntryToEdit) {
                        showWaitlistEditForm(waitlistEntryToEdit);
                    }
                });
            });
        }

        function updateStats() {
            const activeBookingsCount = bookings.filter(b => b.status === 'booked' || b.status === 'confirmed').length;
            const cancelledBookingsCount = bookings.filter(b => b.status === 'cancelled').length;
            const totalDaysBooked = bookings.reduce((sum, b) => {
                const start = new Date(b.startDate);
                const end = new Date(b.endDate);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return sum + diffDays;
            }, 0);
            const avgStay = activeBookingsCount > 0 ? (totalDaysBooked / activeBookingsCount).toFixed(1) : 0;
            const daysInYear = (new Date(currentYear, 11, 31) - new Date(currentYear, 0, 0)) / (1000 * 60 * 60 * 24);
            const occupancy = daysInYear > 0 ? ((totalDaysBooked / daysInYear) * 100).toFixed(1) : 0;

            document.getElementById('stat-active-bookings').textContent = activeBookingsCount;
            document.getElementById('stat-cancelled-bookings').textContent = cancelledBookingsCount;
            document.getElementById('stat-avg-stay').textContent = avgStay;
            document.getElementById('stat-occupancy').textContent = `${occupancy}%`;
        }

        document.getElementById('btn-export-csv').addEventListener('click', () => {
            const headers = ["ID", "Name", "Email", "Telefon", "Personen", "Startdatum", "Enddatum", "Frühstück", "Anreisezeit", "Abreisezeit", "Bemerkungen", "Parkplatz", "Status", "Erstellt am", "Storniert am"];
            let csv = headers.join(";") + "\n";
            bookings.forEach(booking => {
                const row = [
                    booking.id,
                    `"${booking.name}"`,
                    `"${booking.email}"`,
                    `"${booking.phone || ''}"`,
                    booking.persons || '',
                    booking.startDate,
                    booking.endDate,
                    booking.breakfast,
                    booking.arrivalTime || '',
                    booking.departureTime || '',
                    `"${booking.comment || ''}"`,
                    booking.parking,
                    booking.status,
                    booking.createdAt.toDate().toLocaleString(),
                    booking.cancellationDate ? booking.cancellationDate.toDate().toLocaleString() : ''
                ].join(";");
                csv += row + "\n";
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `bookings_${currentYear}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        startApp();
    })();
</script>
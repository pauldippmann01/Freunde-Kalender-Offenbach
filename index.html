<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Freunde-Bereich Offenbach</title>
<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: url('https://upload.wikimedia.org/wikipedia/commons/7/75/Offenbach_am_Main_2013_01.JPG') no-repeat center center/cover;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
  }
  #login-box, #content, #admin-section {
    background: rgba(0,0,0,0.5);
    padding: 20px 30px;
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.7);
    max-width: 600px;
    width: 100%;
  }
  h1,h2,h3 {
    margin-top: 0;
    text-align: center;
  }
  input, select {
    width: 100%;
    padding: 8px;
    margin: 6px 0 12px 0;
    border-radius: 6px;
    border: none;
    font-size: 1rem;
  }
  button {
    background: #4CAF50;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    width: 100%;
    font-size: 1.1rem;
    margin-top: 10px;
  }
  button:hover {
    background: #45a049;
  }
  #error, #booking-msg, #admin-msg, #admin-error {
    text-align: center;
    font-weight: bold;
    margin: 10px 0;
  }
  #error, #admin-error {
    color: #ff6b6b;
  }
  #booking-msg, #admin-msg {
    color: #a3ffa3;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    color: white;
  }
  th, td {
    padding: 8px;
    border: 1px solid #ddd;
    text-align: center;
  }
  th {
    background: #333;
  }
  .calendar {
    margin: 20px auto;
    max-width: 100%;
  }
  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  .calendar-nav button {
    background: #444;
    color: white;
    border: none;
    padding: 5px 10px;
    cursor: pointer;
    border-radius: 6px;
    font-weight: bold;
  }
  .calendar-nav button:hover {
    background: #666;
  }
  .days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
  }
  .day {
    padding: 10px 6px;
    background: rgba(255,255,255,0.1);
    border-radius: 6px;
    cursor: pointer;
    user-select: none;
  }
  .day.disabled {
    background: rgba(255,255,255,0.02);
    color: #aaa;
    cursor: default;
  }
  .day.blocked {
    background: #ff4c4c;
    color: white;
    cursor: not-allowed;
  }
  .day.booked {
    background: #4caf5080;
    color: white;
    cursor: not-allowed;
  }
  .day.selected {
    border: 2px solid #00ff00;
    background: #228822;
    color: white;
  }
  .mode-switch {
    margin: 15px 0;
    text-align: center;
  }
  .mode-switch button {
    width: auto;
    margin: 0 5px;
  }
  /* Scroll for bookings table */
  #bookings-table-wrapper {
    max-height: 200px;
    overflow-y: auto;
  }
  /* Admin section inputs */
  #admin-block-day {
    width: calc(100% - 140px);
    display: inline-block;
  }
  #admin-block-day + button {
    width: 65px;
    margin-left: 5px;
  }
</style>
</head>
<body>

<div id="login-box">
  <h2>Willkommen, Freund ‚ú®</h2>
  <button id="friend-login-btn">Einloggen (Freunde)</button>
  <hr style="margin: 20px 0; border-color: #888;" />
  <h3>Admin Login</h3>
  <input type="password" id="admin-password" placeholder="Admin Passwort" />
  <button id="admin-login-btn">Einloggen (Admin)</button>
  <p id="error"></p>
</div>

<div id="content" style="display:none;">
  <h1>üéâ Hallo Freunde!</h1>

  <div class="mode-switch">
    <button id="month-view-btn">Monatsansicht</button>
    <button id="year-view-btn">Jahresansicht</button>
  </div>

  <div id="calendar-container" class="calendar"></div>

  <h3>Buchung eintragen</h3>
  <form id="booking-form">
    <input type="text" id="name" placeholder="Dein Name *" required />
    <input type="number" id="persons" min="1" placeholder="Anzahl Personen *" required />
    <select id="breakfast" required>
      <option value="">Fr√ºhst√ºck ben√∂tigt? *</option>
      <option value="Ja">Ja</option>
      <option value="Nein">Nein</option>
    </select>
    <input type="time" id="arrival" placeholder="Ankunftszeit (optional)" />
    <input type="time" id="departure" placeholder="Abfahrtszeit (optional)" />
    <input type="text" id="start-date" placeholder="Startdatum ausw√§hlen *" readonly required />
    <input type="text" id="end-date" placeholder="Enddatum ausw√§hlen *" readonly required />
    <button type="submit">Buchung speichern</button>
  </form>
  <p id="booking-msg"></p>
</div>

<div id="admin-section" style="display:none;">
  <h2>Admin Bereich</h2>
  <button id="admin-logout-btn" style="background:#c62828; margin-bottom:10px;">Logout</button>
  <h3>Blockierte Tage verwalten</h3>
  <input type="date" id="admin-block-day" />
  <button id="block-day-btn">Blockieren</button>
  <button id="unblock-day-btn">Freigeben</button>
  <p id="admin-msg"></p>
  <p id="admin-error"></p>

  <h3>Buchungen √úbersicht</h3>
  <div id="bookings-table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Personen</th>
          <th>Fr√ºhst√ºck</th>
          <th>Ankunft</th>
          <th>Abfahrt</th>
          <th>Startdatum</th>
          <th>Enddatum</th>
          <th>Aktion</th>
        </tr>
      </thead>
      <tbody id="bookings-tbody"></tbody>
    </table>
  </div>
  <button id="export-csv-btn" style="margin-top: 10px;">Buchungen als CSV exportieren</button>
</div>

<script>
(() => {
  const friendLoginBtn = document.getElementById("friend-login-btn");
  const adminLoginBtn = document.getElementById("admin-login-btn");
  const adminLogoutBtn = document.getElementById("admin-logout-btn");
  const errorP = document.getElementById("error");

  const loginBox = document.getElementById("login-box");
  const content = document.getElementById("content");
  const adminSection = document.getElementById("admin-section");

  const monthViewBtn = document.getElementById("month-view-btn");
  const yearViewBtn = document.getElementById("year-view-btn");
  const calendarContainer = document.getElementById("calendar-container");

  const bookingForm = document.getElementById("booking-form");
  const bookingMsg = document.getElementById("booking-msg");

  const nameInput = document.getElementById("name");
  const personsInput = document.getElementById("persons");
  const breakfastInput = document.getElementById("breakfast");
  const arrivalInput = document.getElementById("arrival");
  const departureInput = document.getElementById("departure");
  const startDateInput = document.getElementById("start-date");
  const endDateInput = document.getElementById("end-date");

  // Admin block day inputs and messages
  const blockDayInput = document.getElementById("admin-block-day");
  const blockDayBtn = document.getElementById("block-day-btn");
  const unblockDayBtn = document.getElementById("unblock-day-btn");
  const adminMsg = document.getElementById("admin-msg");
  const adminError = document.getElementById("admin-error");

  const bookingsTbody = document.getElementById("bookings-tbody");
  const exportCsvBtn = document.getElementById("export-csv-btn");

  // Konfiguration
  const ADMIN_PASSWORD = "AdminPass123";
  const FRIEND_PASS = ""; // kein Passwort mehr

  // Kalender Start/Ende
  const START_YEAR = 2025;
  const END_YEAR = 2040;

  // Daten speichern/laden via localStorage
  let bookings = JSON.parse(localStorage.getItem("bookings") || "[]");
  let blockedDays = JSON.parse(localStorage.getItem("blockedDays") || "[]");

  // Kalenderzustand
  let currentYear = START_YEAR;
  let currentMonth = 8; // September 2025 (0-basiert: 0=Jan, also 8=Sep)
  let viewMode = "month"; // "month" oder "year"

  // Zum Start-/Enddatum-Ausw√§hlen
  let selectingStartDate = true;

  // Hilfsfunktionen f√ºr Datum-Strings "YYYY-MM-DD"
  function formatDate(date) {
    return date.toISOString().slice(0, 10);
  }
  function parseDate(str) {
    return new Date(str + "T00:00:00");
  }

  // Kalender rendern (Monat oder Jahr)
  function renderCalendar() {
    calendarContainer.innerHTML = "";

    if(viewMode === "month") {
      renderMonthCalendar(currentYear, currentMonth);
    } else {
      renderYearCalendar(currentYear);
    }
  }

  function renderMonthCalendar(year, month) {
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startWeekday = firstDay.getDay() || 7; // Sonntag=0 zu 7 √§ndern
    const daysInMonth = lastDay.getDate();

    // √úberschrift und Navigation
    const header = document.createElement("div");
    header.className = "calendar-header";

    const prevBtn = document.createElement("button");
    prevBtn.textContent = "<";
    prevBtn.onclick = () => {
      if(month === 0) {
        if(year > START_YEAR) {
          currentYear--;
          currentMonth = 11;
        }
      } else currentMonth--;
      renderCalendar();
    };

    const nextBtn = document.createElement("button");
    nextBtn.textContent = ">";
    nextBtn.onclick = () => {
      if(month === 11) {
        if(year < END_YEAR) {
          currentYear++;
          currentMonth = 0;
        }
      } else currentMonth++;
      renderCalendar();
    };

    const title = document.createElement("h3");
    title.textContent = firstDay.toLocaleString("de-DE", {month: "long", year: "numeric"});

    const navDiv = document.createElement("div");
    navDiv.className = "calendar-nav";
    navDiv.appendChild(prevBtn);
    navDiv.appendChild(nextBtn);

    header.appendChild(navDiv);
    header.appendChild(title);
    header.appendChild(document.createElement("div")); // Platzhalter f√ºr Layout

    calendarContainer.appendChild(header);

    // Wochentage
    const weekdaysDiv = document.createElement("div");
    weekdaysDiv.className = "days";
    ["Mo", "Di", "Mi", "Do", "Fr", "Sa", "So"].forEach(d => {
      const wd = document.createElement("div");
      wd.style.fontWeight = "bold";
      wd.style.textAlign = "center";
      wd.textContent = d;
      weekdaysDiv.appendChild(wd);
    });
    calendarContainer.appendChild(weekdaysDiv);

    // Tage f√ºllen
    const daysDiv = document.createElement("div");
    daysDiv.className = "days";

    // Leerfelder vor dem ersten Tag (Montag = 1)
    for(let i=1; i < startWeekday; i++) {
      const emptyDiv = document.createElement("div");
      emptyDiv.className = "day disabled";
      daysDiv.appendChild(emptyDiv);
    }

    // Tage rendern
    for(let d=1; d<=daysInMonth; d++) {
      const dateStr = `${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
      const dayDiv = document.createElement("div");
      dayDiv.className = "day";
      dayDiv.textContent = d;

      // Blockiert?
      if(blockedDays.includes(dateStr)) {
        dayDiv.classList.add("blocked");
      }
      // Gebucht?
      if(bookings.some(b => dateInRange(dateStr, b.startDate, b.endDate))) {
        dayDiv.classList.add("booked");
      }

      // Klick nur wenn frei
      if(!dayDiv.classList.contains("blocked") && !dayDiv.classList.contains("booked")) {
        dayDiv.onclick = () => onDayClick(dateStr);
      }

      daysDiv.appendChild(dayDiv);
    }

    calendarContainer.appendChild(daysDiv);
  }

  // Jahres√ºbersicht: alle Monate im Jahr anzeigen, mit farblicher Markierung der belegten/blockierten Tage
  function renderYearCalendar(year) {
    const container = document.createElement("div");
    container.style.display = "grid";
    container.style.gridTemplateColumns = "repeat(3, 1fr)";
    container.style.gap = "20px";

    for(let m=0; m<12; m++) {
      const monthDiv = document.createElement("div");
      monthDiv.style.background = "rgba(0,0,0,0.3)";
      monthDiv.style.borderRadius = "8px";
      monthDiv.style.padding = "10px";

      const monthName = new Date(year, m, 1).toLocaleString("de-DE", {month:"long"});
      const title = document.createElement("h4");
      title.textContent = monthName;
      title.style.textAlign = "center";
      monthDiv.appendChild(title);

      // Tage 1-31 (max)
      const daysGrid = document.createElement("div");
      daysGrid.style.display = "grid";
      daysGrid.style.gridTemplateColumns = "repeat(7, 1fr)";
      daysGrid.style.gap = "2px";

      // Wochentage als √úberschrift
      ["Mo","Di","Mi","Do","Fr","Sa","So"].forEach(wd => {
        const wdDiv = document.createElement("div");
        wdDiv.style.fontWeight = "bold";
        wdDiv.style.fontSize = "0.75rem";
        wdDiv.style.textAlign = "center";
        wdDiv.textContent = wd;
        daysGrid.appendChild(wdDiv);
      });

      const daysInMonth = new Date(year,m+1,0).getDate();
      const firstDay = new Date(year,m,1);
      let startWeekday = firstDay.getDay() || 7;

      // Leere Felder vor Monatstart
      for(let i=1; i<startWeekday; i++) {
        const emptyDiv = document.createElement("div");
        emptyDiv.style.height = "18px";
        daysGrid.appendChild(emptyDiv);
      }

      for(let d=1; d<=daysInMonth; d++) {
        const dateStr = `${year}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
        const dayDiv = document.createElement("div");
        dayDiv.textContent = d;
        dayDiv.style.fontSize = "0.8rem";
        dayDiv.style.textAlign = "center";
        dayDiv.style.borderRadius = "4px";
        dayDiv.style.padding = "2px";

        if(blockedDays.includes(dateStr)) {
          dayDiv.style.backgroundColor = "#ff4c4c";
          dayDiv.style.color = "white";
        } else if(bookings.some(b => dateInRange(dateStr, b.startDate, b.endDate))) {
          dayDiv.style.backgroundColor = "#4caf5080";
          dayDiv.style.color = "white";
        } else {
          dayDiv.style.backgroundColor = "rgba(255,255,255,0.1)";
          dayDiv.style.color = "white";
        }

        daysGrid.appendChild(dayDiv);
      }
      monthDiv.appendChild(daysGrid);
      container.appendChild(monthDiv);
    }

    calendarContainer.appendChild(container);
  }

  function dateInRange(dateStr, start, end) {
    return (dateStr >= start && dateStr <= end);
  }

  // Beim Tag-Klick f√ºr Buchungsstart/-ende
  function onDayClick(dateStr) {
    if(selectingStartDate) {
      startDateInput.value = dateStr;
      endDateInput.value = "";
      selectingStartDate = false;
      bookingMsg.textContent = "Bitte Enddatum w√§hlen.";
    } else {
      if(dateStr < startDateInput.value) {
        bookingMsg.textContent = "Enddatum darf nicht vor Startdatum liegen!";
        return;
      }
      endDateInput.value = dateStr;
      selectingStartDate = true;
      bookingMsg.textContent = "";
    }
  }

  // Freundelogin - direkt ohne Passwort
  friendLoginBtn.onclick = () => {
    loginBox.style.display = "none";
    content.style.display = "block";
    adminSection.style.display = "none";
    errorP.textContent = "";
    renderCalendar();
  };

  // Adminlogin mit Passwort
  adminLoginBtn.onclick = () => {
    const pwd = document.getElementById("admin-password").value;
    if(pwd === ADMIN_PASSWORD) {
      loginBox.style.display = "none";
      content.style.display = "none";
      adminSection.style.display = "block";
      errorP.textContent = "";
      renderAdminBookings();
      renderCalendar();
    } else {
      errorP.textContent = "Falsches Passwort!";
    }
  };

  adminLogoutBtn.onclick = () => {
    adminSection.style.display = "none";
    content.style.display = "none";
    loginBox.style.display = "block";
    bookingMsg.textContent = "";
    adminMsg.textContent = "";
    adminError.textContent = "";
    clearBookingForm();
  };

  // Kalenderansicht wechseln
  monthViewBtn.onclick = () => {
    viewMode = "month";
    renderCalendar();
  };
  yearViewBtn.onclick = () => {
    viewMode = "year";
    renderCalendar();
  };

  // Buchung speichern
  bookingForm.onsubmit = (e) => {
    e.preventDefault();

    // Validieren
    if(!startDateInput.value || !endDateInput.value) {
      bookingMsg.style.color = "#ff6b6b";
      bookingMsg.textContent = "Bitte Start- und Enddatum ausw√§hlen!";
      return;
    }
    if(endDateInput.value < startDateInput.value) {
      bookingMsg.style.color = "#ff6b6b";
      bookingMsg.textContent = "Enddatum darf nicht vor Startdatum liegen!";
      return;
    }

    // Pr√ºfen, ob Tage blockiert oder gebucht sind
    let curDate = parseDate(startDateInput.value);
    const lastDate = parseDate(endDateInput.value);

    while(curDate <= lastDate) {
      const dateStr = formatDate(curDate);
      if(blockedDays.includes(dateStr)) {
        bookingMsg.style.color = "#ff6b6b";
        bookingMsg.textContent = `Tag ${dateStr} ist blockiert!`;
        return;
      }
      if(bookings.some(b => dateInRange(dateStr, b.startDate, b.endDate))) {
        bookingMsg.style.color = "#ff6b6b";
        bookingMsg.textContent = `Tag ${dateStr} ist bereits gebucht!`;
        return;
      }
      curDate.setDate(curDate.getDate() + 1);
    }

    // Daten sammeln
    const newBooking = {
      id: Date.now(),
      name: nameInput.value.trim(),
      persons: personsInput.value,
      breakfast: breakfastInput.value,
      arrival: arrivalInput.value || "nicht angegeben",
      departure: departureInput.value || "nicht angegeben",
      startDate: startDateInput.value,
      endDate: endDateInput.value,
    };

    bookings.push(newBooking);
    localStorage.setItem("bookings", JSON.stringify(bookings));

    // E-Mail senden via formsubmit.co (Formular wird daf√ºr genutzt)
    fetch("https://formsubmit.co/ajax/pauldippmann@gmail.com", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        name: newBooking.name,
        persons: newBooking.persons,
        breakfast: newBooking.breakfast,
        arrival: newBooking.arrival,
        departure: newBooking.departure,
        startDate: newBooking.startDate,
        endDate: newBooking.endDate,
        _subject: "Neue √úbernachtungsbuchung von Freunden"
      })
    }).then(r => {
      if(r.ok) {
        bookingMsg.style.color = "#a3ffa3";
        bookingMsg.textContent = "Buchung erfolgreich gespeichert und E-Mail gesendet!";
        clearBookingForm();
        renderCalendar();
      } else {
        bookingMsg.style.color = "#ff6b6b";
        bookingMsg.textContent = "Buchung gespeichert, aber E-Mail konnte nicht gesendet werden.";
      }
    }).catch(() => {
      bookingMsg.style.color = "#ff6b6b";
      bookingMsg.textContent = "Buchung gespeichert, aber E-Mail konnte nicht gesendet werden.";
    });
  };

  function clearBookingForm() {
    bookingForm.reset();
    startDateInput.value = "";
    endDateInput.value = "";
    selectingStartDate = true;
  }

  // Admin: Buchungen anzeigen
  function renderAdminBookings() {
    bookingsTbody.innerHTML = "";
    if(bookings.length === 0) {
      bookingsTbody.innerHTML = "<tr><td colspan='8'>Keine Buchungen vorhanden.</td></tr>";
      return;
    }
    bookings.forEach(b => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(b.name)}</td>
        <td>${b.persons}</td>
        <td>${escapeHtml(b.breakfast)}</td>
        <td>${escapeHtml(b.arrival)}</td>
        <td>${escapeHtml(b.departure)}</td>
        <td>${b.startDate}</td>
        <td>${b.endDate}</td>
        <td><button data-id="${b.id}" class="delete-booking-btn" style="background:#c62828; color:white; border:none; padding:5px 8px; border-radius:5px; cursor:pointer;">L√∂schen</button></td>
      `;
      bookingsTbody.appendChild(tr);
    });

    // L√∂schen-Buttons Event
    document.querySelectorAll(".delete-booking-btn").forEach(btn => {
      btn.onclick = () => {
        const id = parseInt(btn.getAttribute("data-id"));
        bookings = bookings.filter(b => b.id !== id);
        localStorage.setItem("bookings", JSON.stringify(bookings));
        adminMsg.style.color = "#a3ffa3";
        adminMsg.textContent = "Buchung gel√∂scht.";
        renderAdminBookings();
        renderCalendar();
      };
    });
  }

  // Admin: Tage blockieren/freigeben
  blockDayForm.onsubmit = (e) => {
    e.preventDefault();
    const dayToBlock = blockDayInput.value;
    if(!dayToBlock) return;

    if(blockedDays.includes(dayToBlock)) {
      blockedDays = blockedDays.filter(d => d !== dayToBlock);
      adminMsg.style.color = "#a3ffa3";
      adminMsg.textContent = `Tag ${dayToBlock} freigegeben.`;
    } else {
      blockedDays.push(dayToBlock);
      adminMsg.style.color = "#a3ffa3";
      adminMsg.textContent = `Tag ${dayToBlock} blockiert.`;
    }
    localStorage.setItem("blockedDays", JSON.stringify(blockedDays));
    blockDayInput.value = "";
    renderCalendar();
  };

  // Hilfsfunktionen
  function parseDate(str) {
    const [y,m,d] = str.split("-").map(Number);
    return new Date(y,m-1,d);
  }
  function formatDate(date) {
    return date.toISOString().slice(0,10);
  }
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, function(m) {
      return ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[m];
    });
  }

  renderCalendar();
})();  
</script>

<style>
  /* Grundlayout und Stile f√ºr Kalender */
  .calendar-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  .days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
  }
  .day {
    background-color: rgba(255,255,255,0.1);
    border-radius: 6px;
    padding: 8px;
    text-align: center;
    cursor: pointer;
    user-select: none;
  }
  .day.blocked {
    background-color: #ff4c4c;
    color: white;
    cursor: not-allowed;
  }
  .day.booked {
    background-color: #4caf5080;
    color: white;
    cursor: not-allowed;
  }
  .day.disabled {
    background-color: transparent;
    cursor: default;
  }
  h3, h4 {
    margin: 5px 0;
  }
</style>

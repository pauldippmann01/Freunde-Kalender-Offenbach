<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Freunde Kalender Offenbach</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* Reset und Booking.com-Design */
:root {
  --primary-blue: #0071c2;
  --secondary-blue: #00589d;
  --text-dark: #333;
  --text-light: #fff;
  --bg-light: #f3f3f3;
  --bg-white: #fff;
  --border-grey: #e8e8e8;
  --booked-red: #f44336;
  --blocked-cherry: #b71c1c;
  --selected-green: #4caf50;
  --selected-green-light: #81c784;
}

body, html {
  margin: 0; padding: 0; height: 100%;
  font-family: 'Open Sans', sans-serif;
  background-color: var(--bg-light);
  color: var(--text-dark);
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}
main {
  flex-grow: 1;
  background-color: var(--bg-light);
  padding: 20px;
  overflow-y: auto;
}
h1, h2, h3 {
  margin: 0 0 10px 0;
  text-align: center;
  color: var(--text-dark);
}
button {
  cursor: pointer;
  border: none;
  border-radius: 4px;
  padding: 10px 20px;
  margin: 5px;
  background-color: var(--primary-blue);
  color: var(--text-light);
  font-weight: 600;
  transition: background-color 0.2s ease;
}
button:hover {
  background-color: var(--secondary-blue);
}
input, select {
  padding: 10px;
  margin: 5px 0 15px 0;
  border-radius: 4px;
  border: 1px solid var(--border-grey);
  width: 100%;
  box-sizing: border-box;
}
label {
  font-weight: 600;
  display: block;
  margin-bottom: 5px;
}
#error-msg {
  color: var(--booked-red);
  text-align: center;
  margin-bottom: 10px;
}

/* Navigation */
nav {
  background-color: var(--primary-blue);
  padding: 10px 20px;
  text-align: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
nav button {
  background: none;
  color: var(--text-light);
  border: 1px solid transparent;
}
nav button:hover {
  background: rgba(255,255,255,0.2);
  border: 1px solid rgba(255,255,255,0.5);
}

/* Kalender Styles */
.calendar-container {
  max-width: 100%;
  margin: 20px auto;
  background-color: var(--bg-white);
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}
.calendar-header h2 {
  margin: 0;
}
.month-nav button {
  font-size: 18px;
  padding: 5px 10px;
  background: none;
  color: var(--primary-blue);
}
.month-nav button:hover {
  background: rgba(0,0,0,0.05);
}
table.calendar {
  border-collapse: collapse;
  width: 100%;
  background-color: var(--bg-white);
  border-radius: 8px;
}
table.calendar th, table.calendar td {
  width: 14.2857%;
  padding: 12px;
  text-align: center;
  vertical-align: middle;
  border: 1px solid var(--border-grey);
  transition: background-color 0.2s ease;
}
table.calendar td {
  cursor: pointer;
}
table.calendar th {
  background-color: var(--bg-light);
  font-weight: 700;
}
table.calendar td.inactive {
  color: #ccc;
  cursor: default;
  background-color: #f9f9f9;
}
table.calendar td:not(.inactive):hover {
  background-color: #f0f0f0;
}
table.calendar td.booked {
  background-color: var(--booked-red);
  color: var(--text-light);
}
table.calendar td.blocked {
  background-color: var(--blocked-cherry);
  color: var(--text-light);
}
table.calendar td.selected-start,
table.calendar td.selected-end {
  border: 2px solid var(--selected-green);
  background-color: var(--selected-green-light) !important;
  color: var(--text-light) !important;
}
table.calendar td.selected-range {
  background-color: var(--selected-green-light);
  color: var(--text-light);
}

/* Tooltip (Maus-Hover) */
.tooltip {
  position: relative;
  display: inline-block;
}
.tooltip .tooltiptext {
  visibility: hidden;
  width: 120px;
  background-color: #555;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 5px 0;
  position: absolute;
  z-index: 1;
  bottom: 125%; /* Positionierung √ºber dem Element */
  left: 50%;
  margin-left: -60px;
  opacity: 0;
  transition: opacity 0.3s;
}
.tooltip .tooltiptext::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 50%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: #555 transparent transparent transparent;
}
.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}

/* Kalender-Legende */
#calendar-legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 20px;
    font-size: 0.9em;
    padding: 10px;
    border-radius: 4px;
    background-color: var(--bg-white);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.legend-item {
    display: flex;
    align-items: center;
    color: var(--text-dark);
}
.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    margin-right: 8px;
}

/* Formular Styles */
form {
  max-width: 500px;
  margin: 0 auto 30px auto;
  background-color: var(--bg-white);
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.form-row {
  margin-bottom: 15px;
}
.optional-label {
  font-size: 0.9em;
  color: #777;
}

/* Login Box */
#login-box {
  max-width: 400px;
  margin: 40px auto;
  background-color: var(--bg-white);
  padding: 30px;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  text-align: center;
}
#login-box h2 {
  color: var(--primary-blue);
  margin-bottom: 15px;
}

/* Admin Bereich */
#admin-area {
  max-width: 900px;
  margin: 0 auto;
}
#admin-bookings-list {
  max-height: 300px;
  overflow-y: auto;
  background-color: var(--bg-white);
  padding: 10px;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  margin-bottom: 20px;
}
#admin-bookings-list table {
  width: 100%;
  border-collapse: collapse;
  color: var(--text-dark);
}
#admin-bookings-list th, #admin-bookings-list td {
  padding: 10px;
  border: 1px solid var(--border-grey);
  text-align: center;
}
#admin-bookings-list th {
  background-color: var(--bg-light);
}

/* Jahreskalender */
#yearly-calendar-content {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
}
#yearly-calendar-content .calendar {
    flex-grow: 1;
    max-width: 220px; /* Monatskalender in der Jahresansicht etwas kleiner */
    font-size: 10px;
}
#yearly-calendar-content .calendar th, #yearly-calendar-content .calendar td {
    padding: 8px;
}
#yearly-calendar-content .calendar .tooltiptext {
    width: 80px;
    left: 50%;
    margin-left: -40px;
}

/* Responsive */
@media (max-width: 600px) {
  table.calendar th, table.calendar td {
    padding: 8px;
    font-size: 10px;
  }
  form {
    width: 95%;
  }
}
</style>
</head>
<body>
<nav>
  <button id="btn-to-start" style="display:none;">üè† Startseite</button>
  <button id="btn-show-friend-login">üßë Freunde Login</button>
  <button id="btn-show-admin-login">üîë Admin Login</button>
</nav>

<main>
  <section id="start-page">
    <h1 style="color: var(--primary-blue);">Willkommen im Freunde Kalender Offenbach</h1>
    <p style="text-align:center; max-width:600px; margin:auto; color:var(--text-dark);">
      Hier kannst du als Freund deine √úbernachtung buchen.<br />
      Oder als Admin den Kalender verwalten.
    </p>
  </section>

  <section id="friend-login" style="display:none;">
    <div id="login-box">
      <h2>Freunde Login</h2>
      <p>Bitte Passwort eingeben:</p>
      <input type="password" id="friend-password" placeholder="Passwort" />
      <div id="error-msg"></div>
      <button id="friend-login-btn">Einloggen</button>
      <button id="btn-back-from-friend-login">Zur√ºck</button>
    </div>
  </section>

  <section id="friend-area" style="display:none; max-width: 900px; margin: 0 auto;">
    <h2 style="color: var(--primary-blue);">Jahreskalender (Belegte Tage)</h2>
    <div style="text-align:center;">
      <button id="year-prev" style="background-color: var(--secondary-blue);">&lt; Vorjahr</button>
      <span id="year-display" style="font-weight: 700; margin: 0 15px; font-size: 1.2em;"></span>
      <button id="year-next" style="background-color: var(--secondary-blue);">N√§chstes Jahr &gt;</button>
    </div>
    
    <div id="calendar-legend">
      <div class="legend-item">
        <div class="legend-color" style="background-color: var(--booked-red);"></div>
        <span>Gebuchte Tage</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: var(--blocked-cherry);"></div>
        <span>Blockierte Tage</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: var(--selected-green-light);"></div>
        <span>Ausgew√§hlter Zeitraum</span>
      </div>
    </div>
    
    <div id="yearly-calendar-content" style="margin-top:20px;"></div>

    <form id="booking-form" style="display:none;">
      <h3>Buchungsdetails</h3>
      <div class="form-row">
        <label for="book-name">Name *</label>
        <input type="text" id="book-name" required />
      </div>
      <div class="form-row">
        <label for="book-persons">Anzahl Personen *</label>
        <input type="number" id="book-persons" min="1" value="1" required />
      </div>
      <div class="form-row">
        <label for="book-breakfast">Fr√ºhst√ºck ben√∂tigt? *</label>
        <select id="book-breakfast" required>
          <option value="ja">Ja</option>
          <option value="nein" selected>Nein</option>
        </select>
      </div>
      <div class="form-row">
        <label for="book-arrival-time">Anreise Uhrzeit <span class="optional-label">(optional)</span></label>
        <input type="time" id="book-arrival-time" />
      </div>
      <div class="form-row">
        <label for="book-departure-time">Abreise Uhrzeit <span class="optional-label">(optional)</span></label>
        <input type="time" id="book-departure-time" />
      </div>
      <div class="form-row">
        <label for="book-start-date">Startdatum *</label>
        <input type="date" id="book-start-date" required />
      </div>
      <div class="form-row">
        <label for="book-end-date">Enddatum *</label>
        <input type="date" id="book-end-date" required />
      </div>
      <div id="booking-error" style="color:var(--booked-red); font-weight:bold; margin-bottom:10px;"></div>
      <button type="submit" style="background-color: var(--selected-green);">Buchung abschicken</button>
      <button type="button" id="btn-cancel-booking-form" style="background-color: #d9534f;">Abbrechen</button>
    </form>
  </section>

  <section id="admin-login" style="display:none;">
    <div id="login-box">
      <h2>Admin Login</h2>
      <p>Bitte Admin-Passwort eingeben:</p>
      <input type="password" id="admin-password" placeholder="Admin Passwort" />
      <div id="error-msg"></div>
      <button id="admin-login-btn">Einloggen</button>
      <button id="btn-back-from-admin-login">Zur√ºck</button>
    </div>
  </section>

  <section id="admin-area" style="display:none;">
    <h2 style="color: var(--primary-blue);">Admin Bereich</h2>
    <div style="margin-bottom: 20px; text-align: center;">
      <button id="btn-logout-admin" style="background-color: #d9534f;">Admin Logout</button>
      <button id="btn-export-csv" style="background-color: var(--selected-green);">Exportiere Buchungen (CSV)</button>
    </div>
    <h3>Belegte und Blockierte Tage</h3>
    <div id="admin-bookings-list"></div>
    <h3>Tage blockieren/freigeben</h3>
    <form id="block-days-form">
      <div class="form-row">
        <label for="block-start-date">Startdatum *</label>
        <input type="date" id="block-start-date" required />
      </div>
      <div class="form-row">
        <label for="block-end-date">Enddatum *</label>
        <input type="date" id="block-end-date" required />
      </div>
      <div id="block-error" style="color:var(--booked-red); font-weight:bold; margin-bottom:10px;"></div>
      <button type="submit">Tage blockieren</button>
      <button type="button" id="btn-unblock-days" style="background-color: var(--blocked-cherry);">Tage freigeben</button>
    </form>
  </section>
</main>

<script>
(() => {
  // Passw√∂rter
  const FRIEND_PASSWORD = "test";
  const ADMIN_PASSWORD = "test";

  // Kalender Start & Ende
  const CAL_START_YEAR = 2025;
  const CAL_START_MONTH = 8; // September (0-basierend)
  const CAL_END_YEAR = 2040;
  const CAL_END_MONTH = 11; // Dezember

  // State
  let currentYear;
  let selectedStartDate = null;
  let selectedEndDate = null;
  let selectedStartMonth = null;
  let selectedEndMonth = null;

  // Buchungen und Blockierungen werden in localStorage gespeichert
  const STORAGE_BOOKINGS = "offenbach_bookings";
  const STORAGE_BLOCKS = "offenbach_blocks";

  // Utility
  function saveBookings(bookings) {
    localStorage.setItem(STORAGE_BOOKINGS, JSON.stringify(bookings));
  }
  function loadBookings() {
    const data = localStorage.getItem(STORAGE_BOOKINGS);
    return data ? JSON.parse(data) : [];
  }
  function saveBlocks(blocks) {
    localStorage.setItem(STORAGE_BLOCKS, JSON.stringify(blocks));
  }
  function loadBlocks() {
    const data = localStorage.getItem(STORAGE_BLOCKS);
    return data ? JSON.parse(data) : [];
  }
  function formatDate(d) {
    return d.toISOString().slice(0,10);
  }
  function dateFromStr(s) {
    if (!s) return null;
    const [year, month, day] = s.split('-').map(Number);
    return new Date(year, month - 1, day);
  }
  function checkOverlap(startA, endA, startB, endB) {
    return !(endA < startB || startA > endB);
  }
  function getBookingsForDate(dateStr) {
    const bookings = loadBookings();
    return bookings.find(bk => checkOverlap(dateStr, dateStr, bk.startDate, bk.endDate));
  }

  // -------------------
  // Navigation & Sections
  // -------------------
  const sections = {
    start: document.getElementById("start-page"),
    friendLogin: document.getElementById("friend-login"),
    friendArea: document.getElementById("friend-area"),
    adminLogin: document.getElementById("admin-login"),
    adminArea: document.getElementById("admin-area"),
  };

  function showSection(name) {
    Object.values(sections).forEach(sec => sec.style.display = "none");
    sections[name].style.display = "block";

    const btnToStart = document.getElementById("btn-to-start");
    if(name !== "start") {
      btnToStart.style.display = "inline-block";
    } else {
      btnToStart.style.display = "none";
    }
  }

  document.getElementById("btn-show-friend-login").onclick = () => {
    document.getElementById("error-msg").textContent = "";
    document.getElementById("friend-password").value = "";
    showSection("friendLogin");
  };
  document.getElementById("btn-show-admin-login").onclick = () => {
    document.getElementById("error-msg").textContent = "";
    document.getElementById("admin-password").value = "";
    showSection("adminLogin");
  };
  document.getElementById("btn-to-start").onclick = () => {
    showSection("start");
  };
  document.getElementById("btn-back-from-friend-login").onclick = () => {
    showSection("start");
  };
  document.getElementById("btn-back-from-admin-login").onclick = () => {
    showSection("start");
  };

  // --------------
  // Freund Login
  // --------------
  document.getElementById("friend-login-btn").onclick = () => {
    const pw = document.getElementById("friend-password").value;
    if(pw === FRIEND_PASSWORD) {
      showSection("friendArea");
      resetBookingForm();
      renderYearlyCalendar(currentYear);
    } else {
      document.getElementById("error-msg").textContent = "Falsches Passwort!";
    }
  };

  // --------------
  // Admin Login
  // --------------
  document.getElementById("admin-login-btn").onclick = () => {
    const pw = document.getElementById("admin-password").value;
    if(pw === ADMIN_PASSWORD) {
      showSection("adminArea");
      renderAdminBookings();
      document.getElementById("error-msg").textContent = "";
    } else {
      document.getElementById("error-msg").textContent = "Falsches Admin-Passwort!";
    }
  };

  // Admin Logout
  document.getElementById("btn-logout-admin").onclick = () => {
    showSection("start");
  };
  
  // -----------------------
  // Jahreskalender √úbersicht (als Hauptansicht)
  // -----------------------
  const yearlyCalendarContent = document.getElementById("yearly-calendar-content");
  const yearDisplay = document.getElementById("year-display");

  document.getElementById("year-prev").onclick = () => {
    if(currentYear > CAL_START_YEAR) {
      currentYear--;
      renderYearlyCalendar(currentYear);
    }
  };
  document.getElementById("year-next").onclick = () => {
    if(currentYear < CAL_END_YEAR) {
      currentYear++;
      renderYearlyCalendar(currentYear);
    }
  };

  function renderYearlyCalendar(year) {
    yearDisplay.textContent = year;
    yearlyCalendarContent.innerHTML = "";

    const bookings = loadBookings();
    const blocks = loadBlocks();

    const monthNames = [
      "Januar","Februar","M√§rz","April","Mai","Juni",
      "Juli","August","September","Oktober","November","Dezember"
    ];

    for(let m=0; m<12; m++) {
      const firstDay = new Date(year, m, 1);
      const lastDay = new Date(year, m+1, 0);
      const daysInMonth = lastDay.getDate();

      let monthHtml = `<table class="calendar" data-month="${m}" data-year="${year}">`;
      monthHtml += `<thead><tr><th colspan="7">${monthNames[m]}</th></tr>`;
      monthHtml += `<tr><th>M</th><th>D</th><th>M</th><th>D</th><th>F</th><th>S</th><th>S</th></tr></thead><tbody><tr>`;

      const startWeekday = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
      for(let i=0; i<startWeekday; i++) {
        monthHtml += `<td class="inactive"></td>`;
      }
      for(let day=1; day<=daysInMonth; day++) {
        const date = new Date(year, m, day);
        const dateStr = formatDate(date);
        let classes = "";
        let tooltip = "";

        const bookedEntry = getBookingsForDate(dateStr);
        if(blocks.some(b => checkOverlap(dateStr, dateStr, b.startDate, b.endDate))) {
          classes = "blocked";
        } else if(bookedEntry) {
          classes = "booked";
          tooltip = bookedEntry.name;
        } else if (selectedStartDate && selectedEndDate) {
            const s = dateFromStr(formatDate(selectedStartDate < selectedEndDate ? selectedStartDate : selectedEndDate));
            const e = dateFromStr(formatDate(selectedEndDate > selectedStartDate ? selectedEndDate : selectedStartDate));
            const d = dateFromStr(dateStr);
            if (d.getTime() === s.getTime()) {
                classes = "selected-start";
            } else if (d.getTime() === e.getTime()) {
                classes = "selected-end";
            } else if (d > s && d < e) {
                classes = "selected-range";
            }
        } else if (selectedStartDate && formatDate(selectedStartDate) === dateStr) {
            classes = "selected-start";
        }

        let cellContent = day;
        if (tooltip) {
          monthHtml += `<td class="${classes} tooltip" data-date="${dateStr}">${cellContent}<span class="tooltiptext">${tooltip}</span></td>`;
        } else {
          monthHtml += `<td class="${classes}" data-date="${dateStr}">${cellContent}</td>`;
        }

        if((startWeekday + day) % 7 === 0) {
          monthHtml += "</tr><tr>";
        }
      }
      monthHtml += "</tr></tbody></table>";
      yearlyCalendarContent.insertAdjacentHTML("beforeend", monthHtml);
    }
    attachDateClickHandlers();
    showBookingForm();
  }

  // ---------------------
  // Datums- und Bereichsauswahl
  // ---------------------
  
  function attachDateClickHandlers() {
    const cells = document.querySelectorAll("#yearly-calendar-content td:not(.inactive)");
    cells.forEach(cell => {
      cell.style.cursor = "pointer";
      cell.onclick = () => {
        const dateStr = cell.getAttribute("data-date");
        const date = dateFromStr(dateStr);

        if(cell.classList.contains('booked') || cell.classList.contains('blocked')) {
            return;
        }

        if(!selectedStartDate || (selectedStartDate && selectedEndDate)) {
          selectedStartDate = date;
          selectedEndDate = null;
        } else {
          if(date < selectedStartDate) {
            selectedEndDate = selectedStartDate;
            selectedStartDate = date;
          } else {
            selectedEndDate = date;
          }
        }

        // Finde den Monat und Jahr der Auswahl und rendere nur diese
        const sMonth = selectedStartDate.getMonth();
        const sYear = selectedStartDate.getFullYear();
        const eMonth = selectedEndDate ? selectedEndDate.getMonth() : sMonth;
        const eYear = selectedEndDate ? selectedEndDate.getFullYear() : sYear;
        
        renderYearlyCalendar(currentYear);
        showBookingForm();
      };
    });
  }

  // ---------------------
  // Buchungsformular
  // ---------------------
  const bookingForm = document.getElementById("booking-form");
  const bookStartInput = document.getElementById("book-start-date");
  const bookEndInput = document.getElementById("book-end-date");
  const bookNameInput = document.getElementById("book-name");
  const bookPersonsInput = document.getElementById("book-persons");
  const bookBreakfastInput = document.getElementById("book-breakfast");
  const bookArrivalInput = document.getElementById("book-arrival-time");
  const bookDepartureInput = document.getElementById("book-departure-time");
  const bookingError = document.getElementById("booking-error");

  function showBookingForm() {
    if(!selectedStartDate) {
      bookingForm.style.display = "none";
      return;
    }
    bookStartInput.value = formatDate(selectedStartDate);
    bookEndInput.value = selectedEndDate ? formatDate(selectedEndDate) : formatDate(selectedStartDate);
    bookingError.textContent = "";
    bookingForm.style.display = "block";
    bookNameInput.focus();
  }
  function resetBookingForm() {
    selectedStartDate = null;
    selectedEndDate = null;
    renderYearlyCalendar(currentYear);
    bookingForm.style.display = "none";
    bookingError.textContent = "";
    bookingForm.reset && bookingForm.reset();
  }
  document.getElementById("btn-cancel-booking-form").onclick = () => {
    resetBookingForm();
  };

  bookingForm.onsubmit = (e) => {
    e.preventDefault();
    const name = bookNameInput.value.trim();
    const persons = parseInt(bookPersonsInput.value);
    const breakfast = bookBreakfastInput.value;
    const arrival = bookArrivalInput.value || null;
    const departure = bookDepartureInput.value || null;
    const startDate = bookStartInput.value;
    const endDate = bookEndInput.value;

    bookingError.textContent = "";

    if(!name) {
      bookingError.textContent = "Bitte Name eingeben.";
      return;
    }
    if(!persons || persons < 1) {
      bookingError.textContent = "Bitte g√ºltige Anzahl Personen eingeben.";
      return;
    }
    if(!startDate || !endDate) {
      bookingError.textContent = "Bitte g√ºltige Start- und Enddaten eingeben.";
      return;
    }
    if(endDate < startDate) {
      bookingError.textContent = "Enddatum darf nicht vor Startdatum liegen.";
      return;
    }

    const bookings = loadBookings();
    const blocks = loadBlocks();

    for(let b of bookings) {
      if(checkOverlap(startDate, endDate, b.startDate, b.endDate)) {
        bookingError.textContent = `Der Zeitraum √ºberschneidet sich mit einer bestehenden Buchung (${b.name}: ${b.startDate} - ${b.endDate}).`;
        return;
      }
    }
    for(let b of blocks) {
      if(checkOverlap(startDate, endDate, b.startDate, b.endDate)) {
        bookingError.textContent = `Der Zeitraum √ºberschneidet sich mit einem blockierten Zeitraum (${b.startDate} - ${b.endDate}).`;
        return;
      }
    }

    const newBooking = {
      id: "b" + Date.now(),
      name,
      persons,
      breakfast,
      arrivalTime: arrival,
      departureTime: departure,
      startDate,
      endDate,
    };
    bookings.push(newBooking);
    saveBookings(bookings);

    alert("Buchung erfolgreich gespeichert!");
    resetBookingForm();
    renderYearlyCalendar(currentYear);
  };

  // -------------------
  // Admin Bereich
  // -------------------

  const adminBookingsList = document.getElementById("admin-bookings-list");

  function renderAdminBookings() {
    const bookings = loadBookings();
    const blocks = loadBlocks();

    let html = `<table><thead><tr><th>Typ</th><th>Name</th><th>Personen</th><th>Fr√ºhst√ºck</th><th>Anreise</th><th>Abreise</th><th>Startdatum</th><th>Enddatum</th><th>Aktion</th></tr></thead><tbody>`;

    bookings.forEach(bk => {
      html += `<tr>
        <td>Buchung</td>
        <td>${bk.name}</td>
        <td>${bk.persons}</td>
        <td>${bk.breakfast}</td>
        <td>${bk.arrivalTime || "-"}</td>
        <td>${bk.departureTime || "-"}</td>
        <td>${bk.startDate}</td>
        <td>${bk.endDate}</td>
        <td><button class="btn-delete-booking" data-id="${bk.id}" style="background-color: #d9534f; padding:5px 10px;">L√∂schen</button></td>
      </tr>`;
    });

    blocks.forEach((bl, idx) => {
      html += `<tr>
        <td>Blockiert</td>
        <td colspan="5" style="text-align:center;">-</td>
        <td>${bl.startDate}</td>
        <td>${bl.endDate}</td>
        <td><button class="btn-delete-block" data-idx="${idx}" style="background-color: #d9534f; padding:5px 10px;">Entfernen</button></td>
      </tr>`;
    });

    html += "</tbody></table>";

    adminBookingsList.innerHTML = html;

    document.querySelectorAll(".btn-delete-booking").forEach(btn => {
      btn.onclick = () => {
        if(confirm("Buchung wirklich l√∂schen?")) {
          const id = btn.getAttribute("data-id");
          deleteBooking(id);
        }
      };
    });
    document.querySelectorAll(".btn-delete-block").forEach(btn => {
      btn.onclick = () => {
        if(confirm("Blockierung wirklich entfernen?")) {
          const idx = parseInt(btn.getAttribute("data-idx"));
          deleteBlock(idx);
        }
      };
    });
  }

  function deleteBooking(id) {
    let bookings = loadBookings();
    bookings = bookings.filter(b => b.id !== id);
    saveBookings(bookings);
    renderAdminBookings();
    renderYearlyCalendar(currentYear);
  }
  function deleteBlock(idx) {
    let blocks = loadBlocks();
    blocks.splice(idx, 1);
    saveBlocks(blocks);
    renderAdminBookings();
    renderYearlyCalendar(currentYear);
  }

  // -------------------
  // Blockierungen Hinzuf√ºgen (Admin)
  // -------------------
  const blockStartInput = document.getElementById("block-start-date");
  const blockEndInput = document.getElementById("block-end-date");
  const blockError = document.getElementById("block-error");
  
  document.getElementById("block-days-form").onsubmit = (e) => {
    e.preventDefault();
    blockError.textContent = "";

    const startDate = blockStartInput.value;
    const endDate = blockEndInput.value;

    if(!startDate || !endDate) {
      blockError.textContent = "Bitte Start- und Enddatum angeben.";
      return;
    }
    if(endDate < startDate) {
      blockError.textContent = "Enddatum darf nicht vor Startdatum liegen.";
      return;
    }

    const bookings = loadBookings();
    const blocks = loadBlocks();

    for(let b of bookings) {
      if(checkOverlap(startDate, endDate, b.startDate, b.endDate)) {
        blockError.textContent = `Der Zeitraum √ºberschneidet sich mit einer bestehenden Buchung (${b.name}: ${b.startDate} - ${b.endDate}).`;
        return;
      }
    }
    for(let b of blocks) {
      if(checkOverlap(startDate, endDate, b.startDate, b.endDate)) {
        blockError.textContent = `Der Zeitraum √ºberschneidet sich mit einem bereits blockierten Zeitraum (${b.startDate} - ${b.endDate}).`;
        return;
      }
    }

    blocks.push({startDate, endDate});
    saveBlocks(blocks);
    alert("Blockierung erfolgreich hinzugef√ºgt!");
    document.getElementById("block-days-form").reset();
    renderAdminBookings();
    renderYearlyCalendar(currentYear);
  };
  
  function unblockDays(startDate, endDate) {
    let blocks = loadBlocks();
    const originalLength = blocks.length;
    blocks = blocks.filter(block => !checkOverlap(block.startDate, block.endDate, startDate, endDate));
    if (blocks.length === originalLength) {
      return false;
    }
    saveBlocks(blocks);
    return true;
  }
  
  document.getElementById("btn-unblock-days").onclick = () => {
    const startDate = blockStartInput.value;
    const endDate = blockEndInput.value;

    if (!startDate || !endDate) {
      alert("Bitte gib ein Start- und Enddatum zum Freigeben ein.");
      return;
    }
    
    if (confirm(`Sollen die Tage von ${startDate} bis ${endDate} wirklich freigegeben werden?`)) {
      const success = unblockDays(startDate, endDate);
      if (success) {
        alert("Tage erfolgreich freigegeben!");
        document.getElementById("block-days-form").reset();
        renderAdminBookings();
        renderYearlyCalendar(currentYear);
      } else {
        alert("Keine Blockierung im ausgew√§hlten Zeitraum gefunden.");
      }
    }
  };

  // CSV-Export-Funktion
  function exportBookingsToCsv() {
    const bookings = loadBookings();
    if (bookings.length === 0) {
      alert("Keine Buchungen zum Exportieren vorhanden.");
      return;
    }

    const csvRows = [];
    const headers = ["Name", "Personen", "Fr√ºhst√ºck", "Anreisezeit", "Abreisezeit", "Startdatum", "Enddatum"];
    csvRows.push(headers.join(';')); 

    for (const booking of bookings) {
      const row = [
        booking.name,
        booking.persons,
        booking.breakfast,
        booking.arrivalTime || "",
        booking.departureTime || "",
        booking.startDate,
        booking.endDate
      ];
      csvRows.push(row.join(';'));
    }

    const csvString = csvRows.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `Freunde_Buchungen_${new Date().toISOString().slice(0, 10)}.csv`;
    link.click();
  }
  
  document.getElementById("btn-export-csv").onclick = exportBookingsToCsv;

  // Initialanzeige
  function initialize() {
    const today = new Date();
    currentYear = today.getFullYear();
    currentMonth = today.getMonth();

    if (currentYear < CAL_START_YEAR) {
        currentYear = CAL_START_YEAR;
    } else if (currentYear > CAL_END_YEAR) {
        currentYear = CAL_END_YEAR;
    }
    
    showSection("start");
  }

  initialize();
})();
</script>
</body>
</html>
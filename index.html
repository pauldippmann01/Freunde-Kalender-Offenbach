<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Freunde Übernachtungs-Kalender</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Segoe+UI&display=swap');
  body {
    margin: 0; font-family: 'Segoe UI', sans-serif;
    background: url('https://upload.wikimedia.org/wikipedia/commons/5/58/Offenbach_mitten_in_der_Stadt.jpg') no-repeat center center/cover;
    min-height: 100vh; color: white;
    display: flex; flex-direction: column;
  }
  header {
    background: rgba(0,0,0,0.6);
    padding: 1em; text-align: center; font-weight: bold; font-size: 1.5em;
  }
  #login-box, #friend-area, #admin-area {
    background: rgba(0,0,0,0.6);
    max-width: 900px; margin: 1em auto; padding: 1em; border-radius: 12px;
  }
  input, select, button {
    font-size: 1em; margin: 0.3em 0;
    padding: 0.4em 0.6em; border-radius: 6px; border: none;
  }
  button {
    background-color: #4CAF50; color: white; cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover { background-color: #3e8e41; }
  .error { color: #ff6b6b; font-weight: bold; }
  .success { color: #a6e22e; font-weight: bold; }
  nav {
    text-align: center; margin: 1em 0;
  }
  nav button {
    margin: 0 0.5em;
  }
  table.calendar {
    width: 100%; border-collapse: collapse; margin-top: 1em; background: rgba(255,255,255,0.15);
    color: white;
    border-radius: 12px;
  }
  table.calendar th, table.calendar td {
    border: 1px solid rgba(255,255,255,0.3);
    text-align: center;
    padding: 0.5em;
    cursor: pointer;
    user-select: none;
  }
  table.calendar th {
    background: rgba(0,0,0,0.5);
  }
  table.calendar td.empty {
    background: transparent;
    cursor: default;
  }
  table.calendar td.booked {
    background: #d9534fcc;
    cursor: default;
  }
  table.calendar td.blocked {
    background: #6c757dcc;
    cursor: default;
  }
  table.calendar td.selected-start {
    background: #5bc0decc;
  }
  table.calendar td.selected-end {
    background: #5bc0decc;
  }
  table.calendar td.selected-range {
    background: #5bc0de88;
  }
  #booking-form label {
    display: block;
    margin-top: 0.5em;
  }
  #booking-form input[type="text"],
  #booking-form input[type="number"],
  #booking-form input[type="time"],
  #booking-form select {
    width: 100%;
  }
  #booking-msg {
    margin-top: 0.7em;
  }
  #admin-area {
    display: none;
  }
  #admin-login {
    max-width: 300px;
    margin: 0 auto;
  }
  #admin-login input {
    width: 100%;
  }
  #bookings-list {
    max-height: 300px;
    overflow-y: auto;
    margin-top: 1em;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    padding: 0.5em;
  }
  #bookings-list table {
    width: 100%;
    border-collapse: collapse;
  }
  #bookings-list th, #bookings-list td {
    border: 1px solid rgba(255,255,255,0.3);
    padding: 0.3em 0.5em;
    text-align: center;
    color: white;
  }
  #block-day-section {
    margin-top: 1em;
    background: rgba(255,255,255,0.1);
    padding: 1em;
    border-radius: 10px;
    color: white;
  }
  #admin-msg {
    margin-top: 0.5em;
    font-weight: bold;
  }
  footer {
    text-align: center;
    margin: 1em 0;
    color: #ddd;
    font-size: 0.8em;
  }
</style>
</head>
<body>

<header>Freunde Übernachtungs-Kalender - Offenbach</header>

<div id="login-box">
  <h2>Willkommen, Freund ✨</h2>
  <p>Bitte Passwort eingeben, um Zugang zu bekommen:</p>
  <input type="password" id="password" placeholder="Passwort" autocomplete="off" />
  <br />
  <button id="login-btn">Einloggen</button>
  <p id="login-error" class="error"></p>
</div>

<div id="main-content" style="display:none; max-width: 900px; margin: auto;">
  <nav>
    <button id="btn-friend-area">Freunde-Bereich</button>
    <button id="btn-admin-area">Admin-Bereich</button>
    <button id="btn-logout">Logout</button>
  </nav>

  <!-- Freunde-Bereich -->
  <section id="friend-area">
    <nav>
      <button id="view-monthly">Monatskalender</button>
      <button id="view-yearly">Jahreskalender</button>
    </nav>
    <div id="calendar-container"></div>

    <form id="booking-form" action="https://formsubmit.co/pauldippmann@gmail.com" method="POST" target="_blank" autocomplete="off">
      <h3>Buchung vornehmen</h3>
      <input type="hidden" name="_captcha" value="false" />
      <label for="name">Name (Pflicht):</label>
      <input type="text" id="name" name="Name" required />
      <label for="persons">Anzahl Personen (Pflicht):</label>
      <input type="number" id="persons" name="Personen" min="1" required />
      <label for="breakfast">Frühstück benötigt?</label>
      <select id="breakfast" name="Frühstück">
        <option value="Nein" selected>Nein</option>
        <option value="Ja">Ja</option>
      </select>
      <label for="arrival">Ankunftszeit (optional):</label>
      <input type="time" id="arrival" name="Ankunftszeit" />
      <label for="departure">Abfahrtszeit (optional):</label>
      <input type="time" id="departure" name="Abfahrtszeit" />
      <label>Zeitraum auswählen (Start- und Enddatum):</label>
      <p id="selected-dates" style="font-weight:bold; color:#a6e22e;">Keine Daten ausgewählt</p>
      <input type="hidden" name="Startdatum" id="hidden-start" />
      <input type="hidden" name="Enddatum" id="hidden-end" />
      <button type="submit">Buchen</button>
      <p id="booking-msg"></p>
    </form>
  </section>

  <!-- Admin-Bereich -->
  <section id="admin-area" style="display:none;">
    <h3>Admin-Bereich</h3>

    <div id="admin-login-section">
      <p>Bitte Admin-Passwort eingeben:</p>
      <input type="password" id="admin-password" autocomplete="off" />
      <button id="admin-login-btn">Login</button>
      <p id="admin-login-error" class="error"></p>
    </div>

    <div id="admin-dashboard" style="display:none;">
      <button id="admin-logout-btn" style="float:right; background:#b52a2a;">Logout Admin</button>
      <h4>Buchungen Übersicht</h4>
      <div id="bookings-list">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Personen</th>
              <th>Frühstück</th>
              <th>Ankunft</th>
              <th>Abreise</th>
              <th>Start</th>
              <th>Ende</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody id="bookings-tbody"></tbody>
        </table>
      </div>

      <div id="block-day-section">
        <h4>Tage blockieren/freigeben</h4>
        <input type="date" id="block-day-input" min="2025-09-01" max="2040-12-31" />
        <button id="block-day-btn">Blockieren</button>
        <button id="unblock-day-btn">Freigeben</button>
        <p id="admin-msg"></p>
      </div>

      <button id="export-csv-btn" style="margin-top:1em;">Buchungen als CSV exportieren</button>
    </div>
  </section>
</div>

<footer>© 2025 Offenbach Freunde Kalender</footer>

<script>
  // Allgemeine Variablen
  const PASSWORD = "OffenbachPaul123";
  const ADMIN_PASSWORD = "Admin2025!";
  const startYear = 2025, startMonth = 8; // September 2025 (0-indexed)
  const endYear = 2040, endMonth = 11;    // Dezember 2040 (0-indexed)

  // Elemente
  const loginBox = document.getElementById("login-box");
  const loginBtn = document.getElementById("login-btn");
  const loginError = document.getElementById("login-error");
  const mainContent = document.getElementById("main-content");

  const btnFriendArea = document.getElementById("btn-friend-area");
  const btnAdminArea = document.getElementById("btn-admin-area");
  const btnLogout = document.getElementById("btn-logout");

  const friendArea = document.getElementById("friend-area");
  const adminArea = document.getElementById("admin-area");

  // Kalender Variablen
  let currentYear = startYear;
  let currentMonth = startMonth;

  let bookings = JSON.parse(localStorage.getItem("bookings") || "[]");
  let blockedDays = JSON.parse(localStorage.getItem("blockedDays") || "[]");

  // Kalender Auswahl
  let selection = { start: null, end: null };

  // Login Funktion
  loginBtn.addEventListener("click", () => {
    const pw = document.getElementById("password").value.trim();
    if (pw === PASSWORD) {
      loginBox.style.display = "none";
      mainContent.style.display = "block";
      renderCalendar(currentYear, currentMonth);
      showFriendArea();
    } else {
      loginError.textContent = "❌ Falsches Passwort!";
    }
  });

  btnFriendArea.addEventListener("click", () => {
    showFriendArea();
  });
  btnAdminArea.addEventListener("click", () => {
    showAdminArea();
  });
  btnLogout.addEventListener("click", () => {
    location.reload();
  });

  function showFriendArea() {
    friendArea.style.display = "block";
    adminArea.style.display = "none";
  }
  function showAdminArea() {
    friendArea.style.display = "none";
    adminArea.style.display = "block";
    initAdmin();
  }

  // Kalender rendern Monats- und Jahresansicht
  const calendarContainer = document.getElementById("calendar-container");
  const btnMonthly = document.getElementById("view-monthly");
  const btnYearly = document.getElementById("view-yearly");

  btnMonthly.addEventListener("click", () => {
    renderCalendar(currentYear, currentMonth);
  });
  btnYearly.addEventListener("click", () => {
    renderYearlyCalendar(currentYear);
  });

  // Helferfunktionen Datum <-> String
  function ymdToStr(y, m, d) {
    return `${y}-${(m+1).toString().padStart(2,"0")}-${d.toString().padStart(2,"0")}`;
  }
  function strToDate(str) {
    return new Date(str+"T00:00:00");
  }

  function isDateBlocked(dateStr) {
    return blockedDays.includes(dateStr);
  }
  function isDateBooked(dateStr) {
    return bookings.some(b => (b.start <= dateStr && b.end >= dateStr));
  }

  // Kalender rendern (Monatsansicht)
  function renderCalendar(year, month) {
    currentYear = year;
    currentMonth = month;
    calendarContainer.innerHTML = "";

    // Monat und Jahr anzeigen mit Vor/Zurück Buttons
    const navDiv = document.createElement("div");
    navDiv.style.textAlign = "center";
    navDiv.style.marginBottom = "0.5em";

    const prevBtn = document.createElement("button");
    prevBtn.textContent = "◀";
    prevBtn.onclick = () => {
      let m = currentMonth - 1;
      let y = currentYear;
      if (m < startMonth && y <= startYear) return;
      if (m < 0) { m = 11; y--; if (y < startYear) return; }
      renderCalendar(y, m);
    };

    const nextBtn = document.createElement("button");
    nextBtn.textContent = "▶";
    nextBtn.onclick = () => {
      let m = currentMonth + 1;
      let y = currentYear;
      if (m > endMonth && y >= endYear) return;
      if (m > 11) { m = 0; y++; if (y > endYear) return; }
      renderCalendar(y, m);
    };

    const monthNames = ["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"];
    const monthLabel = document.createElement("span");
    monthLabel.textContent = `${monthNames[month]} ${year}`;
    monthLabel.style.fontWeight = "bold";
    monthLabel.style.margin = "0 1em";

    navDiv.appendChild(prevBtn);
    navDiv.appendChild(monthLabel);
    navDiv.appendChild(nextBtn);
    calendarContainer.appendChild(navDiv);

    const table = document.createElement("table");
    table.className = "calendar";

    // Wochentage Header
    const thead = document.createElement("thead");
    const headerRow = document.createElement("tr");
    ["So","Mo","Di","Mi","Do","Fr","Sa"].forEach(day => {
      const th = document.createElement("th");
      th.textContent = day;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    // Tage füllen
    const tbody = document.createElement("tbody");

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month+1, 0);
    const firstWeekday = firstDay.getDay();

    let dayNum = 1;
    let done = false;
    for(let row=0; row<6 && !done; row++) {
      const tr = document.createElement("tr");
      for(let col=0; col<7; col++) {
        const td = document.createElement("td");
        if(row === 0 && col < firstWeekday) {
          td.className = "empty";
          td.textContent = "";
          tr.appendChild(td);
          continue;
        }
        if(dayNum > lastDay.getDate()) {
          td.className = "empty";
          td.textContent = "";
          tr.appendChild(td);
          done = true;
          continue;
        }
        const dateStr = ymdToStr(year, month, dayNum);

        td.textContent = dayNum;

        if(isDateBlocked(dateStr)) td.classList.add("blocked");
        else if(isDateBooked(dateStr)) td.classList.add("booked");

        td.dataset.date = dateStr;

        // Klick Event für Auswahl Start/Enddatum
        td.onclick = () => {
          if(isDateBlocked(dateStr)) return;
          if(!selection.start || (selection.start && selection.end)) {
            selection.start = dateStr;
            selection.end = null;
          } else {
            if(dateStr < selection.start) {
              selection.end = selection.start;
              selection.start = dateStr;
            } else {
              selection.end = dateStr;
            }
          }
          highlightSelection();
          updateBookingFormDates();
        };

        tr.appendChild(td);
        dayNum++;
      }
      tbody.appendChild(tr);
    }

    table.appendChild(tbody);
    calendarContainer.appendChild(table);
  }

  // Hervorhebung Auswahl im Kalender
  function highlightSelection() {
    const tds = calendarContainer.querySelectorAll("td[data-date]");
    tds.forEach(td => {
      td.classList.remove("selected-start", "selected-end", "selected-range");
      const date = td.dataset.date;
      if(selection.start && selection.end) {
        if(date === selection.start) td.classList.add("selected-start");
        else if(date === selection.end) td.classList.add("selected-end");
        else if(date > selection.start && date < selection.end) td.classList.add("selected-range");
      } else if(selection.start) {
        if(date === selection.start) td.classList.add("selected-start");
      }
    });
  }

  // Update versteckte Felder für Formular
  function updateBookingFormDates() {
    const startInput = document.getElementById("hidden-start");
    const endInput = document.getElementById("hidden-end");
    const selDates = document.getElementById("selected-dates");
    if(selection.start && selection.end) {
      startInput.value = selection.start;
      endInput.value = selection.end;
      selDates.textContent = `${selection.start} bis ${selection.end}`;
    } else if(selection.start) {
      startInput.value = selection.start;
      endInput.value = "";
      selDates.textContent = `${selection.start}`;
    } else {
      startInput.value = "";
      endInput.value = "";
      selDates.textContent = "Keine Daten ausgewählt";
    }
  }

  // Jahreskalender anzeigen (nur Übersicht)
  function renderYearlyCalendar(year) {
    calendarContainer.innerHTML = "";
    currentYear = year;
    const navDiv = document.createElement("div");
    navDiv.style.textAlign = "center";
    navDiv.style.marginBottom = "0.5em";

    const prevBtn = document.createElement("button");
    prevBtn.textContent = "◀";
    prevBtn.onclick = () => {
      if (currentYear <= startYear) return;
      renderYearlyCalendar(currentYear -1);
    };

    const nextBtn = document.createElement("button");
    nextBtn.textContent = "▶";
    nextBtn.onclick = () => {
      if (currentYear >= endYear) return;
      renderYearlyCalendar(currentYear + 1);
    };

    const yearLabel = document.createElement("span");
    yearLabel.textContent = year;
    yearLabel.style.fontWeight = "bold";
    yearLabel.style.margin = "0 1em";

    navDiv.appendChild(prevBtn);
    navDiv.appendChild(yearLabel);
    navDiv.appendChild(nextBtn);
    calendarContainer.appendChild(navDiv);

    // 12 Monate anzeigen (nur Namen + Tage belegt/blockiert als kleine farbige Punkte)
    const monthsDiv = document.createElement("div");
    monthsDiv.style.display = "grid";
    monthsDiv.style.gridTemplateColumns = "repeat(4, 1fr)";
    monthsDiv.style.gap = "10px";

    const monthNames = ["Jan", "Feb", "Mär", "Apr", "Mai", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Dez"];

    for(let m=0; m<12; m++) {
      const monthBox = document.createElement("div");
      monthBox.style.background = "rgba(0,0,0,0.5)";
      monthBox.style.borderRadius = "10px";
      monthBox.style.padding = "10px";
      monthBox.style.color = "white";
      monthBox.style.cursor = "pointer";

      const monthTitle = document.createElement("div");
      monthTitle.textContent = monthNames[m];
      monthTitle.style.fontWeight = "bold";
      monthTitle.style.marginBottom = "5px";

      monthBox.appendChild(monthTitle);

      // Tage Übersicht (Kreise für blockiert/belegt)
      const daysInMonth = new Date(year, m+1, 0).getDate();
      const daysContainer = document.createElement("div");
      daysContainer.style.display = "flex";
      daysContainer.style.flexWrap = "wrap";
      daysContainer.style.gap = "2px";

      for(let d=1; d<=daysInMonth; d++) {
        const dayStr = ymdToStr(year, m, d);
        const dayDot = document.createElement("div");
        dayDot.style.width = "10px";
        dayDot.style.height = "10px";
        dayDot.style.borderRadius = "50%";

        if(isDateBlocked(dayStr)) {
          dayDot.style.background = "#6c757d";
        } else if(isDateBooked(dayStr)) {
          dayDot.style.background = "#d9534f";
        } else {
          dayDot.style.background = "#28a745aa";
        }
        daysContainer.appendChild(dayDot);
      }
      monthBox.appendChild(daysContainer);

      // Klick auf Monat zeigt Monatsansicht dieses Monats
      monthBox.onclick = () => {
        renderCalendar(year, m);
      };

      monthsDiv.appendChild(monthBox);
    }
    calendarContainer.appendChild(monthsDiv);
  }

  // Formular Validierung & Warnung falls keine Daten ausgewählt
  const bookingForm = document.getElementById("booking-form");
  bookingForm.addEventListener("submit", (e) => {
    if(!selection.start) {
      e.preventDefault();
      document.getElementById("booking-msg").textContent = "Bitte Startdatum auswählen!";
      document.getElementById("booking-msg").className = "error";
      return;
    }
    if(!selection.end) {
      e.preventDefault();
      document.getElementById("booking-msg").textContent = "Bitte Enddatum auswählen!";
      document.getElementById("booking-msg").className = "error";
      return;
    }
    // Speicherung lokal zur Übersicht im Admin
    const formData = new FormData(bookingForm);
    const newBooking = {
      id: Date.now(),
      name: formData.get("Name"),
      persons: formData.get("Personen"),
      breakfast: formData.get("Frühstück"),
      arrival: formData.get("Ankunftszeit"),
      departure: formData.get("Abfahrtszeit"),
      start: formData.get("Startdatum"),
      end: formData.get("Enddatum")
    };
    bookings.push(newBooking);
    localStorage.setItem("bookings", JSON.stringify(bookings));
    alert("Buchung wurde erfolgreich erfasst! Eine Bestätigung wird per E-Mail gesendet.");
  });

  // --- Admin Bereich ---

  const adminLoginSection = document.getElementById("admin-login-section");
  const adminDashboard = document.getElementById("admin-dashboard");
  const adminLoginBtn = document.getElementById("admin-login-btn");
  const adminPasswordInput = document.getElementById("admin-password");
  const adminLoginError = document.getElementById("admin-login-error");
  const adminLogoutBtn = document.getElementById("admin-logout-btn");
  const bookingsTbody = document.getElementById("bookings-tbody");
  const blockDayInput = document.getElementById("block-day-input");
  const blockDayBtn = document.getElementById("block-day-btn");
  const unblockDayBtn = document.getElementById("unblock-day-btn");
  const adminMsg = document.getElementById("admin-msg");
  const exportCsvBtn = document.getElementById("export-csv-btn");

  // Admin Login
  adminLoginBtn.addEventListener("click", () => {
    if(adminPasswordInput.value === ADMIN_PASSWORD) {
      adminLoginSection.style.display = "none";
      adminDashboard.style.display = "block";
      adminLoginError.textContent = "";
      renderBookingsTable();
      loadBlockedDays();
    } else {
      adminLoginError.textContent = "Falsches Passwort!";
    }
  });

  // Admin Logout
  adminLogoutBtn.addEventListener("click", () => {
    adminDashboard.style.display = "none";
    adminLoginSection.style.display = "block";
    adminPasswordInput.value = "";
  });

  // Buchungen Tabelle rendern
  function renderBookingsTable() {
    bookingsTbody.innerHTML = "";
    if(bookings.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 7;
      td.textContent = "Keine Buchungen vorhanden.";
      tr.appendChild(td);
      bookingsTbody.appendChild(tr);
      return;
    }
    bookings.forEach(b => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${b.name}</td>
        <td>${b.persons}</td>
        <td>${b.breakfast}</td>
        <td>${b.arrival}</td>
        <td>${b.departure}</td>
        <td>${b.start}</td>
        <td>${b.end}</td>
      `;
      bookingsTbody.appendChild(tr);
    });
  }

  // Blockierte Tage laden und speichern
  function loadBlockedDays() {
    const stored = localStorage.getItem("blockedDays");
    if(stored) {
      blockedDays = JSON.parse(stored);
    } else {
      blockedDays = [];
    }
  }
  function saveBlockedDays() {
    localStorage.setItem("blockedDays", JSON.stringify(blockedDays));
  }

  // Blockieren und Freigeben von Tagen im Admin
  blockDayBtn.addEventListener("click", () => {
    const day = blockDayInput.value;
    if(day && !blockedDays.includes(day)) {
      blockedDays.push(day);
      saveBlockedDays();
      adminMsg.textContent = `Tag ${day} wurde blockiert.`;
      adminMsg.className = "success";
      renderCalendar(currentYear, currentMonth);
      renderBookingsTable();
    }
  });
  unblockDayBtn.addEventListener("click", () => {
    const day = blockDayInput.value;
    if(day && blockedDays.includes(day)) {
      blockedDays = blockedDays.filter(d => d !== day);
      saveBlockedDays();
      adminMsg.textContent = `Tag ${day} wurde freigegeben.`;
      adminMsg.className = "success";
      renderCalendar(currentYear, currentMonth);
      renderBookingsTable();
    }
  });

  // Export Buchungen CSV
  exportCsvBtn.addEventListener("click", () => {
    if(bookings.length === 0) {
      alert("Keine Buchungen zum Exportieren.");
      return;
    }
    let csv = "Name,Personen,Frühstück,Ankunft,Abfahrt,Startdatum,Enddatum\n";
    bookings.forEach(b => {
      csv += `"${b.name}","${b.persons}","${b.breakfast}","${b.arrival}","${b.departure}","${b.start}","${b.end}"\n`;
    });
    const blob = new Blob([csv], {type: "text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `bookings_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  });

  // Initial Setup
  loadBlockedDays();
  renderCalendar(currentYear, currentMonth);

})();</script>

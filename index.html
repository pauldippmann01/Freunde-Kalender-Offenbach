<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gast Kalender Offenbach</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVK+jJdG7y6Dq2T2n6m3hU7I6t0y7sC6XFvA6X/m0Pz06x3Vq5tA7M7O4x4E4S4C7x7D6y8A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #f4f7f6;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
        }
        main {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }
        h1, h2, h3 {
            text-align: center;
            margin-bottom: 20px;
        }
        nav {
            background-color: #3f51b5;
            padding: 10px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        nav button {
            background-color: #5c6bc0;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            white-space: nowrap;
        }
        nav button:hover {
            background-color: #7986cb;
        }
        .container {
            max-width: 900px;
            margin: 20px auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .month-nav button {
            background-color: #eee;
            border: 1px solid #ccc;
            padding: 5px 10px;
            cursor: pointer;
        }
        table.calendar {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            table-layout: fixed;
        }
        table.calendar th, table.calendar td {
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
            height: 30px;
            box-sizing: border-box;
        }
        table.calendar th {
            background-color: #f2f2f2;
        }
        table.calendar td {
            background-color: #fff;
            cursor: pointer;
        }
        table.calendar td.inactive {
            color: #ccc;
            background-color: #f9f9f9;
            cursor: default;
        }
        table.calendar td.booked {
            background-color: #ff5252;
            color: white;
        }
        table.calendar td.cancelled {
            background-color: #d1c4e9;
            color: white;
        }
        table.calendar td.blocked {
            background-color: #757575;
            color: white;
        }
        table.calendar td.selected-start,
        table.calendar td.selected-end,
        table.calendar td.selected-range {
            background-color: #81c784 !important;
        }

        #calendar-legend {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 0.9em;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border: 1px solid #ddd;
        }
        #legend-color-available { background-color: white; }
        #legend-color-booked { background-color: #ff5252; border-color: #ff5252; }
        #legend-color-cancelled { background-color: #d1c4e9; border-color: #d1c4e9; }
        #legend-color-blocked { background-color: #757575; border-color: #757575; }
        #legend-color-selected { background-color: #81c784; border-color: #81c784; }

        #yearly-calendar-content, #admin-yearly-calendar-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        #yearly-calendar-content .calendar, #admin-yearly-calendar-content .calendar {
            font-size: 10px;
        }
        #yearly-calendar-content .calendar td, #admin-yearly-calendar-content .calendar td {
            padding: 5px;
            height: 25px;
            line-height: 15px;
        }
        #yearly-calendar-content .calendar td.tooltip, #admin-yearly-calendar-content .calendar td.tooltip {
            padding: 0;
            height: 25px;
            line-height: 25px;
        }
        #yearly-calendar-content .calendar .tooltiptext, #admin-yearly-calendar-content .calendar .tooltiptext {
            width: 80px;
            left: 50%;
            margin-left: -40px;
        }
        #admin-booking-form-container {
            max-width: 500px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            background-color: #f9f9f9;
        }

        form {
            max-width: 500px;
            margin: 20px auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            resize: vertical;
        }
        input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }
        button {
            background-color: #3f51b5;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #5c6bc0;
        }
        .error-msg {
            color: red;
            text-align: center;
            margin-top: -10px;
            margin-bottom: 10px;
        }
        .info-msg {
            color: green;
            text-align: center;
            margin-top: -10px;
            margin-bottom: 10px;
        }
        #login-box {
            max-width: 300px;
            margin: 40px auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        #admin-bookings-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            margin-bottom: 20px;
        }
        #admin-bookings-list table {
            width: 100%;
            border-collapse: collapse;
        }
        #admin-bookings-list th, #admin-bookings-list td {
            padding: 8px;
            border: 1px solid #ccc;
            text-align: center;
        }
        #admin-bookings-list th {
            background-color: #f2f2f2;
        }
        .icon {
            margin-right: 5px;
        }

        .tooltip {
          position: relative;
          display: block;
          width: 100%;
          height: 100%;
          pointer-events: none;
        }
        .tooltiptext {
          visibility: hidden;
          width: 120px;
          background-color: #555;
          color: #fff;
          text-align: center;
          border-radius: 6px;
          padding: 5px 0;
          position: absolute;
          z-index: 1;
          bottom: 125%;
          left: 50%;
          margin-left: -60px;
          opacity: 0;
          transition: opacity 0.3s;
          pointer-events: none;
        }
        td:hover .tooltiptext {
          visibility: visible;
          opacity: 1;
        }
        .tooltiptext::after {
          content: "";
          position: absolute;
          top: 100%;
          left: 50%;
          margin-left: -5px;
          border-width: 5px;
          border-style: solid;
          border-color: #555 transparent transparent transparent;
        }
        #notification-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            max-width: 300px;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        #notification-box.error { background-color: #f44336; }
        @keyframes fadein { from { opacity: 0; top: 0; } to { opacity: 1; top: 20px; } }
        @keyframes fadeout { from { opacity: 1; top: 20px; } to { opacity: 0; top: 0; } }

        @media (max-width: 600px) {
            #yearly-calendar-content, #admin-yearly-calendar-content {
                grid-template-columns: repeat(2, 1fr);
            }
            table.calendar th, table.calendar td {
                padding: 3px;
                font-size: 8px;
            }
            .container {
                padding: 10px;
            }
            nav {
                flex-direction: column;
            }
            nav button {
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <nav>
        <button id="lang-de"><i class="fas fa-flag icon"></i> DE</button>
        <button id="lang-en"><i class="fas fa-flag icon"></i> EN</button>
        <button id="btn-to-start" style="display:none;"><i class="fas fa-home icon"></i> Startseite</button>
        <button id="btn-show-friend-login"><i class="fas fa-user-friends icon"></i> Gast-Login</button>
        <button id="btn-show-admin-login"><i class="fas fa-user-shield icon"></i> Admin Login</button>
    </nav>

    <div id="notification-box"></div>

    <main>
        <section id="start-page">
            <div class="container">
                <h1 data-lang-de="Willkommen in Offenbach!" data-lang-en="Welcome to Offenbach!">Willkommen in Offenbach!</h1>
                <p style="text-align:center;" data-lang-de="Ich freue mich auf deinen Besuch! Über den Kalender kannst du als Gast bequem eine Übernachtung buchen. Oder du meldest dich als Admin an, um den Kalender zu verwalten." data-lang-en="I'm looking forward to your visit! You can book an overnight stay as a guest via the calendar. Or you can log in as an admin to manage the calendar.">
                    Ich freue mich auf deinen Besuch! Über den Kalender kannst du als Gast bequem eine Übernachtung buchen. Oder du meldest dich als Admin an, um den Kalender zu verwalten.
                </p>
            </div>
        </section>

        <section id="friend-login" style="display:none;">
            <div id="login-box">
                <h2 data-lang-de="Gast Login" data-lang-en="Guest Login">Gast Login</h2>
                <p data-lang-de="Bitte Passwort eingeben:" data-lang-en="Please enter your password:">Bitte Passwort eingeben:</p>
                <input type="password" id="friend-password" placeholder="Passwort" data-lang-placeholder-de="Passwort" data-lang-placeholder-en="Password" />
                <div id="friend-login-error" class="error-msg"></div>
                <button id="friend-login-btn" data-lang-de="Einloggen" data-lang-en="Login">Einloggen</button>
            </div>
        </section>

        <section id="friend-area" style="display:none;">
            <div class="container">
                <h2 data-lang-de="Jahreskalender (Gast-Ansicht)" data-lang-en="Yearly Calendar (Guest View)">Jahreskalender (Gast-Ansicht)</h2>
                <div style="text-align:center; margin-bottom: 10px;">
                    <button id="year-prev" data-lang-de="&lt; Vorjahr" data-lang-en="&lt; Previous Year">&lt; Vorjahr</button>
                    <span id="year-display" style="font-weight: 700; margin: 0 15px; font-size: 1.2em;"></span>
                    <button id="year-next" data-lang-de="Nächstes Jahr &gt;" data-lang-en="Next Year &gt;">Nächstes Jahr &gt;</button>
                </div>

                <div id="calendar-legend">
                    <div class="legend-item">
                        <div class="legend-color" id="legend-color-available"></div>
                        <span data-lang-de="Freie Tage" data-lang-en="Available Days">Freie Tage</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" id="legend-color-booked"></div>
                        <span data-lang-de="Gebuchte Tage" data-lang-en="Booked Days">Gebuchte Tage</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" id="legend-color-blocked"></div>
                        <span data-lang-de="Blockierte Tage" data-lang-en="Blocked Days">Blockierte Tage</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" id="legend-color-selected"></div>
                        <span data-lang-de="Ausgewählter Zeitraum" data-lang-en="Selected Period">Ausgewählter Zeitraum</span>
                    </div>
                </div>

                <div id="yearly-calendar-content"></div>
            </div>

            <form id="booking-form" style="display:none;">
                <h3 style="margin-top: 0;" data-lang-de="Buchungsdetails" data-lang-en="Booking Details">Buchungsdetails</h3>
                <div id="booking-summary-text" style="text-align:center; margin-bottom: 15px; font-weight:bold;"></div>
                <div>
                    <label for="book-name" data-lang-de="Name *" data-lang-en="Name *">Name *</label>
                    <input type="text" id="book-name" required />
                </div>
                <div>
                    <label for="book-email" data-lang-de="E-Mail-Adresse *" data-lang-en="E-Mail Address *">E-Mail-Adresse *</label>
                    <input type="email" id="book-email" required />
                </div>
                <div>
                    <label for="book-persons" data-lang-de="Anzahl Personen * (max. 3)" data-lang-en="Number of people * (max. 3)">Anzahl Personen * (max. 3)</label>
                    <input type="number" id="book-persons" min="1" max="3" required />
                </div>
                <div>
                    <label for="book-start-date" data-lang-de="Startdatum *" data-lang-en="Start Date *">Startdatum *</label>
                    <input type="date" id="book-start-date" required />
                </div>
                <div>
                    <label for="book-end-date" data-lang-de="Enddatum *" data-lang-en="End Date *">Enddatum *</label>
                    <input type="date" id="book-end-date" required />
                </div>
                <div>
                    <label for="book-breakfast" data-lang-de="Frühstück benötigt? *" data-lang-en="Breakfast needed? *">Frühstück benötigt? *</label>
                    <select id="book-breakfast" required>
                        <option value="ja" data-lang-de="Ja" data-lang-en="Yes">Ja</option>
                        <option value="nein" selected data-lang-de="Nein" data-lang-en="No">Nein</option>
                    </select>
                </div>
                <div>
                    <label for="book-arrival-time" data-lang-de="Anreise Uhrzeit (optional)" data-lang-en="Arrival Time (optional)">Anreise Uhrzeit (optional)</label>
                    <input type="time" id="book-arrival-time" />
                </div>
                <div>
                    <label for="book-departure-time" data-lang-de="Abreise Uhrzeit (optional)" data-lang-en="Departure Time (optional)">Abreise Uhrzeit (optional)</label>
                    <input type="time" id="book-departure-time" />
                </div>
                <div>
                    <label for="book-comment" data-lang-de="Bemerkungen (optional, max. 200 Zeichen)" data-lang-en="Comments (optional, max. 200 characters)">Bemerkungen (optional, max. 200 Zeichen)</label>
                    <textarea id="book-comment" maxlength="200"></textarea>
                </div>
                <div>
                    <label for="book-parking">
                        <input type="checkbox" id="book-parking"> <span data-lang-de="Parkplatz benötigt?" data-lang-en="Parking space needed?">Parkplatz benötigt?</span>
                    </label>
                </div>
                <div id="booking-error" class="error-msg"></div>
                <button type="submit" style="background-color: #4CAF50;" data-lang-de="Buchung abschicken" data-lang-en="Submit Booking">Buchung abschicken</button>
                <button type="button" id="btn-cancel-booking-form" style="background-color: #f44336;" data-lang-de="Abbrechen" data-lang-en="Cancel">Abbrechen</button>
            </form>
            <div id="booking-success" class="container" style="display:none;">
                <h3 data-lang-de="Buchung erfolgreich!" data-lang-en="Booking successful!">Buchung erfolgreich!</h3>
                <p data-lang-de="Ihre Buchungsdetails wurden gespeichert. Sie erhalten in Kürze eine Bestätigung per E-Mail." data-lang-en="Your booking details have been saved. You will receive a confirmation email shortly.">Ihre Buchungsdetails wurden gespeichert. Sie erhalten in Kürze eine Bestätigung per E-Mail.</p>
                <div id="success-details" style="text-align: left;"></div>
                <button id="btn-new-booking" data-lang-de="Neue Buchung" data-lang-en="New Booking">Neue Buchung</button>
            </div>
        </section>

        <section id="admin-login" style="display:none;">
            <div id="login-box">
                <h2 data-lang-de="Admin Login" data-lang-en="Admin Login">Admin Login</h2>
                <p data-lang-de="Bitte Admin-Passwort eingeben:" data-lang-en="Please enter the admin password:">Bitte Admin-Passwort eingeben:</p>
                <input type="password" id="admin-password" placeholder="Admin Passwort" data-lang-placeholder-de="Admin Passwort" data-lang-placeholder-en="Admin Password" />
                <div id="admin-login-error" class="error-msg"></div>
                <button id="admin-login-btn" data-lang-de="Einloggen" data-lang-en="Login">Einloggen</button>
            </div>
        </section>

        <section id="admin-area" style="display:none;">
            <div class="container">
                <h2 data-lang-de="Jahreskalender (Admin-Ansicht)" data-lang-en="Yearly Calendar (Admin View)">Jahreskalender (Admin-Ansicht)</h2>
                <div style="margin-bottom: 20px; text-align: center;">
                    <button id="btn-logout-admin" style="background-color: #f44336;"><i class="fas fa-sign-out-alt icon"></i> <span data-lang-de="Admin Logout" data-lang-en="Admin Logout">Admin Logout</span></button>
                    <button id="btn-export-csv"><i class="fas fa-file-csv icon"></i> <span data-lang-de="Exportiere Buchungen (CSV)" data-lang-en="Export Bookings (CSV)">Exportiere Buchungen (CSV)</span></button>
                </div>
                <div style="text-align:center; margin-bottom: 10px;">
                    <button id="admin-year-prev" data-lang-de="&lt; Vorjahr" data-lang-en="&lt; Previous Year">&lt; Vorjahr</button>
                    <span id="admin-year-display" style="font-weight: 700; margin: 0 15px; font-size: 1.2em;"></span>
                    <button id="admin-year-next" data-lang-de="Nächstes Jahr &gt;" data-lang-en="Next Year &gt;">Nächstes Jahr &gt;</button>
                </div>

                <div id="calendar-legend">
                    <div class="legend-item">
                        <div class="legend-color" id="legend-color-available"></div>
                        <span data-lang-de="Freie Tage" data-lang-en="Available Days">Freie Tage</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" id="legend-color-booked"></div>
                        <span data-lang-de="Gebuchte Tage" data-lang-en="Booked Days">Gebuchte Tage</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" id="legend-color-cancelled"></div>
                        <span data-lang-de="Storniert" data-lang-en="Cancelled">Storniert</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" id="legend-color-blocked"></div>
                        <span data-lang-de="Blockierte Tage" data-lang-en="Blocked Days">Blockierte Tage</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" id="legend-color-selected"></div>
                        <span data-lang-de="Ausgewählter Zeitraum" data-lang-en="Selected Period">Ausgewählter Zeitraum</span>
                    </div>
                </div>

                <div id="admin-yearly-calendar-content"></div>

                <div style="text-align: center; margin-top: 10px;">
                    <button id="btn-block-selected" style="background-color: #757575;" data-lang-de="Ausgewählte Tage blockieren" data-lang-en="Block Selected Days">Ausgewählte Tage blockieren</button>
                    <button id="btn-unblock-selected" style="background-color: #f44336;" data-lang-de="Ausgewählte Tage freigeben" data-lang-en="Unblock Selected Days">Ausgewählte Tage freigeben</button>
                </div>
                
                <div id="admin-booking-form-container" style="display:none;">
                    <h3 data-lang-de="Admin-Buchung oder Blockierung" data-lang-en="Admin Booking or Blocking">Admin-Buchung oder Blockierung</h3>
                    <form id="admin-booking-form">
                        <div>
                            <label for="admin-book-name" data-lang-de="Name" data-lang-en="Name">Name</label>
                            <input type="text" id="admin-book-name" required />
                        </div>
                        <div>
                            <label for="admin-book-email" data-lang-de="E-Mail" data-lang-en="Email">E-Mail</label>
                            <input type="email" id="admin-book-email" required />
                        </div>
                        <div>
                            <label for="admin-book-start-date" data-lang-de="Startdatum" data-lang-en="Start Date">Startdatum</label>
                            <input type="date" id="admin-book-start-date" required />
                        </div>
                        <div>
                            <label for="admin-book-end-date" data-lang-de="Enddatum" data-lang-en="End Date">Enddatum</label>
                            <input type="date" id="admin-book-end-date" required />
                        </div>
                        <button type="submit" data-lang-de="Buchung eintragen" data-lang-en="Add Booking">Buchung eintragen</button>
                        <button type="button" id="btn-cancel-admin-form" style="background-color: #f44336;" data-lang-de="Abbrechen" data-lang-en="Cancel">Abbrechen</button>
                    </form>
                </div>


                <h3 data-lang-de="Belegte und Blockierte Tage" data-lang-en="Booked and Blocked Days">Belegte und Blockierte Tage</h3>
                <div id="admin-bookings-list"></div>

                <h3 data-lang-de="Statistiken" data-lang-en="Statistics">Statistiken</h3>
                <div id="stats-container" class="container">
                    <p><strong data-lang-de="Anzahl Buchungen (aktiv):" data-lang-en="Number of active bookings:">Anzahl Buchungen (aktiv):</strong> <span id="stat-active-bookings">0</span></p>
                    <p><strong data-lang-de="Anzahl stornierter Buchungen:" data-lang-en="Number of cancelled bookings:">Anzahl stornierter Buchungen:</strong> <span id="stat-cancelled-bookings">0</span></p>
                    <p><strong data-lang-de="Durchschnittliche Aufenthaltsdauer:" data-lang-en="Average stay duration:">Durchschnittliche Aufenthaltsdauer:</strong> <span id="stat-avg-stay">0</span> <span data-lang-de="Tage" data-lang-en="days">Tage</span></p>
                    <p><strong data-lang-de="Auslastung im aktuellen Jahr:" data-lang-en="Occupancy in current year:">Auslastung im aktuellen Jahr:</strong> <span id="stat-occupancy">0%</span></p>
                </div>
            </div>
        </section>

        <section id="cancel-page" style="display:none; text-align: center; padding: 50px;">
            <div class="container">
                <h2 data-lang-de="Buchung stornieren" data-lang-en="Cancel Booking">Buchung stornieren</h2>
                <p id="cancel-status-text" data-lang-de="Stornierungslink wird überprüft..." data-lang-en="Cancellation link is being checked...">Stornierungslink wird überprüft...</p>
                <div id="cancel-details" style="margin-top: 20px; text-align: left; max-width: 400px; margin: 20px auto;"></div>
                <div id="cancel-buttons" style="margin-top: 20px;">
                    <button id="btn-confirm-cancellation" style="background-color: #f44336;" data-lang-de="Buchung bestätigen & stornieren" data-lang-en="Confirm & Cancel Booking">Buchung bestätigen & stornieren</button>
                    <button id="btn-return-home" data-lang-de="Zurück zur Startseite" data-lang-en="Back to homepage">Zurück zur Startseite</button>
                </div>
            </div>
        </section>

    </main>

    <script>
        (() => {
            // SICHERHEITSHINWEIS: Passwörter im Client-Side-Code sind unsicher!
            const FRIEND_PASSWORD = "ÜinOffenbach!";
            const ADMIN_PASSWORD = "Romulus2025?!";
            const ADMIN_EMAIL = "pauldippmann@gmail.com";

            // SICHERHEITSHINWEIS: EmailJS-Konfiguration im Client-Side-Code ist unsicher.
            const EMAILJS_SERVICE_ID = 'service_9vdk8p2';
            const EMAILJS_TEMPLATE_ID_BOOKING = 'template_exo2yi1';
            const EMAILJS_TEMPLATE_ID_CANCEL = 'template_9azx5z9';
            const EMAILJS_TEMPLATE_ID_REMINDER = 'template_9azx5z9'; // Platzhalter, falls eine neue Vorlage für Erinnerungen erstellt wird
            const EMAILJS_PUBLIC_KEY = 'OXLiZSAem79gPP-Wl';

            // SICHERHEITSHINWEIS: Firebase-Konfiguration im Client-Side-Code.
            const firebaseConfig = {
                apiKey: "AIzaSyAu9hXGYbgmD-_pz0LHN5VgUcV9mRNkU98",
                authDomain: "freunde-kalender-offenbach.firebaseapp.com",
                projectId: "freunde-kalender-offenbach",
                storageBucket: "freunde-kalender-offenbach.firebasestorage.app",
                messagingSenderId: "753671032354",
                appId: "1:753671032354:web:a154b43ccdfcc491c4c47b"
            };

            // Initialisiere Firebase und Firestore
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            // Kalender Start & Ende
            const CAL_START_YEAR = 2025;
            const CAL_END_YEAR = 2040;

            // State
            let currentYear;
            let selectedStartDate = null;
            let selectedEndDate = null;
            let currentView = 'friend'; // Kann 'friend' oder 'admin' sein
            let currentLang = 'de';

            const sections = {
                start: document.getElementById("start-page"),
                friendLogin: document.getElementById("friend-login"),
                friendArea: document.getElementById("friend-area"),
                adminLogin: document.getElementById("admin-login"),
                adminArea: document.getElementById("admin-area"),
                cancel: document.getElementById("cancel-page")
            };

            // Multilingualism
            const translations = {
                de: {
                    'Willkommen in Offenbach!': 'Willkommen in Offenbach!',
                    'I\'m looking forward to your visit! ...': 'Ich freue mich auf deinen Besuch! Über den Kalender kannst du als Gast bequem eine Übernachtung buchen. Oder du meldest dich als Admin an, um den Kalender zu verwalten.',
                    'Gast-Login': 'Gast-Login',
                    'Admin Login': 'Admin Login',
                    'Startseite': 'Startseite',
                    'Bitte Passwort eingeben:': 'Bitte Passwort eingeben:',
                    'Passwort': 'Passwort',
                    'Einloggen': 'Einloggen',
                    'Falsches Passwort!': 'Falsches Passwort!',
                    'Jahreskalender (Gast-Ansicht)': 'Jahreskalender (Gast-Ansicht)',
                    '&lt; Vorjahr': '&lt; Vorjahr',
                    'Nächstes Jahr &gt;': 'Nächstes Jahr &gt;',
                    'Freie Tage': 'Freie Tage',
                    'Gebuchte Tage': 'Gebuchte Tage',
                    'Blockierte Tage': 'Blockierte Tage',
                    'Ausgewählter Zeitraum': 'Ausgewählter Zeitraum',
                    'Buchungsdetails': 'Buchungsdetails',
                    'Buchung von': 'Buchung von',
                    'bis': 'bis',
                    'Name *': 'Name *',
                    'E-Mail-Adresse *': 'E-Mail-Adresse *',
                    'Anzahl Personen * (max. 3)': 'Anzahl Personen * (max. 3)',
                    'Startdatum *': 'Startdatum *',
                    'Enddatum *': 'Enddatum *',
                    'Frühstück benötigt? *': 'Frühstück benötigt? *',
                    'Ja': 'Ja',
                    'Nein': 'Nein',
                    'Anreise Uhrzeit (optional)': 'Anreise Uhrzeit (optional)',
                    'Abreise Uhrzeit (optional)': 'Abreise Uhrzeit (optional)',
                    'Bemerkungen (optional, max. 200 Zeichen)': 'Bemerkungen (optional, max. 200 Zeichen)',
                    'Parkplatz benötigt?': 'Parkplatz benötigt?',
                    'Buchung abschicken': 'Buchung abschicken',
                    'Abbrechen': 'Abbrechen',
                    'Bitte einen Namen eingeben.': 'Bitte einen Namen eingeben.',
                    'Bitte eine gültige E-Mail-Adresse eingeben.': 'Bitte eine gültige E-Mail-Adresse eingeben.',
                    'Bitte gültige Anzahl Personen eingeben (max. 3).': 'Bitte gültige Anzahl Personen eingeben (max. 3).',
                    'Bitte gültige Start- und Enddaten eingeben.': 'Bitte gültige Start- und Enddaten eingeben.',
                    'Enddatum darf nicht vor Startdatum liegen.': 'Enddatum darf nicht vor Startdatum liegen.',
                    'Der ausgewählte Zeitraum überschneidet sich mit einem blockierten Zeitraum.': 'Der ausgewählte Zeitraum überschneidet sich mit einem blockierten Zeitraum.',
                    'Der ausgewählte Zeitraum überschneidet sich mit einer bestehenden Buchung.': 'Der ausgewählte Zeitraum überschneidet sich mit einer bestehenden Buchung.',
                    'Buchung erfolgreich!': 'Buchung erfolgreich!',
                    'Ihre Buchungsdetails wurden gespeichert. Sie erhalten in Kürze eine Bestätigung per E-Mail.': 'Ihre Buchungsdetails wurden gespeichert. Sie erhalten in Kürze eine Bestätigung per E-Mail.',
                    'Neue Buchung': 'Neue Buchung',
                    'Admin Passwort': 'Admin Passwort',
                    'Falsches Admin-Passwort!': 'Falsches Admin-Passwort!',
                    'Jahreskalender (Admin-Ansicht)': 'Jahreskalender (Admin-Ansicht)',
                    'Admin Logout': 'Admin Logout',
                    'Exportiere Buchungen (CSV)': 'Exportiere Buchungen (CSV)',
                    'Storniert': 'Storniert',
                    'Ausgewählte Tage blockieren': 'Ausgewählte Tage blockieren',
                    'Ausgewählte Tage freigeben': 'Ausgewählte Tage freigeben',
                    'Admin-Buchung oder Blockierung': 'Admin-Buchung oder Blockierung',
                    'Name': 'Name',
                    'E-Mail': 'E-Mail',
                    'Startdatum': 'Startdatum',
                    'Enddatum': 'Enddatum',
                    'Buchung eintragen': 'Buchung eintragen',
                    'Bitte wähle zuerst einen Zeitraum im Kalender aus.': 'Bitte wähle zuerst einen Zeitraum im Kalender aus.',
                    'Zeitraum von %s bis %s erfolgreich blockiert.': 'Zeitraum von %s bis %s erfolgreich blockiert.',
                    'Sollen die Tage von %s bis %s wirklich freigegeben werden?': 'Sollen die Tage von %s bis %s wirklich freigegeben werden?',
                    'Tage erfolgreich freigegeben!': 'Tage erfolgreich freigegeben!',
                    'Keine Blockierung im ausgewählten Zeitraum gefunden.': 'Keine Blockierung im ausgewählten Zeitraum gefunden.',
                    'Belegte und Blockierte Tage': 'Belegte und Blockierte Tage',
                    'Statistiken': 'Statistiken',
                    'Anzahl Buchungen (aktiv):': 'Anzahl Buchungen (aktiv):',
                    'Anzahl stornierter Buchungen:': 'Anzahl stornierter Buchungen:',
                    'Durchschnittliche Aufenthaltsdauer:': 'Durchschnittliche Aufenthaltsdauer:',
                    'Auslastung im aktuellen Jahr:': 'Auslastung im aktuellen Jahr:',
                    'Tage': 'Tage',
                    'Buchung stornieren': 'Buchung stornieren',
                    'Stornierungslink wird überprüft...': 'Stornierungslink wird überprüft...',
                    'Ungültiger oder bereits stornierter Buchungslink.': 'Ungültiger oder bereits stornierter Buchungslink.',
                    'Buchungsdetails:': 'Buchungsdetails:',
                    'Confirm & Cancel Booking': 'Buchung bestätigen & stornieren',
                    'Back to homepage': 'Zurück zur Startseite',
                    'Soll die Buchung von %s wirklich storniert werden?': 'Soll die Buchung von %s wirklich storniert werden?',
                    'Ihre Buchung wurde erfolgreich storniert.': 'Ihre Buchung wurde erfolgreich storniert.',
                    'Fehler beim Stornieren der Buchung:': 'Fehler beim Stornieren der Buchung:',
                    'Buchung von %s erfolgreich storniert. Bestätigung wurde per E-Mail gesendet.': 'Buchung von %s erfolgreich storniert. Bestätigung wurde per E-Mail gesendet.',
                    'Fehler! E-Mail konnte nicht gesendet werden.': 'Fehler! E-Mail konnte nicht gesendet werden.',
                    'Keine Buchungen zum Exportieren vorhanden.': 'Keine Buchungen zum Exportieren vorhanden.',
                    'Manuelle Buchung von %s bis %s erfolgreich hinzugefügt!': 'Manuelle Buchung von %s bis %s erfolgreich hinzugefügt!',
                    'Wohnung nicht verfügbar': 'Wohnung nicht verfügbar',
                    'Aktion': 'Aktion',
                    'Typ': 'Typ',
                    'Buchung': 'Buchung',
                    'Löschen': 'Löschen',
                    'Freigeben': 'Freigeben',
                    'Erinnerung': 'Erinnerung',
                    'Diese Buchung ist bereits storniert.': 'Diese Buchung ist bereits storniert.',
                    'Erinnerung an Ihre bevorstehende Buchung': 'Erinnerung an Ihre bevorstehende Buchung',
                    'Erinnerungs-E-Mail erfolgreich gesendet!': 'Erinnerungs-E-Mail erfolgreich gesendet!',
                    'Fehler beim Senden der Erinnerungs-E-Mail.': 'Fehler beim Senden der Erinnerungs-E-Mail.',
                    'Ihre Buchung wurde storniert': 'Ihre Buchung wurde storniert',
                    'Ja': 'Ja',
                    'Nein': 'Nein',
                    'Ein Fehler ist aufgetreten. Die Buchung konnte nicht storniert werden.': 'Ein Fehler ist aufgetreten. Die Buchung konnte nicht storniert werden.'
                },
                en: {
                    'Willkommen in Offenbach!': 'Welcome to Offenbach!',
                    'Ich freue mich auf deinen Besuch! Über den Kalender kannst du als Gast bequem eine Übernachtung buchen. Oder du meldest dich als Admin an, um den Kalender zu verwalten.': 'I\'m looking forward to your visit! You can book an overnight stay as a guest via the calendar. Or you can log in as an admin to manage the calendar.',
                    'Gast-Login': 'Guest Login',
                    'Admin Login': 'Admin Login',
                    'Startseite': 'Homepage',
                    'Bitte Passwort eingeben:': 'Please enter your password:',
                    'Passwort': 'Password',
                    'Einloggen': 'Login',
                    'Falsches Passwort!': 'Wrong password!',
                    'Jahreskalender (Gast-Ansicht)': 'Yearly Calendar (Guest View)',
                    '&lt; Vorjahr': '&lt; Previous Year',
                    'Nächstes Jahr &gt;': 'Next Year &gt;',
                    'Freie Tage': 'Available Days',
                    'Gebuchte Tage': 'Booked Days',
                    'Blockierte Tage': 'Blocked Days',
                    'Ausgewählter Zeitraum': 'Selected Period',
                    'Buchungsdetails': 'Booking Details',
                    'Buchung von': 'Booking from',
                    'bis': 'to',
                    'Name *': 'Name *',
                    'E-Mail-Adresse *': 'E-mail Address *',
                    'Anzahl Personen * (max. 3)': 'Number of people * (max. 3)',
                    'Startdatum *': 'Start Date *',
                    'Enddatum *': 'End Date *',
                    'Frühstück benötigt? *': 'Breakfast needed? *',
                    'Ja': 'Yes',
                    'Nein': 'No',
                    'Anreise Uhrzeit (optional)': 'Arrival Time (optional)',
                    'Abreise Uhrzeit (optional)': 'Departure Time (optional)',
                    'Bemerkungen (optional, max. 200 Zeichen)': 'Comments (optional, max. 200 characters)',
                    'Parkplatz benötigt?': 'Parking space needed?',
                    'Buchung abschicken': 'Submit Booking',
                    'Abbrechen': 'Cancel',
                    'Bitte einen Namen eingeben.': 'Please enter a name.',
                    'Bitte eine gültige E-Mail-Adresse eingeben.': 'Please enter a valid email address.',
                    'Bitte gültige Anzahl Personen eingeben (max. 3).': 'Please enter a valid number of people (max. 3).',
                    'Bitte gültige Start- und Enddaten eingeben.': 'Please enter valid start and end dates.',
                    'Enddatum darf nicht vor Startdatum liegen.': 'End date cannot be before the start date.',
                    'Der ausgewählte Zeitraum überschneidet sich mit einem blockierten Zeitraum.': 'The selected period overlaps with a blocked period.',
                    'Der ausgewählte Zeitraum überschneidet sich mit einer bestehenden Buchung.': 'The selected period overlaps with an existing booking.',
                    'Buchung erfolgreich!': 'Booking successful!',
                    'Ihre Buchungsdetails wurden gespeichert. Sie erhalten in Kürze eine Bestätigung per E-Mail.': 'Your booking details have been saved. You will receive a confirmation email shortly.',
                    'Neue Buchung': 'New Booking',
                    'Admin Passwort': 'Admin Password',
                    'Falsches Admin-Passwort!': 'Wrong admin password!',
                    'Jahreskalender (Admin-Ansicht)': 'Yearly Calendar (Admin View)',
                    'Admin Logout': 'Admin Logout',
                    'Exportiere Buchungen (CSV)': 'Export Bookings (CSV)',
                    'Storniert': 'Cancelled',
                    'Ausgewählte Tage blockieren': 'Block Selected Days',
                    'Ausgewählte Tage freigeben': 'Unblock Selected Days',
                    'Admin-Buchung oder Blockierung': 'Admin Booking or Blocking',
                    'Name': 'Name',
                    'E-Mail': 'Email',
                    'Startdatum': 'Start Date',
                    'Enddatum': 'End Date',
                    'Buchung eintragen': 'Add Booking',
                    'Bitte wähle zuerst einen Zeitraum im Kalender aus.': 'Please select a period in the calendar first.',
                    'Zeitraum von %s bis %s erfolgreich blockiert.': 'The period from %s to %s was successfully blocked.',
                    'Sollen die Tage von %s bis %s wirklich freigegeben werden?': 'Are you sure you want to unblock the days from %s to %s?',
                    'Tage erfolgreich freigegeben!': 'Days successfully unblocked!',
                    'Keine Blockierung im ausgewählten Zeitraum gefunden.': 'No blocking found in the selected period.',
                    'Belegte und Blockierte Tage': 'Booked and Blocked Days',
                    'Statistiken': 'Statistics',
                    'Anzahl Buchungen (aktiv):': 'Number of active bookings:',
                    'Anzahl stornierter Buchungen:': 'Number of cancelled bookings:',
                    'Durchschnittliche Aufenthaltsdauer:': 'Average stay duration:',
                    'Auslastung im aktuellen Jahr:': 'Occupancy in current year:',
                    'Tage': 'days',
                    'Buchung stornieren': 'Cancel Booking',
                    'Stornierungslink wird überprüft...': 'Cancellation link is being checked...',
                    'Ungültiger oder bereits stornierter Buchungslink.': 'Invalid or already cancelled booking link.',
                    'Buchungsdetails:': 'Booking Details:',
                    'Confirm & Cancel Booking': 'Confirm & Cancel Booking',
                    'Back to homepage': 'Back to homepage',
                    'Soll die Buchung von %s wirklich storniert werden?': 'Are you sure you want to cancel the booking from %s?',
                    'Ihre Buchung wurde erfolgreich storniert.': 'Your booking has been successfully cancelled.',
                    'Fehler beim Stornieren der Buchung:': 'Error cancelling the booking:',
                    'Buchung von %s erfolgreich storniert. Bestätigung wurde per E-Mail gesendet.': 'A booking from %s has been successfully cancelled. A confirmation has been sent by email.',
                    'Fehler! E-Mail konnte nicht gesendet werden.': 'Error! The email could not be sent.',
                    'Keine Buchungen zum Exportieren vorhanden.': 'No bookings available for export.',
                    'Manuelle Buchung von %s bis %s erfolgreich hinzugefügt!': 'Manual booking from %s to %s was added successfully!',
                    'Wohnung nicht verfügbar': 'Apartment not available',
                    'Aktion': 'Action',
                    'Typ': 'Type',
                    'Buchung': 'Booking',
                    'Löschen': 'Delete',
                    'Freigeben': 'Unblock',
                    'Erinnerung': 'Reminder',
                    'Diese Buchung ist bereits storniert.': 'This booking is already cancelled.',
                    'Erinnerung an Ihre bevorstehende Buchung': 'Reminder about your upcoming booking',
                    'Erinnerungs-E-Mail erfolgreich gesendet!': 'Reminder email successfully sent!',
                    'Fehler beim Senden der Erinnerungs-E-Mail.': 'Error sending reminder email.',
                    'Ihre Buchung wurde storniert': 'Your booking has been cancelled',
                    'Ja': 'Yes',
                    'Nein': 'No',
                    'Ein Fehler ist aufgetreten. Die Buchung konnte nicht storniert werden.': 'An error occurred. The booking could not be cancelled.'
                }
            };

            function translatePage(lang) {
                document.querySelectorAll('[data-lang-de]').forEach(el => {
                    const deText = el.getAttribute('data-lang-de');
                    const enText = el.getAttribute('data-lang-en');
                    el.textContent = lang === 'de' ? deText : enText;
                });
                document.querySelectorAll('[data-lang-placeholder-de]').forEach(el => {
                    const deText = el.getAttribute('data-lang-placeholder-de');
                    const enText = el.getAttribute('data-lang-placeholder-en');
                    el.placeholder = lang === 'de' ? deText : enText;
                });
                document.querySelectorAll('span[data-lang-de]').forEach(el => {
                    const deText = el.getAttribute('data-lang-de');
                    const enText = el.getAttribute('data-lang-en');
                    el.textContent = lang === 'de' ? deText : enText;
                });
                document.querySelectorAll('option').forEach(el => {
                    const deValue = el.getAttribute('data-lang-de');
                    if (deValue) {
                        const enValue = el.getAttribute('data-lang-en');
                        el.textContent = lang === 'de' ? deValue : enValue;
                    }
                });
            }

            document.getElementById('lang-de').addEventListener('click', () => {
                currentLang = 'de';
                translatePage('de');
                renderYearlyCalendar(currentYear);
                if (currentView === 'admin') {
                    renderAdminBookings();
                }
                updateBookingFormSummary();
            });
            document.getElementById('lang-en').addEventListener('click', () => {
                currentLang = 'en';
                translatePage('en');
                renderYearlyCalendar(currentYear);
                if (currentView === 'admin') {
                    renderAdminBookings();
                }
                updateBookingFormSummary();
            });


            // Utility
            function formatDate(d) {
                const year = d.getFullYear();
                const month = (d.getMonth() + 1).toString().padStart(2, '0');
                const day = d.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            function dateFromStr(s) {
                if (!s) return null;
                const [year, month, day] = s.split('-').map(Number);
                return new Date(year, month - 1, day);
            }
            function checkOverlap(startA, endA, startB, endB) {
                return !(endA < startB || startA > endB);
            }
            function generateCancellationId() {
                return 'cancel_' + Math.random().toString(36).substr(2, 9);
            }
            function getDaysBetween(start, end) {
                const startDate = dateFromStr(start);
                const endDate = dateFromStr(end);
                const diffTime = Math.abs(endDate - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                return diffDays;
            }

            function showNotification(message, isError = false) {
                const box = document.getElementById('notification-box');
                box.textContent = message;
                box.className = isError ? 'error' : '';
                box.style.display = 'block';
                setTimeout(() => {
                    box.style.display = 'none';
                }, 3000);
            }

            // -------------------
            // Firebase Data Fetching
            // -------------------
            async function fetchBookings() {
                const snapshot = await db.collection('bookings').get();
                const bookings = [];
                snapshot.forEach(doc => {
                    bookings.push({ id: doc.id, ...doc.data() });
                });
                return bookings;
            }
            async function fetchBlocks() {
                const snapshot = await db.collection('blocks').get();
                const blocks = [];
                snapshot.forEach(doc => {
                    blocks.push({ id: doc.id, ...doc.data() });
                });
                return blocks;
            }
            async function deleteBlock(blockId) {
                await db.collection('blocks').doc(blockId).delete();
            }
            async function updateBookingStatus(bookingId, status) {
                await db.collection('bookings').doc(bookingId).update({ status });
            }

            // -------------------
            // Navigation & Sections
            // -------------------
            function showSection(name) {
                Object.values(sections).forEach(sec => sec.style.display = "none");
                sections[name].style.display = "block";

                const btnToStart = document.getElementById("btn-to-start");
                if(name !== "start") {
                    btnToStart.style.display = "inline-block";
                } else {
                    btnToStart.style.display = "none";
                }
            }

            // -------------------
            // Event Listeners
            // -------------------
            document.getElementById("btn-show-friend-login").addEventListener('click', () => {
                document.getElementById("friend-login-error").textContent = "";
                document.getElementById("friend-password").value = "";
                showSection("friendLogin");
            });

            document.getElementById("btn-show-admin-login").addEventListener('click', () => {
                document.getElementById("admin-login-error").textContent = "";
                document.getElementById("admin-password").value = "";
                showSection("adminLogin");
            });

            document.getElementById("btn-to-start").addEventListener('click', () => {
                window.location.href = window.location.origin + window.location.pathname;
            });

            document.getElementById("friend-login-btn").addEventListener('click', () => {
                const pw = document.getElementById("friend-password").value;
                if(pw === FRIEND_PASSWORD) {
                    currentView = 'friend';
                    showSection("friendArea");
                    resetBookingForm();
                    renderYearlyCalendar(currentYear);
                } else {
                    document.getElementById("friend-login-error").textContent = translations[currentLang]['Falsches Passwort!'];
                }
            });

            document.getElementById("admin-login-btn").addEventListener('click', async () => {
                const pw = document.getElementById("admin-password").value;
                if(pw === ADMIN_PASSWORD) {
                    currentView = 'admin';
                    showSection("adminArea");
                    renderYearlyCalendar(currentYear);
                    renderAdminBookings();
                    renderStats();
                } else {
                    document.getElementById("admin-login-error").textContent = translations[currentLang]['Falsches Admin-Passwort!'];
                }
            });

            document.getElementById("btn-logout-admin").addEventListener('click', () => {
                showSection("start");
            });

            document.getElementById("year-prev").addEventListener('click', () => {
                if(currentYear > CAL_START_YEAR) {
                    currentYear--;
                    renderYearlyCalendar(currentYear);
                }
            });
            document.getElementById("year-next").addEventListener('click', () => {
                if(currentYear < CAL_END_YEAR) {
                    currentYear++;
                    renderYearlyCalendar(currentYear);
                }
            });
            document.getElementById("admin-year-prev").addEventListener('click', () => {
                if(currentYear > CAL_START_YEAR) {
                    currentYear--;
                    renderYearlyCalendar(currentYear);
                    renderStats();
                }
            });
            document.getElementById("admin-year-next").addEventListener('click', () => {
                if(currentYear < CAL_END_YEAR) {
                    currentYear++;
                    renderYearlyCalendar(currentYear);
                    renderStats();
                }
            });

            // -----------------------
            // Jahreskalender Übersicht
            // -----------------------
            async function renderYearlyCalendar(year) {
                const calendarContent = currentView === 'friend' ? document.getElementById("yearly-calendar-content") : document.getElementById("admin-yearly-calendar-content");
                const yearDisplay = currentView === 'friend' ? document.getElementById("year-display") : document.getElementById("admin-year-display");

                yearDisplay.textContent = year;
                calendarContent.innerHTML = "";

                const [bookings, blocks] = await Promise.all([fetchBookings(), fetchBlocks()]);

                const monthNames = [
                    "Januar","Februar","März","April","Mai","Juni",
                    "Juli","August","September","Oktober","November","Dezember"
                ];

                for(let m=0; m<12; m++) {
                    const firstDay = new Date(year, m, 1);
                    const lastDay = new Date(year, m+1, 0);
                    const daysInMonth = lastDay.getDate();

                    let monthHtml = `<table class="calendar" data-month="${m}" data-year="${year}">`;
                    monthHtml += `<thead><tr><th colspan="7">${monthNames[m]}</th></tr>`;
                    monthHtml += `<tr><th>M</th><th>D</th><th>M</th><th>D</th><th>F</th><th>S</th><th>S</th></tr></thead><tbody><tr>`;

                    const startWeekday = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
                    for(let i=0; i<startWeekday; i++) {
                        monthHtml += `<td class="inactive"></td>`;
                    }
                    for(let day=1; day<=daysInMonth; day++) {
                        const date = new Date(year, m, day);
                        const dateStr = formatDate(date);
                        let classes = "";
                        let tooltip = "";

                        const bookedEntry = bookings.find(bk => bk.status === 'active' && checkOverlap(dateStr, dateStr, bk.startDate, bk.endDate));
                        const cancelledEntry = bookings.find(bk => bk.status === 'cancelled' && checkOverlap(dateStr, dateStr, bk.startDate, bk.endDate));
                        const blockedEntry = blocks.find(bl => checkOverlap(dateStr, dateStr, bl.startDate, bl.endDate));

                        if(blockedEntry) {
                            classes = "blocked";
                            tooltip = translations[currentLang]['Wohnung nicht verfügbar'];
                        } else if(bookedEntry) {
                            classes = "booked";
                            tooltip = bookedEntry.name;
                        } else if(cancelledEntry && currentView === 'admin') {
                            classes = "cancelled";
                            tooltip = `${cancelledEntry.name} (${translations[currentLang]['Storniert']})`;
                        }

                        let cellContent = day;
                        if (tooltip) {
                            monthHtml += `<td class="${classes}" data-date="${dateStr}"><div class="tooltip"><span>${cellContent}</span><span class="tooltiptext">${tooltip}</span></div></td>`;
                        } else {
                            monthHtml += `<td class="${classes}" data-date="${dateStr}"><span>${cellContent}</span></td>`;
                        }

                        if((startWeekday + day) % 7 === 0) {
                            monthHtml += "</tr><tr>";
                        }
                    }
                    monthHtml += "</tr></tbody></table>";
                    calendarContent.insertAdjacentHTML("beforeend", monthHtml);
                }
                attachDateClickHandlers();
                updateSelectedDays();
            }

            function updateSelectedDays() {
                const calendarSection = currentView === 'friend' ? document.getElementById("yearly-calendar-content") : document.getElementById("admin-yearly-calendar-content");
                const allCells = calendarSection.querySelectorAll("td");
                allCells.forEach(cell => {
                    cell.classList.remove('selected-start', 'selected-end', 'selected-range');
                    if(!cell.classList.contains('booked') && !cell.classList.contains('blocked') && !cell.classList.contains('inactive') && !cell.classList.contains('cancelled')) {
                        cell.style.backgroundColor = 'white';
                    }
                });

                if (!selectedStartDate) {
                    if (currentView === 'friend') {
                        bookingForm.style.display = "none";
                    } else {
                        document.getElementById('admin-booking-form-container').style.display = 'none';
                    }
                    return;
                }

                const sDate = dateFromStr(formatDate(selectedStartDate));
                let eDate = selectedEndDate ? dateFromStr(formatDate(selectedEndDate)) : sDate;

                const start = sDate <= eDate ? sDate : eDate;
                const end = sDate <= eDate ? eDate : sDate;

                let currentDate = new Date(start);
                const bookings = fetchBookings();
                const blocks = fetchBlocks();

                Promise.all([bookings, blocks]).then(([bks, blks]) => {
                    let isSelectionValid = true;
                    let tempDate = new Date(start);
                    while (tempDate <= end) {
                        const dateStr = formatDate(tempDate);
                        if(bks.some(b => b.status === 'active' && checkOverlap(dateStr, dateStr, b.startDate, b.endDate)) ||
                           (currentView === 'friend' && blks.some(b => checkOverlap(dateStr, dateStr, b.startDate, b.endDate)))) {
                            isSelectionValid = false;
                            break;
                        }
                        tempDate.setDate(tempDate.getDate() + 1);
                    }

                    if (!isSelectionValid) {
                        selectedStartDate = null;
                        selectedEndDate = null;
                        showNotification(translations[currentLang]['Der ausgewählte Zeitraum überschneidet sich mit einer bestehenden Buchung.'], true);
                        updateSelectedDays();
                        return;
                    }

                    currentDate = new Date(start);
                    while (currentDate <= end) {
                        const dateStr = formatDate(currentDate);
                        const cell = calendarSection.querySelector(`td[data-date="${dateStr}"]`);
                        if (cell) {
                            cell.style.backgroundColor = '#81c784';
                            if (formatDate(currentDate) === formatDate(start)) {
                                cell.classList.add('selected-start');
                            } else if (formatDate(currentDate) === formatDate(end)) {
                                cell.classList.add('selected-end');
                            } else {
                                cell.classList.add('selected-range');
                            }
                        }
                        currentDate.setDate(currentDate.getDate() + 1);
                    }

                    if (currentView === 'friend') {
                        if(selectedEndDate) {
                            showBookingForm();
                        } else {
                            bookingForm.style.display = "none";
                        }
                    } else if (currentView === 'admin') {
                        if (selectedEndDate) {
                            showAdminBookingForm();
                        } else {
                            document.getElementById('admin-booking-form-container').style.display = 'none';
                        }
                    }
                });
            }

            // ---------------------
            // Datums- und Bereichsauswahl
            // ---------------------

            function attachDateClickHandlers() {
                const calendarSection = currentView === 'friend' ? document.getElementById("yearly-calendar-content") : document.getElementById("admin-yearly-calendar-content");
                const cells = calendarSection.querySelectorAll("td:not(.inactive)");

                cells.forEach(cell => {
                    cell.style.cursor = "pointer";
                    cell.addEventListener('click', (e) => {
                        const clickedCell = e.target.closest('td');
                        if (!clickedCell) return;

                        const dateStr = clickedCell.getAttribute("data-date");
                        const date = dateFromStr(dateStr);

                        if(currentView === 'friend' && (clickedCell.classList.contains('booked') || clickedCell.classList.contains('blocked'))) {
                            selectedStartDate = null;
                            selectedEndDate = null;
                            updateSelectedDays();
                            return;
                        }

                        if(!selectedStartDate || (selectedStartDate && selectedEndDate)) {
                            selectedStartDate = date;
                            selectedEndDate = null;
                        } else {
                            if(date < selectedStartDate) {
                                selectedEndDate = selectedStartDate;
                                selectedStartDate = date;
                            } else {
                                selectedEndDate = date;
                            }
                        }
                        updateSelectedDays();
                    });
                });
            }

            // ---------------------
            // Buchungsformular (Gast)
            // ---------------------
            const bookingForm = document.getElementById("booking-form");
            const bookStartInput = document.getElementById("book-start-date");
            const bookEndInput = document.getElementById("book-end-date");
            const bookingError = document.getElementById("booking-error");
            const bookingSuccess = document.getElementById("booking-success");
            const bookingSummaryText = document.getElementById("booking-summary-text");

            function updateBookingFormSummary() {
                if (selectedStartDate && selectedEndDate) {
                    const start = formatDate(selectedStartDate);
                    const end = formatDate(selectedEndDate);
                    bookingSummaryText.textContent = `${translations[currentLang]['Buchung von']} ${start} ${translations[currentLang]['bis']} ${end}`;
                } else {
                    bookingSummaryText.textContent = '';
                }
            }

            function showBookingForm() {
                if(!selectedStartDate || !selectedEndDate) {
                    bookingForm.style.display = "none";
                    return;
                }
                bookStartInput.value = formatDate(selectedStartDate);
                bookEndInput.value = formatDate(selectedEndDate);
                bookingError.textContent = "";
                bookingForm.style.display = "block";
                bookingSuccess.style.display = "none";
                updateBookingFormSummary();
                bookingForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
                document.getElementById("book-name").focus();
            }
            function resetBookingForm() {
                selectedStartDate = null;
                selectedEndDate = null;
                updateSelectedDays();
                bookingForm.style.display = "none";
                bookingSuccess.style.display = "none";
                bookingError.textContent = "";
                bookingForm.reset && bookingForm.reset();
            }

            document.getElementById("btn-cancel-booking-form").addEventListener('click', () => {
                resetBookingForm();
            });

            document.getElementById("btn-new-booking").addEventListener('click', () => {
                resetBookingForm();
                renderYearlyCalendar(currentYear);
            });

            bookingForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById("book-name").value.trim();
                const email = document.getElementById("book-email").value.trim();
                const persons = parseInt(document.getElementById("book-persons").value);
                const breakfast = document.getElementById("book-breakfast").value;
                const parking = document.getElementById("book-parking").checked;
                const arrival = document.getElementById("book-arrival-time").value || null;
                const departure = document.getElementById("book-departure-time").value || null;
                const comment = document.getElementById("book-comment").value.trim();
                const startDate = bookStartInput.value;
                const endDate = bookEndInput.value;

                bookingError.textContent = "";

                if(!name) { bookingError.textContent = translations[currentLang]['Bitte einen Namen eingeben.']; return; }
                if(!email) { bookingError.textContent = translations[currentLang]['Bitte eine gültige E-Mail-Adresse eingeben.']; return; }
                if(!persons || persons < 1 || persons > 3) { bookingError.textContent = translations[currentLang]['Bitte gültige Anzahl Personen eingeben (max. 3).']; return; }
                if(!startDate || !endDate) { bookingError.textContent = translations[currentLang]['Bitte gültige Start- und Enddaten eingeben.']; return; }
                if(endDate < startDate) { bookingError.textContent = translations[currentLang]['Enddatum darf nicht vor Startdatum liegen.']; return; }

                const bookings = await fetchBookings();
                const blocks = await fetchBlocks();

                const rangeStart = dateFromStr(startDate);
                const rangeEnd = dateFromStr(endDate);
                let day = new Date(rangeStart);
                while (day <= rangeEnd) {
                    const dayStr = formatDate(day);
                    if (blocks.some(b => checkOverlap(dayStr, dayStr, b.startDate, b.endDate))) {
                        bookingError.textContent = translations[currentLang]['Der ausgewählte Zeitraum überschneidet sich mit einem blockierten Zeitraum.'];
                        return;
                    }
                    if (bookings.some(b => b.status === 'active' && checkOverlap(dayStr, dayStr, b.startDate, b.endDate))) {
                        bookingError.textContent = translations[currentLang]['Der ausgewählte Zeitraum überschneidet sich mit einer bestehenden Buchung.'];
                        return;
                    }
                    day.setDate(day.getDate() + 1);
                }

                const newBooking = {
                    name,
                    email,
                    persons,
                    breakfast,
                    parking,
                    arrivalTime: arrival,
                    departureTime: departure,
                    comment: comment,
                    startDate,
                    endDate,
                    cancellationId: generateCancellationId(),
                    status: 'active'
                };

                try {
                    const docRef = await db.collection('bookings').add(newBooking);

                    const cancellationLink = `${window.location.origin}${window.location.pathname}?cancelId=${newBooking.cancellationId}`;
                    const templateParams = {
                        from_name: newBooking.name,
                        to_email: newBooking.email,
                        admin_email: ADMIN_EMAIL,
                        start_date: newBooking.startDate,
                        end_date: newBooking.endDate,
                        persons: newBooking.persons,
                        cancellation_link: cancellationLink,
                        breakfast: newBooking.breakfast,
                        parking: newBooking.parking ? 'Ja' : 'Nein',
                        arrival_time: newBooking.arrivalTime,
                        departure_time: newBooking.departureTime,
                        comment: newBooking.comment,
                        _subject: translations[currentLang]['Buchung von'] + ' ' + newBooking.name
                    };

                    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID_BOOKING, templateParams, EMAILJS_PUBLIC_KEY);

                    // Zeige Erfolgsmeldung und Details
                    bookingForm.style.display = "none";
                    bookingSuccess.style.display = "block";
                    document.getElementById('success-details').innerHTML = `
                        <p><strong>${translations[currentLang]['Name']}:</strong> ${newBooking.name}</p>
                        <p><strong>${translations[currentLang]['E-Mail']}:</strong> ${newBooking.email}</p>
                        <p><strong>${translations[currentLang]['Startdatum']}:</strong> ${newBooking.startDate}</p>
                        <p><strong>${translations[currentLang]['Enddatum']}:</strong> ${newBooking.endDate}</p>
                        <p><strong>${translations[currentLang]['Anzahl Personen * (max. 3)']}:</strong> ${newBooking.persons}</p>
                        <p><strong>${translations[currentLang]['Frühstück benötigt? *']}:</strong> ${newBooking.breakfast}</p>
                        <p><strong>${translations[currentLang]['Parkplatz benötigt?']}:</strong> ${newBooking.parking ? translations[currentLang]['Ja'] : translations[currentLang]['Nein']}</p>
                        <p><strong>${translations[currentLang]['Bemerkungen (optional, max. 200 Zeichen)']}:</strong> ${newBooking.comment || '-'}</p>
                    `;
                    bookingSuccess.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    renderYearlyCalendar(currentYear);
                } catch (error) {
                    console.error("Fehler beim Senden der E-Mail:", error);
                    showNotification(translations[currentLang]['Buchung erfolgreich, aber E-Mail konnte nicht gesendet werden. Bitte kontaktiere den Admin.'], true);
                }
            });

            // -------------------
            // Admin Bereich
            // -------------------
            const adminBookingsList = document.getElementById("admin-bookings-list");
            const adminBookingFormContainer = document.getElementById('admin-booking-form-container');

            function showAdminBookingForm() {
                if(!selectedStartDate || !selectedEndDate) return;
                document.getElementById('admin-book-start-date').value = formatDate(selectedStartDate);
                document.getElementById('admin-book-end-date').value = formatDate(selectedEndDate);
                adminBookingFormContainer.style.display = 'block';
                adminBookingFormContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            document.getElementById('admin-booking-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById("admin-book-name").value.trim();
                const email = document.getElementById("admin-book-email").value.trim();
                const startDate = document.getElementById("admin-book-start-date").value;
                const endDate = document.getElementById("admin-book-end-date").value;

                if (!name) { showNotification(translations[currentLang]['Bitte einen Namen eingeben.'], true); return; }
                if (!email) { showNotification(translations[currentLang]['Bitte eine gültige E-Mail-Adresse eingeben.'], true); return; }
                if (endDate < startDate) { showNotification(translations[currentLang]['Das Enddatum darf nicht vor dem Startdatum liegen.'], true); return; }

                const newBooking = {
                    name,
                    email,
                    startDate,
                    endDate,
                    cancellationId: generateCancellationId(),
                    status: 'active'
                };
                await db.collection('bookings').add(newBooking);
                showNotification(translations[currentLang]['Manuelle Buchung von %s bis %s erfolgreich hinzugefügt!'].replace('%s', startDate).replace('%s', endDate));
                adminBookingFormContainer.style.display = 'none';
                document.getElementById('admin-booking-form').reset();
                selectedStartDate = null;
                selectedEndDate = null;
                renderYearlyCalendar(currentYear);
                renderAdminBookings();
                renderStats();
            });

            document.getElementById('btn-cancel-admin-form').addEventListener('click', () => {
                adminBookingFormContainer.style.display = 'none';
                document.getElementById('admin-booking-form').reset();
                selectedStartDate = null;
                selectedEndDate = null;
                updateSelectedDays();
            });

            async function renderAdminBookings() {
                const bookings = await fetchBookings();
                const blocks = await fetchBlocks();
                const bookingTableHeaders = [translations[currentLang]['Typ'], translations[currentLang]['Name'], translations[currentLang]['E-Mail'], translations[currentLang]['Bemerkungen'], translations[currentLang]['Startdatum'], translations[currentLang]['Enddatum'], translations[currentLang]['Aktion']];

                let html = `<table><thead><tr><th>${bookingTableHeaders.join('</th><th>')}</th></tr></thead><tbody>`;

                bookings.sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
                blocks.sort((a,b) => new Date(a.startDate) - new Date(b.startDate));

                bookings.forEach(bk => {
                    const statusText = bk.status === 'active' ? translations[currentLang]['Buchung'] : translations[currentLang]['Storniert'];
                    const actionBtn = bk.status === 'active'
                        ? `<button class="btn-cancel-booking" data-id="${bk.id}" style="background-color: #f44336; padding:5px 10px;">${translations[currentLang]['Stornieren']}</button>
                           <button class="btn-send-reminder" data-id="${bk.id}" style="background-color: #3f51b5; padding:5px 10px;">${translations[currentLang]['Erinnerung']}</button>`
                        : `<button class="btn-delete-booking" data-id="${bk.id}" style="background-color: #757575; padding:5px 10px;">${translations[currentLang]['Löschen']}</button>`;

                    html += `<tr>
                        <td>${statusText}</td>
                        <td>${bk.name || '-'}</td>
                        <td>${bk.email || '-'}</td>
                        <td>${bk.comment || '-'}</td>
                        <td>${bk.startDate}</td>
                        <td>${bk.endDate}</td>
                        <td>${actionBtn}</td>
                    </tr>`;
                });

                blocks.forEach(bl => {
                    html += `<tr>
                        <td>${translations[currentLang]['Blockiert']}</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>${bl.startDate}</td>
                        <td>${bl.endDate}</td>
                        <td><button class="btn-delete-block" data-id="${bl.id}" style="background-color: #757575; padding:5px 10px;">${translations[currentLang]['Freigeben']}</button></td>
                    </tr>`;
                });

                html += "</tbody></table>";
                adminBookingsList.innerHTML = html;

                document.querySelectorAll(".btn-cancel-booking").forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if(confirm(translations[currentLang]['Buchung wirklich stornieren?'])) {
                            const id = btn.getAttribute("data-id");
                            const bookingToCancel = bookings.find(b => b.id === id);
                            if (bookingToCancel) {
                                await cancelBookingWithNotification(bookingToCancel, true);
                            }
                        }
                    });
                });
                document.querySelectorAll(".btn-delete-booking").forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if(confirm(translations[currentLang]['Buchung wirklich löschen?'])) {
                            const id = btn.getAttribute("data-id");
                            await db.collection('bookings').doc(id).delete();
                            showNotification(translations[currentLang]['Buchung erfolgreich gelöscht.']);
                            renderAdminBookings();
                            renderYearlyCalendar(currentYear);
                            renderStats();
                        }
                    });
                });
                document.querySelectorAll(".btn-delete-block").forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if(confirm(translations[currentLang]['Blockierung wirklich entfernen?'])) {
                            const id = btn.getAttribute("data-id");
                            await deleteBlock(id);
                            showNotification(translations[currentLang]['Blockierung erfolgreich entfernt.']);
                            renderAdminBookings();
                            renderYearlyCalendar(currentYear);
                            renderStats();
                        }
                    });
                });
                document.querySelectorAll(".btn-send-reminder").forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const id = btn.getAttribute("data-id");
                        const booking = bookings.find(b => b.id === id);
                        if (booking) {
                            if (booking.status === 'cancelled') {
                                showNotification(translations[currentLang]['Diese Buchung ist bereits storniert.'], true);
                                return;
                            }
                            try {
                                const templateParams = {
                                    from_name: 'Admin',
                                    to_email: booking.email,
                                    admin_email: ADMIN_EMAIL,
                                    start_date: booking.startDate,
                                    end_date: booking.endDate,
                                    _subject: translations[currentLang]['Erinnerung an Ihre bevorstehende Buchung']
                                };
                                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID_REMINDER, templateParams, EMAILJS_PUBLIC_KEY);
                                showNotification(translations[currentLang]['Erinnerungs-E-Mail erfolgreich gesendet!']);
                            } catch (error) {
                                console.error("Fehler beim Senden der Erinnerungs-E-Mail:", error);
                                showNotification(translations[currentLang]['Fehler beim Senden der Erinnerungs-E-Mail.'], true);
                            }
                        }
                    });
                });
            }

            async function cancelBookingWithNotification(booking, isAdminAction) {
                try {
                    await updateBookingStatus(booking.id, 'cancelled');
                    
                    const templateParams = {
                        to_email: booking.email,
                        admin_email: ADMIN_EMAIL,
                        start_date: booking.startDate,
                        end_date: booking.endDate,
                        admin_action: isAdminAction ? translations[currentLang]['Ja'] : translations[currentLang]['Nein'],
                        _subject: translations[currentLang]['Ihre Buchung wurde storniert']
                    };

                    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID_CANCEL, templateParams, EMAILJS_PUBLIC_KEY);
                    showNotification(translations[currentLang]['Buchung von %s erfolgreich storniert. Bestätigung wurde per E-Mail gesendet.'].replace('%s', booking.name));
                    
                    renderAdminBookings();
                    renderYearlyCalendar(currentYear);
                    renderStats();
                } catch (error) {
                    console.error("Fehler beim Stornieren der Buchung:", error);
                    showNotification(translations[currentLang]['Ein Fehler ist aufgetreten. Die Buchung konnte nicht storniert werden.'], true);
                }
            }


            // -------------------
            // Statistiken
            // -------------------
            async function renderStats() {
                const bookings = await fetchBookings();
                const activeBookings = bookings.filter(b => b.status === 'active' && new Date(b.endDate).getFullYear() === currentYear);
                const cancelledBookings = bookings.filter(b => b.status === 'cancelled' && new Date(b.endDate).getFullYear() === currentYear);
                const blocks = await fetchBlocks();
                const totalDaysInYear = 365;

                const totalStayDays = activeBookings.reduce((sum, b) => sum + getDaysBetween(b.startDate, b.endDate), 0);
                const avgStay = activeBookings.length > 0 ? (totalStayDays / activeBookings.length).toFixed(1) : 0;

                const allOccupiedDays = new Set();
                activeBookings.forEach(b => {
                    let day = dateFromStr(b.startDate);
                    while (day <= dateFromStr(b.endDate)) {
                        if (day.getFullYear() === currentYear) {
                            allOccupiedDays.add(formatDate(day));
                        }
                        day.setDate(day.getDate() + 1);
                    }
                });
                blocks.forEach(b => {
                    let day = dateFromStr(b.startDate);
                    while (day <= dateFromStr(b.endDate)) {
                        if (day.getFullYear() === currentYear) {
                            allOccupiedDays.add(formatDate(day));
                        }
                        day.setDate(day.getDate() + 1);
                    }
                });

                const occupancy = ((allOccupiedDays.size / totalDaysInYear) * 100).toFixed(1);

                document.getElementById('stat-active-bookings').textContent = activeBookings.length;
                document.getElementById('stat-cancelled-bookings').textContent = cancelledBookings.length;
                document.getElementById('stat-avg-stay').textContent = avgStay;
                document.getElementById('stat-occupancy').textContent = `${occupancy}%`;
            }

            // -------------------
            // Blockieren/Freigeben direkt im Kalender (Admin)
            // -------------------
            document.getElementById("btn-block-selected").addEventListener('click', async () => {
                if (!selectedStartDate || !selectedEndDate) {
                    showNotification(translations[currentLang]['Bitte wähle zuerst einen Zeitraum im Kalender aus.'], true);
                    return;
                }

                const startDate = formatDate(selectedStartDate <= selectedEndDate ? selectedStartDate : selectedEndDate);
                const endDate = formatDate(selectedStartDate <= selectedEndDate ? selectedEndDate : selectedStartDate);

                const bookings = await fetchBookings();

                const rangeStart = dateFromStr(startDate);
                const rangeEnd = dateFromStr(endDate);
                let day = new Date(rangeStart);
                while (day <= rangeEnd) {
                    const dayStr = formatDate(day);
                    if (bookings.some(b => b.status === 'active' && checkOverlap(dayStr, dayStr, b.startDate, b.endDate))) {
                        showNotification(translations[currentLang]['Der ausgewählte Zeitraum überschneidet sich mit einer bestehenden Buchung.'], true);
                        return;
                    }
                    day.setDate(day.getDate() + 1);
                }

                await db.collection('blocks').add({startDate, endDate});
                showNotification(translations[currentLang]['Zeitraum von %s bis %s erfolgreich blockiert.'].replace('%s', startDate).replace('%s', endDate));
                selectedStartDate = null;
                selectedEndDate = null;
                renderAdminBookings();
                renderYearlyCalendar(currentYear);
                renderStats();
            });

            document.getElementById("btn-unblock-selected").addEventListener('click', async () => {
                if (!selectedStartDate || !selectedEndDate) {
                    showNotification(translations[currentLang]['Bitte wähle zuerst einen Zeitraum im Kalender aus.'], true);
                    return;
                }

                const startDate = formatDate(selectedStartDate <= selectedEndDate ? selectedStartDate : selectedEndDate);
                const endDate = formatDate(selectedStartDate <= selectedEndDate ? selectedEndDate : selectedStartDate);

                if (confirm(translations[currentLang]['Sollen die Tage von %s bis %s wirklich freigegeben werden?'].replace('%s', startDate).replace('%s', endDate))) {
                    const blocks = await fetchBlocks();
                    let blocksToRemove = blocks.filter(block => checkOverlap(block.startDate, block.endDate, startDate, endDate));

                    if (blocksToRemove.length > 0) {
                        const batch = db.batch();
                        blocksToRemove.forEach(block => {
                            const docRef = db.collection('blocks').doc(block.id);
                            batch.delete(docRef);
                        });
                        await batch.commit();

                        showNotification(translations[currentLang]['Tage erfolgreich freigegeben!']);
                    } else {
                        showNotification(translations[currentLang]['Keine Blockierung im ausgewählten Zeitraum gefunden.']);
                    }

                    selectedStartDate = null;
                    selectedEndDate = null;
                    renderAdminBookings();
                    renderYearlyCalendar(currentYear);
                    renderStats();
                }
            });


            // CSV-Export-Funktion
            async function exportBookingsToCsv() {
                const bookings = await fetchBookings();
                if (bookings.length === 0) {
                    showNotification(translations[currentLang]['Keine Buchungen zum Exportieren vorhanden.'], true);
                    return;
                }

                const csvRows = [];
                const headers = ["Name", "E-Mail", "Personen", "Frühstück", "Parkplatz", "Anreisezeit", "Abreisezeit", "Bemerkungen", "Startdatum", "Enddatum", "Status"];
                csvRows.push(headers.join(';'));

                for (const booking of bookings) {
                    const row = [
                        booking.name || "",
                        booking.email || "",
                        booking.persons || "",
                        booking.breakfast || "",
                        booking.parking ? translations[currentLang]['Ja'] : translations[currentLang]['Nein'],
                        booking.arrivalTime || "",
                        booking.departureTime || "",
                        booking.comment || "",
                        booking.startDate,
                        booking.endDate,
                        booking.status === 'active' ? translations[currentLang]['Buchung'] : translations[currentLang]['Storniert']
                    ];
                    csvRows.push(row.map(cell => `"${cell}"`).join(';'));
                }

                const csvString = csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `Freunde_Buchungen_${new Date().toISOString().slice(0, 10)}.csv`;
                link.click();
            }

            document.getElementById("btn-export-csv").addEventListener('click', exportBookingsToCsv);

            // -------------------
            // Stornierungslogik (Buchender)
            // -------------------
            async function handleCancellationLink(cancellationId) {
                showSection('cancel');
                const statusText = document.getElementById('cancel-status-text');
                const detailsDiv = document.getElementById('cancel-details');
                const buttonsDiv = document.getElementById('cancel-buttons');

                buttonsDiv.style.display = 'none';
                detailsDiv.innerHTML = '';

                const bookingsRef = db.collection('bookings').where('cancellationId', '==', cancellationId);
                const querySnapshot = await bookingsRef.get();

                if (querySnapshot.empty) {
                    statusText.textContent = translations[currentLang]['Ungültiger oder bereits stornierter Buchungslink.'];
                    return;
                }

                const doc = querySnapshot.docs[0];
                const booking = doc.data();
                const bookingId = doc.id;

                if (booking.status === 'cancelled') {
                    statusText.textContent = translations[currentLang]['Diese Buchung ist bereits storniert.'];
                    return;
                }

                statusText.textContent = translations[currentLang]['Buchungsdetails:'];
                detailsDiv.innerHTML = `
                    <p><strong>${translations[currentLang]['Name']}:</strong> ${booking.name}</p>
                    <p><strong>${translations[currentLang]['E-Mail']}:</strong> ${booking.email}</p>
                    <p><strong>${translations[currentLang]['Bemerkungen']}:</strong> ${booking.comment || '-'}</p>
                    <p><strong>${translations[currentLang]['Zeitraum']}:</strong> ${booking.startDate} ${translations[currentLang]['bis']} ${booking.endDate}</p>
                    <p><strong>${translations[currentLang]['Personen']}:</strong> ${booking.persons}</p>
                `;
                buttonsDiv.style.display = 'block';

                document.getElementById('btn-confirm-cancellation').onclick = async () => {
                    if (confirm(translations[currentLang]['Soll die Buchung von %s wirklich storniert werden?'].replace('%s', booking.name))) {
                        await cancelBookingWithNotification({id: bookingId, ...booking}, false);
                        statusText.textContent = translations[currentLang]['Ihre Buchung wurde erfolgreich storniert.'];
                        buttonsDiv.style.display = 'none';
                    }
                };
                document.getElementById('btn-return-home').onclick = () => {
                    window.location.href = window.location.origin + window.location.pathname;
                };
            }

            // Initialanzeige
            function initialize() {
                const today = new Date();
                currentYear = today.getFullYear();

                if (currentYear < CAL_START_YEAR) {
                    currentYear = CAL_START_YEAR;
                } else if (currentYear > CAL_END_YEAR) {
                    currentYear = CAL_END_YEAR;
                }

                const urlParams = new URLSearchParams(window.location.search);
                const cancellationId = urlParams.get('cancelId');

                if (cancellationId) {
                    handleCancellationLink(cancellationId);
                } else {
                    showSection("start");
                    translatePage(currentLang);
                }
            }

            initialize();
        })();
    </script>
</body>
</html>
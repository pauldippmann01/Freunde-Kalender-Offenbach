<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gast Kalender Offenbach</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVK+jJdG7y6Dq2T2n6m3hU7I6t0y7sC6XFvA6X/m0Pz06x3Vq5tA7M7O4x4E4S4C7x7D6y8A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() {
            emailjs.init('{{YOUR_EMAILJS_PUBLIC_KEY}}'); // Replace with your Public Key
        })();
    </script>
    <style>
        :root {
            --primary-color: #004d40;
            --secondary-color: #388e3c;
            --accent-color: #d32f2f;
            --background-color: #f5f5f5;
            --card-background: #ffffff;
            --text-color: #212121;
        }

        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            width: 100%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: relative;
        }

        header h1 {
            margin: 0;
            font-weight: 700;
        }

        .language-switcher {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }

        .language-switcher select {
            background: transparent;
            border: 1px solid white;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .language-switcher select option {
            color: var(--primary-color);
        }

        main {
            padding: 1rem;
            max-width: 900px;
            width: 100%;
            flex-grow: 1;
        }

        .container {
            display: none;
            background-color: var(--card-background);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }

        #calender-view {
            text-align: center;
        }

        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .calendar-nav button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        .calendar-nav button:hover {
            background-color: var(--secondary-color);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }

        .day-header, .day {
            padding: 10px 5px;
            border-radius: 4px;
            font-weight: bold;
        }

        .day-header {
            background-color: #e0e0e0;
        }

        .day {
            background-color: #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .day.weekend {
            background-color: #e8e8e8;
        }

        .day:not(.booked):not(.disabled):not(.weekend):hover {
            background-color: #c8e6c9;
        }

        .day.disabled {
            color: #b0b0b0;
            cursor: not-allowed;
        }

        .day.booked {
            background-color: var(--accent-color);
            color: white;
            cursor: not-allowed;
        }
        .day.partial {
            background-color: #ffb74d; /* Orange for partial booking */
            color: black;
            cursor: pointer;
        }

        .day.partial:hover {
            background-color: #ff9800; /* Darker orange on hover */
        }

        .day.available {
            background-color: var(--secondary-color);
            color: white;
            cursor: pointer;
        }

        .day.available:hover {
            background-color: #2e7d32;
        }

        .day.today {
            border: 2px solid var(--primary-color);
            background-color: #c8e6c9;
        }

        #booking-form h2 {
            text-align: center;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #booking-form button {
            display: block;
            width: 100%;
            padding: 0.75rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
        }

        #booking-form button:hover {
            background-color: var(--secondary-color);
        }

        .message-box {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 4px;
            background-color: #e0f2f1;
            color: var(--primary-color);
        }

        .admin-login {
            text-align: center;
            margin-top: 2rem;
        }

        .admin-login a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: bold;
        }

        .admin-login a:hover {
            text-decoration: underline;
        }

        #admin-panel form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-width: 400px;
            margin: 0 auto;
        }
        #admin-panel form input, #admin-panel form button {
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #admin-panel form button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
        }
        #admin-panel form button:hover {
            background-color: var(--secondary-color);
        }

        #booking-list ul, #statistics ul {
            list-style-type: none;
            padding: 0;
        }
        #booking-list li {
            background-color: #e0e0e0;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
        }

        .booking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .booking-item-details {
            flex-grow: 1;
        }

        .booking-item-actions button {
            margin-left: 0.5rem;
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .booking-item-actions button:hover {
            background-color: #b71c1c;
        }

        .sub-menu {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .sub-menu button {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }
        .sub-menu button.active {
            background-color: var(--primary-color);
            color: white;
        }

        .status-message {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f0f4c3;
            border-radius: 4px;
            display: none;
        }

        .cancellation-page {
            text-align: center;
        }

        .cancellation-page .buttons-div {
            margin-top: 1rem;
        }
        .cancellation-page button {
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
        }
        #btn-confirm-cancellation {
            background-color: var(--accent-color);
            color: white;
            border: none;
        }
        #btn-return-home {
            background-color: #ccc;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <header>
        <div class="language-switcher">
            <select id="lang-select">
                <option value="de">Deutsch</option>
                <option value="en">English</option>
            </select>
        </div>
        <h1><span class="translate" data-key="Gast Kalender Offenbach"></span></h1>
    </header>

    <main>
        <div id="start-section" class="container">
            <h2 class="translate" data-key="Willkommen!"></h2>
            <p class="translate" data-key="Willkommenstext"></p>
            <form id="password-form">
                <div class="form-group">
                    <label for="password"><span class="translate" data-key="Passwort"></span>:</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit"><span class="translate" data-key="Anzeigen"></span></button>
            </form>
        </div>

        <div id="calender-view" class="container">
            <div class="calendar-nav">
                <button id="prev-month">&lt;</button>
                <h2 id="month-year"></h2>
                <button id="next-month">&gt;</button>
            </div>
            <div class="calendar-grid" id="calendar">
                <div class="day-header translate" data-key="Mo"></div>
                <div class="day-header translate" data-key="Di"></div>
                <div class="day-header translate" data-key="Mi"></div>
                <div class="day-header translate" data-key="Do"></div>
                <div class="day-header translate" data-key="Fr"></div>
                <div class="day-header translate" data-key="Sa"></div>
                <div class="day-header translate" data-key="So"></div>
            </div>
            <div id="booking-modal" style="display: none;">
                <h3 id="modal-date"></h3>
                <p id="modal-status"></p>
                <button id="book-button" style="display:none;"></button>
            </div>
        </div>

        <div id="booking-form" class="container">
            <h2 id="form-date-display"></h2>
            <form id="booking-details-form">
                <div class="form-group">
                    <label for="name"><span class="translate" data-key="Name"></span>:</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="email"><span class="translate" data-key="E-Mail"></span>:</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="phone"><span class="translate" data-key="Mobilfunknummer"></span>:</label>
                    <input type="tel" id="phone" name="phone" required>
                </div>
                <div class="form-group">
                    <label for="notes"><span class="translate" data-key="Hinweise"></span>:</label>
                    <textarea id="notes" name="notes"></textarea>
                </div>
                <button type="submit"><span class="translate" data-key="Buchen"></span></button>
            </form>
            <div class="message-box" id="form-message" style="display: none;"></div>
        </div>

        <div id="cancellation-page" class="container cancellation-page">
            <h2 class="translate" data-key="Buchung stornieren"></h2>
            <p id="status-text"></p>
            <div class="buttons-div" style="display: none;">
                <button id="btn-confirm-cancellation"><span class="translate" data-key="Ja, Buchung stornieren"></span></button>
                <button id="btn-return-home"><span class="translate" data-key="Zurück zur Startseite"></span></button>
            </div>
        </div>

        <div id="admin-panel" class="container">
            <h2 class="translate" data-key="Admin-Bereich"></h2>
            <form id="admin-password-form">
                <div class="form-group">
                    <label for="admin-password"><span class="translate" data-key="Admin-Passwort"></span>:</label>
                    <input type="password" id="admin-password" required>
                </div>
                <button type="submit"><span class="translate" data-key="Anmelden"></span></button>
            </form>

            <div id="admin-dashboard" style="display:none;">
                <p class="translate" data-key="admin-willkommen"></p>
                <div class="sub-menu">
                    <button id="btn-show-bookings" class="translate" data-key="Buchungen anzeigen"></button>
                    <button id="btn-show-block-dates" class="translate" data-key="Tage blockieren"></button>
                    <button id="btn-show-stats" class="translate" data-key="Statistiken anzeigen"></button>
                    <button id="btn-export-csv" class="translate" data-key="Export CSV"></button>
                </div>

                <div id="booking-list" style="display:none;">
                    <h3 class="translate" data-key="Buchungsliste"></h3>
                    <ul id="bookings-ul"></ul>
                </div>

                <div id="block-dates" style="display:none;">
                    <h3 class="translate" data-key="Tage blockieren/freigeben"></h3>
                    <input type="date" id="block-date">
                    <button id="btn-block-date" class="translate" data-key="Tag blockieren"></button>
                    <button id="btn-unblock-date" class="translate" data-key="Tag freigeben"></button>
                    <div class="status-message" id="block-status-message"></div>
                </div>

                <div id="statistics" style="display:none;">
                    <h3 class="translate" data-key="Statistiken"></h3>
                    <ul id="stats-ul"></ul>
                </div>
            </div>
        </div>

        <div id="booking-confirmation" class="container" style="display: none;">
            <h2 class="translate" data-key="Buchungsbestätigung"></h2>
            <p><span class="translate" data-key="Buchungsbestätigungstext"></span></p>
        </div>

        <div id="admin-logout" style="display:none;">
            <button id="btn-logout" class="translate" data-key="Abmelden"></button>
        </div>

        <p id="status-message" style="display: none;"></p>
    </main>

    <script>
        (function() {
            // Configuration
            const GUEST_PASSWORD = "gast"; // Guest password
            const ADMIN_PASSWORD = "admin"; // Admin password
            const CAL_START_YEAR = 2024;
            const CAL_END_YEAR = 2025;

            // EmailJS Service/Template IDs
            const EMAILJS_SERVICE_ID = '{{YOUR_EMAILJS_SERVICE_ID}}';
            const EMAILJS_TEMPLATE_ID = '{{YOUR_EMAILJS_TEMPLATE_ID}}';
            const EMAILJS_CANCEL_TEMPLATE_ID = '{{YOUR_EMAILJS_CANCEL_TEMPLATE_ID}}';

            // Translations
            const translations = {
                de: {
                    "Gast Kalender Offenbach": "Gast Kalender Offenbach",
                    "Willkommen!": "Willkommen!",
                    "Willkommenstext": "Bitte geben Sie das Passwort ein, um den Kalender anzuzeigen.",
                    "Passwort": "Passwort",
                    "Anzeigen": "Anzeigen",
                    "Buchung stornieren": "Buchung stornieren",
                    "Ja, Buchung stornieren": "Ja, Buchung stornieren",
                    "Zurück zur Startseite": "Zurück zur Startseite",
                    "Admin-Bereich": "Admin-Bereich",
                    "Admin-Passwort": "Admin-Passwort",
                    "Anmelden": "Anmelden",
                    "Buchungsbestätigung": "Buchungsbestätigung",
                    "Buchungsbestätigungstext": "Vielen Dank für Ihre Buchung! Sie erhalten in Kürze eine Bestätigungs-E-Mail.",
                    "Abmelden": "Abmelden",
                    "Montag": "Montag",
                    "Dienstag": "Dienstag",
                    "Mittwoch": "Mittwoch",
                    "Donnerstag": "Donnerstag",
                    "Freitag": "Freitag",
                    "Samstag": "Samstag",
                    "Sonntag": "Sonntag",
                    "Mo": "Mo", "Di": "Di", "Mi": "Mi", "Do": "Do", "Fr": "Fr", "Sa": "Sa", "So": "So",
                    "Januar": "Januar", "Februar": "Februar", "März": "März", "April": "April", "Mai": "Mai", "Juni": "Juni", "Juli": "Juli", "August": "August", "September": "September", "Oktober": "Oktober", "November": "November", "Dezember": "Dezember",
                    "Verfügbar": "Verfügbar",
                    "Teilweise verfügbar": "Teilweise verfügbar",
                    "Gebucht": "Gebucht",
                    "Jetzt buchen": "Jetzt buchen",
                    "Tag blockieren": "Tag blockieren",
                    "Tag freigeben": "Tag freigeben",
                    "Buchungen anzeigen": "Buchungen anzeigen",
                    "Tage blockieren": "Tage blockieren",
                    "Statistiken anzeigen": "Statistiken anzeigen",
                    "Export CSV": "Export CSV",
                    "Buchungsliste": "Buchungsliste",
                    "Tage blockieren/freigeben": "Tage blockieren/freigeben",
                    "Statistiken": "Statistiken",
                    "admin-willkommen": "Willkommen im Admin-Bereich.",
                    "Name": "Name",
                    "E-Mail": "E-Mail",
                    "Mobilfunknummer": "Mobilfunknummer",
                    "Hinweise": "Hinweise (optional)",
                    "Buchen": "Buchen",
                    "Ungültiges Passwort.": "Ungültiges Passwort.",
                    "Ungültige Buchungsdaten.": "Ungültige Buchungsdaten.",
                    "Datum": "Datum",
                    "Name (Gast)": "Name (Gast)",
                    "E-Mail (Gast)": "E-Mail (Gast)",
                    "Mobilfunknummer (Gast)": "Mobilfunknummer (Gast)",
                    "Hinweise (Gast)": "Hinweise (Gast)",
                    "Soll die Buchung von %s wirklich storniert werden?": "Soll die Buchung von %s wirklich storniert werden?",
                    "Buchung erfolgreich storniert.": "Buchung erfolgreich storniert.",
                    "Ihre Buchung wurde erfolgreich storniert.": "Ihre Buchung wurde erfolgreich storniert.",
                    "Fehler beim Stornieren.": "Fehler beim Stornieren.",
                    "Buchung nicht gefunden oder bereits storniert.": "Buchung nicht gefunden oder bereits storniert.",
                    "Bitte füllen Sie alle Pflichtfelder aus.": "Bitte füllen Sie alle Pflichtfelder aus.",
                    "Tag erfolgreich blockiert.": "Tag erfolgreich blockiert.",
                    "Tag erfolgreich freigegeben.": "Tag erfolgreich freigegeben.",
                    "Fehler beim Aktualisieren des Tages.": "Fehler beim Aktualisieren des Tages.",
                    "Bitte geben Sie ein Datum ein.": "Bitte geben Sie ein Datum ein.",
                    "Unbekannter Fehler.": "Unbekannter Fehler.",
                    "Export erfolgreich.": "Export erfolgreich.",
                    "Fehler beim Exportieren.": "Fehler beim Exportieren."
                },
                en: {
                    "Gast Kalender Offenbach": "Guest Calendar Offenbach",
                    "Willkommen!": "Welcome!",
                    "Willkommenstext": "Please enter the password to view the calendar.",
                    "Passwort": "Password",
                    "Anzeigen": "Show",
                    "Buchung stornieren": "Cancel Booking",
                    "Ja, Buchung stornieren": "Yes, cancel booking",
                    "Zurück zur Startseite": "Back to Home",
                    "Admin-Bereich": "Admin Panel",
                    "Admin-Passwort": "Admin Password",
                    "Anmelden": "Login",
                    "Buchungsbestätigung": "Booking Confirmation",
                    "Buchungsbestätigungstext": "Thank you for your booking! You will receive a confirmation email shortly.",
                    "Abmelden": "Logout",
                    "Montag": "Monday",
                    "Dienstag": "Tuesday",
                    "Mittwoch": "Wednesday",
                    "Donnerstag": "Thursday",
                    "Freitag": "Friday",
                    "Samstag": "Saturday",
                    "Sonntag": "Sunday",
                    "Mo": "Mon", "Di": "Tue", "Mi": "Wed", "Do": "Thu", "Fr": "Fri", "Sa": "Sat", "So": "Sun",
                    "Januar": "January", "Februar": "February", "März": "March", "April": "April", "Mai": "May", "Juni": "June", "Juli": "July", "August": "August", "September": "September", "Oktober": "October", "November": "November", "Dezember": "December",
                    "Verfügbar": "Available",
                    "Teilweise verfügbar": "Partially available",
                    "Gebucht": "Booked",
                    "Jetzt buchen": "Book Now",
                    "Tag blockieren": "Block Day",
                    "Tag freigeben": "Unblock Day",
                    "Buchungen anzeigen": "Show Bookings",
                    "Tage blockieren": "Block Days",
                    "Statistiken anzeigen": "Show Statistics",
                    "Export CSV": "Export CSV",
                    "Buchungsliste": "Booking List",
                    "Tage blockieren/freigeben": "Block/Unblock Days",
                    "Statistiken": "Statistics",
                    "admin-willkommen": "Welcome to the Admin Panel.",
                    "Name": "Name",
                    "E-Mail": "Email",
                    "Mobilfunknummer": "Mobile number",
                    "Hinweise": "Notes (optional)",
                    "Buchen": "Book",
                    "Ungültiges Passwort.": "Invalid password.",
                    "Ungültige Buchungsdaten.": "Invalid booking data.",
                    "Datum": "Date",
                    "Name (Gast)": "Name (Guest)",
                    "E-Mail (Gast)": "Email (Guest)",
                    "Mobilfunknummer (Gast)": "Mobile number (Guest)",
                    "Hinweise (Gast)": "Notes (Guest)",
                    "Soll die Buchung von %s wirklich storniert werden?": "Are you sure you want to cancel the booking for %s?",
                    "Buchung erfolgreich storniert.": "Booking successfully cancelled.",
                    "Ihre Buchung wurde erfolgreich storniert.": "Your booking has been successfully cancelled.",
                    "Fehler beim Stornieren.": "Error cancelling booking.",
                    "Buchung nicht gefunden oder bereits storniert.": "Booking not found or already cancelled.",
                    "Bitte füllen Sie alle Pflichtfelder aus.": "Please fill in all required fields.",
                    "Tag erfolgreich blockiert.": "Day successfully blocked.",
                    "Tag erfolgreich freigegeben.": "Day successfully unblocked.",
                    "Fehler beim Aktualisieren des Tages.": "Error updating the day.",
                    "Bitte geben Sie ein Datum ein.": "Please enter a date.",
                    "Unbekannter Fehler.": "Unknown error.",
                    "Export erfolgreich.": "Export successful.",
                    "Fehler beim Exportieren.": "Error exporting."
                }
            };

            // Firebase Config
            const firebaseConfig = {
                apiKey: "{{YOUR_FIREBASE_API_KEY}}",
                authDomain: "{{YOUR_FIREBASE_AUTH_DOMAIN}}",
                projectId: "{{YOUR_FIREBASE_PROJECT_ID}}",
                storageBucket: "{{YOUR_FIREBASE_STORAGE_BUCKET}}",
                messagingSenderId: "{{YOUR_FIREBASE_MESSAGING_SENDER_ID}}",
                appId: "{{YOUR_FIREBASE_APP_ID}}"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const bookingsCollection = db.collection("bookings");
            const settingsDoc = db.collection("settings").doc("calendar");

            // Element references
            const passwordForm = document.getElementById("password-form");
            const passwordInput = document.getElementById("password");
            const startSection = document.getElementById("start-section");
            const calenderView = document.getElementById("calender-view");
            const monthYearText = document.getElementById("month-year");
            const calendarGrid = document.getElementById("calendar");
            const bookingFormSection = document.getElementById("booking-form");
            const bookingForm = document.getElementById("booking-details-form");
            const formDateDisplay = document.getElementById("form-date-display");
            const nameInput = document.getElementById("name");
            const emailInput = document.getElementById("email");
            const phoneInput = document.getElementById("phone");
            const notesInput = document.getElementById("notes");
            const formMessage = document.getElementById("form-message");
            const bookingConfirmationSection = document.getElementById("booking-confirmation");
            const langSelect = document.getElementById("lang-select");
            const adminPanel = document.getElementById("admin-panel");
            const adminPasswordForm = document.getElementById("admin-password-form");
            const adminDashboard = document.getElementById("admin-dashboard");
            const btnLogout = document.getElementById("btn-logout");
            const bookingListSection = document.getElementById("booking-list");
            const bookingsUl = document.getElementById("bookings-ul");
            const btnShowBookings = document.getElementById("btn-show-bookings");
            const btnShowBlockDates = document.getElementById("btn-show-block-dates");
            const btnShowStats = document.getElementById("btn-show-stats");
            const btnExportCsv = document.getElementById("btn-export-csv");
            const blockDatesSection = document.getElementById("block-dates");
            const blockDateInput = document.getElementById("block-date");
            const btnBlockDate = document.getElementById("btn-block-date");
            const btnUnblockDate = document.getElementById("btn-unblock-date");
            const blockStatusMessage = document.getElementById("block-status-message");
            const statisticsSection = document.getElementById("statistics");
            const statsUl = document.getElementById("stats-ul");
            const cancellationPage = document.getElementById("cancellation-page");
            const statusText = document.getElementById("status-text");
            const buttonsDiv = document.querySelector("#cancellation-page .buttons-div");
            const btnConfirmCancellation = document.getElementById("btn-confirm-cancellation");
            const btnReturnHome = document.getElementById("btn-return-home");

            // State variables
            let currentYear;
            let currentMonth;
            let currentLang = 'de';
            let bookings = [];
            let blockedDates = [];
            let selectedDates = [];
            let isBookingActive = false;
            let isBlockDayActive = false;

            // Helper functions
            function translatePage(lang) {
                document.querySelectorAll('.translate').forEach(element => {
                    const key = element.getAttribute('data-key');
                    if (translations[lang][key]) {
                        element.textContent = translations[lang][key];
                    }
                });
                document.getElementById('lang-select').value = lang;
                renderCalendar();
            }

            function showSection(sectionId) {
                document.querySelectorAll('.container').forEach(section => {
                    section.style.display = 'none';
                });
                document.getElementById(sectionId).style.display = 'block';
                if (sectionId === 'admin-panel') {
                    document.getElementById('admin-logout').style.display = 'block';
                } else {
                    document.getElementById('admin-logout').style.display = 'none';
                }
            }

            async function fetchData() {
                try {
                    const [bookingsSnapshot, settingsSnapshot] = await Promise.all([
                        bookingsCollection.get(),
                        settingsDoc.get()
                    ]);
                    bookings = bookingsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    blockedDates = settingsSnapshot.exists ? settingsSnapshot.data().blockedDates || [] : [];
                    renderCalendar();
                } catch (e) {
                    console.error("Error fetching data: ", e);
                    alert(translations[currentLang]['Unbekannter Fehler.']);
                }
            }

            function renderCalendar() {
                calendarGrid.innerHTML = `
                    <div class="day-header translate" data-key="Mo"></div>
                    <div class="day-header translate" data-key="Di"></div>
                    <div class="day-header translate" data-key="Mi"></div>
                    <div class="day-header translate" data-key="Do"></div>
                    <div class="day-header translate" data-key="Fr"></div>
                    <div class="day-header translate" data-key="Sa"></div>
                    <div class="day-header translate" data-key="So"></div>
                `;

                const date = new Date(currentYear, currentMonth, 1);
                monthYearText.textContent = `${translations[currentLang][date.toLocaleString('de-DE', { month: 'long' })]} ${currentYear}`;
                const firstDayIndex = (date.getDay() + 6) % 7;
                const lastDay = new Date(currentYear, currentMonth + 1, 0).getDate();
                const today = new Date();

                for (let i = 0; i < firstDayIndex; i++) {
                    calendarGrid.innerHTML += `<div class="day disabled"></div>`;
                }

                for (let i = 1; i <= lastDay; i++) {
                    const dayDate = new Date(currentYear, currentMonth, i);
                    const isToday = dayDate.toDateString() === today.toDateString();
                    const dateStr = dayDate.toISOString().split('T')[0];

                    const isBlocked = blockedDates.includes(dateStr);
                    const bookingsForDay = bookings.filter(b => {
                        const start = new Date(b.startDate + 'T00:00:00');
                        const end = new Date(b.endDate + 'T00:00:00');
                        return dayDate >= start && dayDate <= end;
                    });
                    const isBooked = bookingsForDay.length > 0;
                    const isWeekend = dayDate.getDay() === 0 || dayDate.getDay() === 6;

                    let dayClass = 'day';
                    if (isToday) dayClass += ' today';
                    if (isWeekend) dayClass += ' weekend';

                    let content = i;
                    if (isBlocked) {
                        dayClass += ' disabled';
                    } else if (isBooked) {
                        dayClass += ' booked';
                    } else {
                        dayClass += ' available';
                    }

                    const dayElement = document.createElement('div');
                    dayElement.className = dayClass;
                    dayElement.textContent = content;
                    dayElement.dataset.date = dateStr;

                    dayElement.addEventListener('click', () => {
                        if (isBlocked) {
                            return;
                        }

                        if (isBookingActive) {
                            toggleSelectedDate(dateStr, dayElement);
                        } else if (isBlockDayActive) {
                            toggleBlockDate(dateStr, dayElement);
                        } else if (dayElement.classList.contains('available') || dayElement.classList.contains('partial')) {
                            const date = dayElement.dataset.date;
                            formDateDisplay.textContent = new Date(date).toLocaleDateString(currentLang, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                            showSection('booking-form');
                        }
                    });

                    calendarGrid.appendChild(dayElement);
                }
            }

            function toggleSelectedDate(dateStr, element) {
                if (element.classList.contains('selected')) {
                    element.classList.remove('selected');
                    selectedDates = selectedDates.filter(d => d !== dateStr);
                } else {
                    element.classList.add('selected');
                    selectedDates.push(dateStr);
                }
                selectedDates.sort();
            }

            function toggleBlockDate(dateStr, element) {
                if (element.classList.contains('blocked')) {
                    element.classList.remove('blocked');
                    selectedDates = selectedDates.filter(d => d !== dateStr);
                } else {
                    element.classList.add('blocked');
                    selectedDates.push(dateStr);
                }
            }

            async function addBooking(bookingData) {
                try {
                    await bookingsCollection.add(bookingData);
                    console.log("Booking added successfully");
                } catch (e) {
                    console.error("Error adding booking: ", e);
                    throw new Error("Error adding booking to Firestore.");
                }
            }

            async function sendBookingEmail(bookingData) {
                const templateParams = {
                    date: new Date(bookingData.startDate).toLocaleDateString(currentLang) + (bookingData.endDate ? ' - ' + new Date(bookingData.endDate).toLocaleDateString(currentLang) : ''),
                    name: bookingData.name,
                    email: bookingData.email,
                    mobileNumber: bookingData.phone,
                    notes: bookingData.notes,
                    cancellation_link: `${window.location.origin}${window.location.pathname}?cancelId=${bookingData.id}`
                };

                try {
                    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
                    console.log('Email successfully sent!');
                } catch (error) {
                    console.error('Failed to send email:', error);
                    throw new Error("Failed to send email confirmation.");
                }
            }

            function validateBookingForm() {
                const name = nameInput.value.trim();
                const email = emailInput.value.trim();
                const phone = phoneInput.value.trim();
                const notes = notesInput.value.trim();

                if (!name || !email || !phone) {
                    formMessage.textContent = translations[currentLang]['Bitte füllen Sie alle Pflichtfelder aus.'];
                    formMessage.style.display = 'block';
                    return false;
                }
                formMessage.style.display = 'none';
                return { name, email, phone, notes };
            }

            async function exportBookingsToCsv() {
                if (bookings.length === 0) {
                    alert('Keine Buchungen zum Exportieren.');
                    return;
                }
                const header = [
                    translations[currentLang]['Datum'],
                    translations[currentLang]['Name (Gast)'],
                    translations[currentLang]['E-Mail (Gast)'],
                    translations[currentLang]['Mobilfunknummer (Gast)'],
                    translations[currentLang]['Hinweise (Gast)']
                ];
                const rows = bookings.map(b => [
                    `${new Date(b.startDate).toLocaleDateString(currentLang)} - ${new Date(b.endDate).toLocaleDateString(currentLang)}`,
                    `"${b.name.replace(/"/g, '""')}"`,
                    `"${b.email.replace(/"/g, '""')}"`,
                    `"${b.phone.replace(/"/g, '""')}"`,
                    `"${(b.notes || '').replace(/"/g, '""')}"`
                ]);
                const csvContent = "data:text/csv;charset=utf-8," + header.join(";") + "\n" + rows.map(e => e.join(";")).join("\n");
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `bookings_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // Event listeners
            langSelect.addEventListener('change', (e) => {
                currentLang = e.target.value;
                translatePage(currentLang);
            });

            passwordForm.addEventListener("submit", (e) => {
                e.preventDefault();
                if (passwordInput.value === GUEST_PASSWORD) {
                    showSection('calender-view');
                    fetchData();
                } else if (passwordInput.value === ADMIN_PASSWORD) {
                    showSection('admin-panel');
                    adminDashboard.style.display = 'block';
                    document.getElementById('admin-password-form').style.display = 'none';
                } else {
                    alert(translations[currentLang]['Ungültiges Passwort.']);
                }
            });

            adminPasswordForm.addEventListener("submit", (e) => {
                e.preventDefault();
                if (document.getElementById("admin-password").value === ADMIN_PASSWORD) {
                    showSection('admin-panel');
                    adminDashboard.style.display = 'block';
                    document.getElementById('admin-password-form').style.display = 'none';
                    document.getElementById('admin-logout').style.display = 'block';
                } else {
                    alert(translations[currentLang]['Ungültiges Passwort.']);
                }
            });

            btnLogout.addEventListener('click', () => {
                showSection('start-section');
                document.getElementById('admin-password-form').style.display = 'block';
                adminDashboard.style.display = 'none';
                passwordInput.value = '';
                document.getElementById("admin-password").value = '';
            });

            btnShowBookings.addEventListener('click', async () => {
                document.querySelectorAll('#admin-dashboard > div').forEach(div => div.style.display = 'none');
                bookingListSection.style.display = 'block';
                bookingsUl.innerHTML = '';
                await fetchData();
                bookings.forEach(booking => {
                    const li = document.createElement('li');
                    const details = booking.endDate ? `${new Date(booking.startDate).toLocaleDateString(currentLang)} - ${new Date(booking.endDate).toLocaleDateString(currentLang)}` : `${new Date(booking.startDate).toLocaleDateString(currentLang)}`;
                    li.className = 'booking-item';
                    li.innerHTML = `
                        <div class="booking-item-details">
                            <strong>${details}</strong><br>
                            ${translations[currentLang]['Name (Gast)']}: ${booking.name}<br>
                            ${translations[currentLang]['E-Mail (Gast)']}: ${booking.email}<br>
                            ${translations[currentLang]['Mobilfunknummer (Gast)']}: ${booking.phone}<br>
                            ${translations[currentLang]['Hinweise (Gast)']}: ${booking.notes || '-'}
                        </div>
                        <div class="booking-item-actions">
                            <button class="cancel-booking" data-id="${booking.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    bookingsUl.appendChild(li);
                });
            });

            bookingsUl.addEventListener('click', async (e) => {
                if (e.target.classList.contains('cancel-booking') || e.target.closest('.cancel-booking')) {
                    const bookingId = e.target.closest('.cancel-booking').dataset.id;
                    const booking = bookings.find(b => b.id === bookingId);
                    if (confirm(translations[currentLang]['Soll die Buchung von %s wirklich storniert werden?'].replace('%s', booking.name))) {
                        await cancelBookingWithNotification(booking, true);
                        btnShowBookings.click();
                    }
                }
            });

            btnShowBlockDates.addEventListener('click', () => {
                document.querySelectorAll('#admin-dashboard > div').forEach(div => div.style.display = 'none');
                blockDatesSection.style.display = 'block';
            });

            btnBlockDate.addEventListener('click', async () => {
                const dateToBlock = blockDateInput.value;
                if (!dateToBlock) {
                    blockStatusMessage.textContent = translations[currentLang]['Bitte geben Sie ein Datum ein.'];
                    blockStatusMessage.style.display = 'block';
                    return;
                }
                blockedDates.push(dateToBlock);
                try {
                    await settingsDoc.set({ blockedDates }, { merge: true });
                    blockStatusMessage.textContent = translations[currentLang]['Tag erfolgreich blockiert.'];
                    blockStatusMessage.style.display = 'block';
                    fetchData();
                } catch (e) {
                    blockStatusMessage.textContent = translations[currentLang]['Fehler beim Aktualisieren des Tages.'];
                    blockStatusMessage.style.display = 'block';
                }
            });

            btnUnblockDate.addEventListener('click', async () => {
                const dateToUnblock = blockDateInput.value;
                if (!dateToUnblock) {
                    blockStatusMessage.textContent = translations[currentLang]['Bitte geben Sie ein Datum ein.'];
                    blockStatusMessage.style.display = 'block';
                    return;
                }
                const index = blockedDates.indexOf(dateToUnblock);
                if (index > -1) {
                    blockedDates.splice(index, 1);
                }
                try {
                    await settingsDoc.set({ blockedDates }, { merge: true });
                    blockStatusMessage.textContent = translations[currentLang]['Tag erfolgreich freigegeben.'];
                    blockStatusMessage.style.display = 'block';
                    fetchData();
                } catch (e) {
                    blockStatusMessage.textContent = translations[currentLang]['Fehler beim Aktualisieren des Tages.'];
                    blockStatusMessage.style.display = 'block';
                }
            });

            btnShowStats.addEventListener('click', () => {
                document.querySelectorAll('#admin-dashboard > div').forEach(div => div.style.display = 'none');
                statisticsSection.style.display = 'block';
                statsUl.innerHTML = '';
                const bookingCount = bookings.length;
                const blockedCount = blockedDates.length;
                statsUl.innerHTML += `<li>${translations[currentLang]['Buchungen']}: ${bookingCount}</li>`;
                statsUl.innerHTML += `<li>${translations[currentLang]['Blockierte Tage']}: ${blockedCount}</li>`;
            });

            btnExportCsv.addEventListener('click', async () => {
                try {
                    await exportBookingsToCsv();
                    alert(translations[currentLang]['Export erfolgreich.']);
                } catch (e) {
                    console.error("Export error:", e);
                    alert(translations[currentLang]['Fehler beim Exportieren.']);
                }
            });

            document.getElementById("prev-month").addEventListener("click", () => {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderCalendar();
            });

            document.getElementById("next-month").addEventListener("click", () => {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar();
            });

            bookingForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const bookingData = validateBookingForm();
                if (!bookingData) {
                    return;
                }
                const date = formDateDisplay.textContent;
                const dateObj = new Date(date);
                const dateStr = dateObj.toISOString().split('T')[0];

                try {
                    const newBooking = {
                        name: bookingData.name,
                        email: bookingData.email,
                        phone: bookingData.phone,
                        notes: bookingData.notes,
                        startDate: dateStr,
                        endDate: dateStr
                    };
                    const docRef = await bookingsCollection.add(newBooking);
                    await bookingsCollection.doc(docRef.id).update({ id: docRef.id });

                    await sendBookingEmail({ ...newBooking, id: docRef.id });

                    bookingForm.reset();
                    formMessage.style.display = 'none';
                    showSection('booking-confirmation');
                    await fetchData();

                } catch (error) {
                    console.error('Buchungsfehler:', error);
                    formMessage.textContent = translations[currentLang]['Ungültige Buchungsdaten.'];
                    formMessage.style.display = 'block';
                }
            });

            async function cancelBookingWithNotification(booking, fromAdmin) {
                try {
                    await bookingsCollection.doc(booking.id).delete();
                    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_CANCEL_TEMPLATE_ID, {
                        name: booking.name,
                        email: booking.email,
                        date: new Date(booking.startDate).toLocaleDateString(currentLang),
                    });
                    return { success: true, message: 'Buchung erfolgreich storniert.' };
                } catch (e) {
                    console.error("Error cancelling booking: ", e);
                    return { success: false, message: 'Fehler beim Stornieren.' };
                }
            }

            async function handleCancellationLink(cancellationId) {
                const booking = bookings.find(b => b.id === cancellationId);
                showSection('cancellation-page');
                if (booking) {
                    statusText.textContent = translations[currentLang]['Soll die Buchung von %s wirklich storniert werden?'].replace('%s', booking.name);
                    buttonsDiv.style.display = 'block';
                } else {
                    statusText.textContent = translations[currentLang]['Buchung nicht gefunden oder bereits storniert.'];
                }

                btnConfirmCancellation.onclick = async () => {
                    if (confirm(translations[currentLang]['Soll die Buchung von %s wirklich storniert werden?'].replace('%s', booking.name))) {
                        await cancelBookingWithNotification({id: bookingId, ...booking}, false);
                        statusText.textContent = translations[currentLang]['Ihre Buchung wurde erfolgreich storniert.'];
                        buttonsDiv.style.display = 'none';
                    }
                };
                document.getElementById('btn-return-home').onclick = () => {
                    window.location.href = window.location.origin + window.location.pathname;
                };
            }

            function initialize() {
                const today = new Date();
                currentYear = today.getFullYear();

                if (currentYear < CAL_START_YEAR) {
                    currentYear = CAL_START_YEAR;
                } else if (currentYear > CAL_END_YEAR) {
                    currentYear = CAL_END_YEAR;
                }

                currentMonth = today.getMonth();
                const urlParams = new URLSearchParams(window.location.search);
                const cancellationId = urlParams.get('cancelId');

                if (cancellationId) {
                    handleCancellationLink(cancellationId);
                } else {
                    showSection("start-section");
                    translatePage(currentLang);
                }
            }

            initialize();
        })();
    </script>
</body>
</html>